<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>RSS Feeds ãƒã‚¦ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .success-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .warning-box {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .feed-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .feed-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .feed-name {
            font-weight: bold;
            color: #2196F3;
        }
        .feed-category {
            color: #666;
            font-size: 0.9em;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¡ RSS Feeds ãƒã‚¦ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«</h1>
        <p>working-rss-feeds.json ã‚’ 05_rss-reader ã«ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™</p>
        
        <div class="info-box">
            <strong>ğŸ“‹ working-rss-feeds.json ã®å†…å®¹:</strong>
            <div id="sourceInfo">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="sourceCount">0</div>
                <div class="stat-label">ã‚½ãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ‰æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentCount">0</div>
                <div class="stat-label">ç¾åœ¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="newCount">0</div>
                <div class="stat-label">æ–°è¦è¿½åŠ äºˆå®š</div>
            </div>
        </div>
        
        <div>
            <button onclick="loadSourceData()">ğŸ“‚ ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
            <button onclick="checkCurrentData()">ğŸ” ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
            <button onclick="mountFeeds()">ğŸš€ ãƒã‚¦ãƒ³ãƒˆå®Ÿè¡Œ</button>
            <button onclick="clearAndMount()" class="danger">ğŸ”„ ã‚¯ãƒªã‚¢ï¼†ãƒã‚¦ãƒ³ãƒˆ</button>
        </div>
        
        <div class="feed-list" id="feedList"></div>
        
        <div id="result"></div>
    </div>

    <script>
        let sourceFeeds = [];
        let currentFeeds = [];
        
        async function loadSourceData() {
            try {
                const response = await fetch('../working-rss-feeds.json');
                const data = await response.json();
                sourceFeeds = data.workingFeeds || [];
                
                document.getElementById('sourceCount').textContent = sourceFeeds.length;
                document.getElementById('sourceInfo').innerHTML = `
                    <p>âœ… ${sourceFeeds.length}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¤œå‡º</p>
                    <p>ã‚«ãƒ†ã‚´ãƒª: ${[...new Set(sourceFeeds.map(f => f.category))].join(', ')}</p>
                `;
                
                displayFeeds(sourceFeeds);
                
                showMessage('success', `âœ… working-rss-feeds.json ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${sourceFeeds.length}ä»¶ï¼‰`);
            } catch (error) {
                showMessage('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        function checkCurrentData() {
            const stored = localStorage.getItem('rss-feeds');
            if (stored) {
                currentFeeds = JSON.parse(stored);
                document.getElementById('currentCount').textContent = currentFeeds.length;
                showMessage('info', `ğŸ“Š ç¾åœ¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰æ•°: ${currentFeeds.length}ä»¶`);
                
                // æ–°è¦è¿½åŠ æ•°ã‚’è¨ˆç®—
                const currentUrls = new Set(currentFeeds.map(f => f.url));
                const newFeeds = sourceFeeds.filter(f => !currentUrls.has(f.url));
                document.getElementById('newCount').textContent = newFeeds.length;
            } else {
                document.getElementById('currentCount').textContent = '0';
                document.getElementById('newCount').textContent = sourceFeeds.length;
                showMessage('warning', 'âš ï¸ ç¾åœ¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }
        
        function mountFeeds() {
            if (sourceFeeds.length === 0) {
                showMessage('error', 'âŒ ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
            const stored = localStorage.getItem('rss-feeds');
            let existingFeeds = stored ? JSON.parse(stored) : [];
            
            // URLã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
            const existingUrls = new Set(existingFeeds.map(f => f.url));
            const newFeeds = sourceFeeds.filter(f => !existingUrls.has(f.url));
            
            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’05_rss-readerã«åˆã‚ã›ã‚‹
            const formattedFeeds = newFeeds.map((feed, index) => ({
                ...feed,
                id: existingFeeds.length + index + 1,
                active: true,
                lastUpdate: new Date().toISOString(),
                articleCount: 0
            }));
            
            // ãƒãƒ¼ã‚¸ã—ã¦ä¿å­˜
            const mergedFeeds = [...existingFeeds, ...formattedFeeds];
            localStorage.setItem('rss-feeds', JSON.stringify(mergedFeeds));
            
            showMessage('success', `
                âœ… ãƒã‚¦ãƒ³ãƒˆå®Œäº†ï¼
                <br>æ—¢å­˜: ${existingFeeds.length}ä»¶
                <br>æ–°è¦è¿½åŠ : ${formattedFeeds.length}ä»¶
                <br>åˆè¨ˆ: ${mergedFeeds.length}ä»¶
            `);
            
            // 05_rss-readerã§ã‚‚ä½¿ç”¨ã™ã‚‹IndexedDBç”¨ã«ã‚‚ä¿å­˜
            saveToIndexedDB(mergedFeeds);
        }
        
        function clearAndMount() {
            if (!confirm('æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã€working-rss-feeds.jsonã§ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            if (sourceFeeds.length === 0) {
                showMessage('error', 'âŒ ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’05_rss-readerã«åˆã‚ã›ã‚‹
            const formattedFeeds = sourceFeeds.map((feed, index) => ({
                ...feed,
                id: index + 1,
                active: true,
                lastUpdate: new Date().toISOString(),
                articleCount: 0
            }));
            
            // ä¿å­˜
            localStorage.setItem('rss-feeds', JSON.stringify(formattedFeeds));
            
            showMessage('success', `
                âœ… ã‚¯ãƒªã‚¢ï¼†ãƒã‚¦ãƒ³ãƒˆå®Œäº†ï¼
                <br>åˆè¨ˆ: ${formattedFeeds.length}ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ç™»éŒ²
            `);
            
            // IndexedDBã«ã‚‚ä¿å­˜
            saveToIndexedDB(formattedFeeds);
        }
        
        async function saveToIndexedDB(feeds) {
            try {
                const request = indexedDB.open('SCF_V5_DB', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('feeds')) {
                        const store = db.createObjectStore('feeds', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('category', 'category', { unique: false });
                    }
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['feeds'], 'readwrite');
                    const store = transaction.objectStore('feeds');
                    
                    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                    store.clear();
                    
                    // æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                    feeds.forEach(feed => {
                        store.add(feed);
                    });
                    
                    transaction.oncomplete = () => {
                        console.log('IndexedDBã«ã‚‚ä¿å­˜å®Œäº†');
                    };
                };
            } catch (error) {
                console.error('IndexedDBä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function displayFeeds(feeds) {
            const container = document.getElementById('feedList');
            container.innerHTML = '<h3>ãƒ•ã‚£ãƒ¼ãƒ‰ä¸€è¦§</h3>';
            
            feeds.forEach(feed => {
                container.innerHTML += `
                    <div class="feed-item">
                        <span class="feed-name">${feed.name}</span>
                        <span class="feed-category">[${feed.category}]</span>
                        <br>
                        <small>${feed.url}</small>
                    </div>
                `;
            });
        }
        
        function showMessage(type, message) {
            const result = document.getElementById('result');
            const className = type === 'success' ? 'success-box' : 
                            type === 'error' ? 'warning-box' : 'info-box';
            
            result.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        // åˆæœŸåŒ–
        window.onload = () => {
            loadSourceData();
            checkCurrentData();
        };
    </script>
</body>
</html>