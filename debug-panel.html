<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デバッグパネル - データ保存場所一覧 | SCF V5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            min-height: 100vh;
        }

        .debug-header {
            background: #2a2a2a;
            padding: 15px 20px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-title {
            font-size: 1.5em;
            text-shadow: 0 0 10px #00ff00;
        }

        .timestamp {
            color: #ffff00;
            font-size: 0.9em;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .debug-card {
            background: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .debug-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .module-name {
            color: #00ffff;
            font-size: 1.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .storage-info {
            margin: 10px 0;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 3px;
            border-left: 3px solid #ffff00;
        }

        .storage-type {
            color: #ff00ff;
            font-weight: bold;
        }

        .storage-key {
            color: #00ffff;
            margin-top: 5px;
            word-break: break-all;
        }

        .data-preview {
            color: #999;
            font-size: 0.85em;
            margin-top: 5px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .file-path {
            color: #ffa500;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .api-endpoint {
            color: #ff69b4;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .refresh-btn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #00ff00; }
            50% { box-shadow: 0 0 20px #00ff00; }
        }

        .system-stats {
            background: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: #999;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #00ff00;
            font-size: 1.5em;
            font-weight: bold;
        }

        .warning {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
            padding: 5px;
            border-radius: 3px;
            margin-top: 10px;
        }

        .success {
            color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
            padding: 5px;
            border-radius: 3px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="debug-header">
        <h1 class="debug-title">🔍 SCF V5 Debug Panel - データ保存場所マップ</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="settings/index.html" style="color: #00ff00; text-decoration: none; padding: 8px 15px; border: 1px solid #00ff00; border-radius: 3px; background: rgba(0, 255, 0, 0.1); transition: all 0.3s;" onmouseover="this.style.background='rgba(0, 255, 0, 0.3)'" onmouseout="this.style.background='rgba(0, 255, 0, 0.1)'">⚙️ 設定ページ</a>
            <a href="index.html" style="color: #00ff00; text-decoration: none; padding: 8px 15px; border: 1px solid #00ff00; border-radius: 3px; background: rgba(0, 255, 0, 0.1); transition: all 0.3s;" onmouseover="this.style.background='rgba(0, 255, 0, 0.3)'" onmouseout="this.style.background='rgba(0, 255, 0, 0.1)'">🏠 ダッシュボード</a>
            <div class="timestamp" id="timestamp"></div>
        </div>
    </div>

    <div class="system-stats">
        <div class="stat-item">
            <div class="stat-label">LocalStorage使用量</div>
            <div class="stat-value" id="localStorageSize">0 KB</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">IndexedDB数</div>
            <div class="stat-value" id="indexedDBCount">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">保存キー総数</div>
            <div class="stat-value" id="totalKeys">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">API設定数</div>
            <div class="stat-value" id="apiCount">0</div>
        </div>
    </div>

    <div class="debug-grid">
        <!-- RSS一覧管理 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                RSS一覧管理 (rss-reader)
            </h3>
            <div class="storage-info">
                <div class="storage-type">📁 IndexedDB</div>
                <div class="storage-key">Database: SCFV5_RSS (version: 2)</div>
                <div class="storage-key">Store: feeds</div>
                <div class="data-preview" id="rssFeeds">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage (Fallback)</div>
                <div class="storage-key">Key: rss-feeds</div>
                <div class="data-preview" id="rssFeedsLocal">Loading...</div>
            </div>
            <div class="file-path">
                📂 <a href="rss-reader/index.html" style="color: #00ffff; text-decoration: none;">/rss-reader/index.html</a>
                <a href="rss-reader/index.html" style="color: #00ff00; text-decoration: none; padding: 3px 8px; border: 1px solid #00ff00; border-radius: 3px; margin-left: 10px; font-size: 0.85em;">開く →</a>
            </div>
        </div>

        <!-- RSS記事表示 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                RSS記事表示 (rss-sources)
            </h3>
            <div class="storage-info">
                <div class="storage-type">📁 IndexedDB</div>
                <div class="storage-key">Database: SCFV5_RSS (version: 2)</div>
                <div class="storage-key">Store: articles</div>
                <div class="data-preview" id="rssArticles">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">🌐 API</div>
                <div class="storage-key">Cloudflare Worker</div>
                <div class="api-endpoint" id="workerUrl">Loading...</div>
            </div>
            <div class="file-path">
                📂 <a href="rss-sources/index.html" style="color: #00ffff; text-decoration: none;">/rss-sources/index.html</a>
                <a href="rss-sources/index.html" style="color: #00ff00; text-decoration: none; padding: 3px 8px; border: 1px solid #00ff00; border-radius: 3px; margin-left: 10px; font-size: 0.85em;">開く →</a>
            </div>
        </div>

        <!-- 設定管理 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                設定管理 (settings)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: openai-api-key</div>
                <div class="data-preview" id="openaiKey">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: anthropic-api-key</div>
                <div class="data-preview" id="anthropicKey">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: cloudflare-worker-url</div>
                <div class="data-preview" id="cfWorker">Loading...</div>
            </div>
            <div class="file-path">
                📂 <a href="settings/index.html" style="color: #00ffff; text-decoration: none;">/settings/index.html</a>
                <a href="settings/index.html#api" style="color: #ffff00; text-decoration: none; padding: 5px 12px; border: 2px solid #ffff00; border-radius: 3px; margin-left: 10px; font-size: 0.9em; font-weight: bold; background: rgba(255, 255, 0, 0.1); box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);">⚙️ APIキー設定へ →</a>
            </div>
        </div>

        <!-- 記事作成 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                記事作成 (article)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: saved-articles</div>
                <div class="data-preview" id="savedArticles">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: article-templates</div>
                <div class="data-preview" id="articleTemplates">Loading...</div>
            </div>
            <div class="file-path">📂 /article/index.html</div>
        </div>

        <!-- WXR出力 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                WXR出力 (wxr)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: wxr-export-history</div>
                <div class="data-preview" id="wxrHistory">Loading...</div>
            </div>
            <div class="file-path">📂 /wxr/index.html</div>
        </div>

        <!-- 画像生成 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                画像生成 (image-gen)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: generated-images</div>
                <div class="data-preview" id="generatedImages">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">🌐 API</div>
                <div class="storage-key">DALL-E 3 / Stable Diffusion</div>
                <div class="api-endpoint">Uses: openai-api-key</div>
            </div>
            <div class="file-path">📂 /image-gen/index.html</div>
        </div>

        <!-- サムネイル生成 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                サムネイル生成 (thumbnail)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: thumbnail-templates</div>
                <div class="data-preview" id="thumbnailTemplates">Loading...</div>
            </div>
            <div class="file-path">📂 /thumbnail/index.html</div>
        </div>

        <!-- 投稿管理 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                投稿管理 (posts)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: published-posts</div>
                <div class="data-preview" id="publishedPosts">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: post-analytics</div>
                <div class="data-preview" id="postAnalytics">Loading...</div>
            </div>
            <div class="file-path">📂 /posts/index.html</div>
        </div>

        <!-- プロンプト生成 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                プロンプト生成 (prompt)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: prompt-templates</div>
                <div class="data-preview" id="promptTemplates">Loading...</div>
            </div>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: prompt-history</div>
                <div class="data-preview" id="promptHistory">Loading...</div>
            </div>
            <div class="file-path">📂 /prompt/index.html</div>
        </div>

        <!-- 図表生成 -->
        <div class="debug-card">
            <h3 class="module-name">
                <span class="status-indicator"></span>
                図表生成 (chart)
            </h3>
            <div class="storage-info">
                <div class="storage-type">💾 LocalStorage</div>
                <div class="storage-key">Key: chart-data</div>
                <div class="data-preview" id="chartData">Loading...</div>
            </div>
            <div class="file-path">📂 /chart/index.html</div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshData()">🔄 データ更新</button>

    <script>
        // データ取得と表示
        async function loadDebugData() {
            // タイムスタンプ更新
            document.getElementById('timestamp').textContent = new Date().toLocaleString('ja-JP');

            // LocalStorage統計
            let localStorageSize = 0;
            let totalKeys = 0;
            let apiCount = 0;

            // LocalStorageデータ取得
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                localStorageSize += (key.length + value.length) * 2; // 概算バイト数
                totalKeys++;

                // 各モジュールのデータ表示
                switch(key) {
                    case 'rss-feeds':
                        displayData('rssFeedsLocal', value);
                        break;
                    case 'openai-api-key':
                        displayData('openaiKey', value ? '設定済み (****)' : '未設定');
                        apiCount++;
                        break;
                    case 'anthropic-api-key':
                        displayData('anthropicKey', value ? '設定済み (****)' : '未設定');
                        apiCount++;
                        break;
                    case 'cloudflare-worker-url':
                        displayData('cfWorker', value || '未設定');
                        displayData('workerUrl', value || '未設定');
                        apiCount++;
                        break;
                    case 'saved-articles':
                        displayData('savedArticles', value);
                        break;
                    case 'article-templates':
                        displayData('articleTemplates', value);
                        break;
                    case 'wxr-export-history':
                        displayData('wxrHistory', value);
                        break;
                    case 'generated-images':
                        displayData('generatedImages', value);
                        break;
                    case 'thumbnail-templates':
                        displayData('thumbnailTemplates', value);
                        break;
                    case 'published-posts':
                        displayData('publishedPosts', value);
                        break;
                    case 'post-analytics':
                        displayData('postAnalytics', value);
                        break;
                    case 'prompt-templates':
                        displayData('promptTemplates', value);
                        break;
                    case 'prompt-history':
                        displayData('promptHistory', value);
                        break;
                    case 'chart-data':
                        displayData('chartData', value);
                        break;
                }
            }

            // IndexedDB情報取得
            try {
                const dbs = await indexedDB.databases();
                document.getElementById('indexedDBCount').textContent = dbs.length;

                // SCFV5_RSS データベース情報
                const request = indexedDB.open('SCFV5_RSS', 2);
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    // feeds数取得
                    if (db.objectStoreNames.contains('feeds')) {
                        const transaction = db.transaction(['feeds'], 'readonly');
                        const store = transaction.objectStore('feeds');
                        const countRequest = store.count();
                        countRequest.onsuccess = () => {
                            displayData('rssFeeds', `${countRequest.result} フィード登録済み`);
                        };
                    }

                    // articles数取得
                    if (db.objectStoreNames.contains('articles')) {
                        const transaction = db.transaction(['articles'], 'readonly');
                        const store = transaction.objectStore('articles');
                        const countRequest = store.count();
                        countRequest.onsuccess = () => {
                            displayData('rssArticles', `${countRequest.result} 記事キャッシュ済み`);
                        };
                    }
                };
            } catch (e) {
                console.log('IndexedDB情報取得エラー:', e);
            }

            // 統計更新
            document.getElementById('localStorageSize').textContent = (localStorageSize / 1024).toFixed(1) + ' KB';
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('apiCount').textContent = apiCount;
        }

        // データ表示ヘルパー
        function displayData(elementId, data) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (!data || data === 'undefined') {
                element.innerHTML = '<span style="color: #ff0000;">未設定</span>';
                return;
            }

            try {
                // JSONの場合はパースして整形
                const parsed = JSON.parse(data);
                const preview = JSON.stringify(parsed, null, 2).substring(0, 200);
                element.textContent = preview + (data.length > 200 ? '...' : '');
            } catch {
                // JSONでない場合はそのまま表示
                const preview = data.substring(0, 100);
                element.textContent = preview + (data.length > 100 ? '...' : '');
            }
        }

        // データ更新
        function refreshData() {
            loadDebugData();
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = '✅ 更新完了';
            setTimeout(() => {
                btn.textContent = '🔄 データ更新';
            }, 1000);
        }

        // 初期ロード
        window.addEventListener('load', loadDebugData);

        // 自動更新（5秒ごと）
        setInterval(loadDebugData, 5000);
    </script>
</body>
</html>