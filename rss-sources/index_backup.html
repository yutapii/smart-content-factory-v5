<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ä¿¡RSS - è¨˜äº‹è¡¨ç¤º | SCF V5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .feed-selector {
            flex: 1;
            min-width: 200px;
        }

        .feed-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            font-size: 14px;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-filter input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .stats-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stats-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .stat-value {
            font-weight: bold;
            color: #667eea;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn:first-child {
            border-radius: 5px 0 0 5px;
        }

        .view-btn:last-child {
            border-radius: 0 5px 5px 0;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .articles-container {
            display: grid;
            gap: 20px;
        }

        .articles-container.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        }

        .article-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .article-source {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .article-date {
            color: #999;
            font-size: 0.85em;
        }

        .article-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .article-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .article-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .article-link:hover {
            text-decoration: underline;
        }

        .article-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #f8f9fa;
        }

        .action-btn.saved {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-meta {
            color: #666;
            font-size: 0.9em;
        }

        .modal-body {
            line-height: 1.8;
            color: #333;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }
            
            .articles-container.grid-view {
                grid-template-columns: 1fr;
            }
            
            .stats-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“¡ é…ä¿¡RSS - è¨˜äº‹è¡¨ç¤º</h1>
            <a href="../index.html" class="back-btn">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</a>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="control-row">
                <div class="feed-selector">
                    <select id="feedSelector">
                        <option value="all">ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰</option>
                    </select>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="è¨˜äº‹ã‚’æ¤œç´¢...">
                </div>
                <button class="btn btn-primary" onclick="fetchArticles()">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-secondary" onclick="clearCache()">ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="control-row">
                <div class="date-filter">
                    <label>æœŸé–“:</label>
                    <input type="date" id="dateFrom">
                    <span>ã€œ</span>
                    <input type="date" id="dateTo">
                </div>
                <button class="btn btn-success" onclick="exportArticles()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stats-info">
                <div class="stat-item">
                    <span class="stat-label">è¨˜äº‹æ•°:</span>
                    <span class="stat-value" id="articleCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ãƒ•ã‚£ãƒ¼ãƒ‰æ•°:</span>
                    <span class="stat-value" id="feedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœ€çµ‚æ›´æ–°:</span>
                    <span class="stat-value" id="lastUpdate">--:--</span>
                </div>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="setView('list')">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>
                <button class="view-btn" onclick="setView('grid')">ğŸ“° ã‚°ãƒªãƒƒãƒ‰</button>
            </div>
        </div>

        <div class="articles-container" id="articlesContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>è¨˜äº‹ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- è¨˜äº‹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="articleModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <div class="modal-meta" id="modalMeta"></div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                <button class="btn btn-primary" onclick="saveArticle()" style="margin-left: 10px;">è¨˜äº‹ã¨ã—ã¦ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // IndexedDBè¨­å®š
        let db;
        const DB_NAME = 'SCFV5_RSS';
        const DB_VERSION = 2;

        // IndexedDBåˆæœŸåŒ–
        async function initDB() {
            return new Promise((resolve, reject) => {
                // æ—¢å­˜ã®DBã‚’é–‰ã˜ã‚‹
                try {
                    if (db) {
                        db.close();
                        db = null;
                    }
                } catch (e) {
                    console.log('DB close error:', e);
                }
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('DB open error:', request.error);
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œ
                    resolve(null);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('DB initialized successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // feeds store
                    if (!db.objectStoreNames.contains('feeds')) {
                        const feedStore = db.createObjectStore('feeds', { keyPath: 'id', autoIncrement: true });
                        feedStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    // articles store
                    if (!db.objectStoreNames.contains('articles')) {
                        const articleStore = db.createObjectStore('articles', { keyPath: 'id', autoIncrement: true });
                        articleStore.createIndex('feedId', 'feedId', { unique: false });
                        articleStore.createIndex('pubDate', 'pubDate', { unique: false });
                        articleStore.createIndex('saved', 'saved', { unique: false });
                    }
                };
                
                request.onblocked = () => {
                    console.warn('DB blocked - ä»–ã®ã‚¿ãƒ–ã§ä½¿ç”¨ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                    resolve(null);
                };
            });
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—
        async function getFeeds() {
            if (!db) {
                console.log('DB not available, using localStorage');
                // LocalStorageã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å–å¾—
                try {
                    const stored = localStorage.getItem('rss-feeds');
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Failed to load feeds from localStorage:', e);
                }
                return [];
            }
            
            try {
                const transaction = db.transaction(['feeds'], 'readonly');
                const store = transaction.objectStore('feeds');
                
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => {
                        console.error('Failed to get feeds from DB:', request.error);
                        resolve([]);
                    };
                });
            } catch (e) {
                console.error('Transaction error:', e);
                return [];
            }
        }

        // è¨˜äº‹ä¿å­˜
        async function saveArticleToDb(article) {
            const transaction = db.transaction(['articles'], 'readwrite');
            const store = transaction.objectStore('articles');
            
            // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
            const existing = await getArticleByUrl(article.link);
            if (existing) {
                article.id = existing.id;
                return store.put(article);
            }
            
            return store.add(article);
        }

        // URL ã§è¨˜äº‹å–å¾—
        async function getArticleByUrl(url) {
            const transaction = db.transaction(['articles'], 'readonly');
            const store = transaction.objectStore('articles');
            const articles = await store.getAll();
            
            return new Promise((resolve) => {
                articles.onsuccess = () => {
                    const found = articles.result.find(a => a.link === url);
                    resolve(found);
                };
            });
        }

        // è¨˜äº‹å–å¾—
        async function getArticles() {
            const transaction = db.transaction(['articles'], 'readonly');
            const store = transaction.objectStore('articles');
            
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => {
                    const articles = request.result;
                    // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                    articles.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                    resolve(articles);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // RSSå–å¾—ï¼ˆè¤‡æ•°ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’è©¦è¡Œï¼‰
        async function fetchRSS(url) {
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ãƒ­ã‚°å‡ºåŠ›
            const debugMode = localStorage.getItem('debug-mode') === 'true';
            if (debugMode) {
                console.log('RSSå–å¾—é–‹å§‹:', url);
            }
            
            // æ–¹æ³•1: Cloudflare Workerï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰
            const workerUrl = 'https://polished-snow-477a.yutapii.workers.dev';
            try {
                const proxyUrl = `${workerUrl}?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/rss+xml, application/xml, text/xml, */*'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                }).catch(err => {
                    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’é™ã‹ã«å‡¦ç†ï¼ˆãƒ­ã‚°ãªã—ï¼‰
                    return { ok: false, status: 0 };
                });
                
                if (response.ok) {
                    const text = await response.text();
                    
                    if (text.length > 0) {
                        const articles = parseRSS(text);
                        if (articles.length > 0) {
                            if (debugMode) {
                                console.log(`WorkerçµŒç”±ã§${articles.length}ä»¶ã®è¨˜äº‹ã‚’å–å¾—`);
                            }
                            return articles;
                        }
                    }
                }
                // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºã•ãªã„
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã‚’é™ã‹ã«å‡¦ç†
            }
            
            // æ–¹æ³•2: AllOrigins ãƒ—ãƒ­ã‚­ã‚·ï¼ˆã‚¹ã‚­ãƒƒãƒ— - ã‚¨ãƒ©ãƒ¼ãŒå¤šã„ãŸã‚ï¼‰
            // AllOriginsã¯ç¾åœ¨ä¸å®‰å®šãªãŸã‚ã‚¹ã‚­ãƒƒãƒ—
            
            // æ–¹æ³•3: RSS2JSON ã‚µãƒ¼ãƒ“ã‚¹
            try {
                const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
                const response = await fetch(apiUrl, {
                    mode: 'cors',
                    credentials: 'omit'
                }).catch(err => {
                    // ã‚¨ãƒ©ãƒ¼ã‚’é™ã‹ã«å‡¦ç†
                    return { ok: false };
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok' && data.items && data.items.length > 0) {
                        if (debugMode) {
                            console.log(`RSS2JSONçµŒç”±ã§${data.items.length}ä»¶ã®è¨˜äº‹ã‚’å–å¾—`);
                        }
                        return data.items.map(item => ({
                            title: item.title || '',
                            link: item.link || '',
                            description: item.description || '',
                            pubDate: item.pubDate || new Date().toISOString(),
                            guid: item.guid || item.link || ''
                        }));
                    }
                }
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã‚’é™ã‹ã«å‡¦ç†
            }
            
            // æ–¹æ³•4: CORS Anywhereï¼ˆã‚¹ã‚­ãƒƒãƒ— - åˆ¶é™ãŒå³ã—ã„ãŸã‚ï¼‰
            // CORS Anywhereã¯ä½¿ç”¨åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
            
            // å…¨å–å¾—æ–¹æ³•å¤±æ•—æ™‚ã‚‚ãƒ­ã‚°ã‚’å‡ºã•ãªã„
            // ç©ºé…åˆ—ã‚’è¿”ã™ä»£ã‚ã‚Šã«ã€ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å«ã‚€é…åˆ—ã‚’è¿”ã™
            return [{
                title: `âš ï¸ ãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼: ${url}`,
                link: url,
                description: 'ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                pubDate: new Date().toISOString(),
                guid: `error-${url}-${Date.now()}`,
                isError: true
            }];
        }

        // RSS ãƒ‘ãƒ¼ã‚¹
        function parseRSS(xmlText) {
            if (!xmlText) return [];
            
            // HTMLãŒæ··å…¥ã—ã¦ã„ã‚‹å ´åˆã¯é™¤å¤–
            if (xmlText.trim().startsWith('<!DOCTYPE') || xmlText.trim().startsWith('<html')) {
                console.error('HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆRSSã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
                return [];
            }
            
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, 'text/xml');
            
            // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            const parseError = xml.querySelector('parsererror');
            if (parseError) {
                console.error('XMLãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError.textContent.substring(0, 200));
                return [];
            }
            
            // RSS 2.0å½¢å¼ã®itemè¦ç´ ã‚’å–å¾—
            let items = xml.querySelectorAll('item');
            
            // Atomå½¢å¼ã®å ´åˆã¯entryè¦ç´ ã‚’å–å¾—
            if (items.length === 0) {
                items = xml.querySelectorAll('entry');
            }
            
            const articles = [];
            
            items.forEach(item => {
                // RSS 2.0å½¢å¼
                let title = item.querySelector('title')?.textContent || '';
                let link = item.querySelector('link')?.textContent || '';
                let description = item.querySelector('description')?.textContent || '';
                let pubDate = item.querySelector('pubDate')?.textContent || '';
                
                // Atomå½¢å¼ã®å ´åˆ
                if (!link && item.querySelector('link')) {
                    link = item.querySelector('link').getAttribute('href') || '';
                }
                if (!description) {
                    description = item.querySelector('summary')?.textContent || 
                                 item.querySelector('content')?.textContent || '';
                }
                if (!pubDate) {
                    pubDate = item.querySelector('published')?.textContent || 
                             item.querySelector('updated')?.textContent || 
                             new Date().toISOString();
                }
                
                articles.push({
                    title: title,
                    link: link,
                    description: description,
                    pubDate: pubDate,
                    guid: item.querySelector('guid')?.textContent || link
                });
            });
            
            return articles;
        }

        // è¨˜äº‹å–å¾—
        async function fetchArticles() {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>è¨˜äº‹ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';
            
            const feeds = await getFeeds();
            const activeFeeds = feeds.filter(f => f.active);
            
            if (activeFeeds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“°</div>
                        <div class="empty-state-text">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>
                        <div class="empty-state-text">RSSä¸€è¦§ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</div>
                    </div>
                `;
                return;
            }
            
            const selectedFeed = document.getElementById('feedSelector').value;
            const feedsToFetch = selectedFeed === 'all' ? activeFeeds : activeFeeds.filter(f => f.id == selectedFeed);
            
            let allArticles = [];
            
            // ä¸¦åˆ—ã§RSSå–å¾—ï¼ˆæœ€å¤§10åŒæ™‚ï¼‰
            const batchSize = 10;
            for (let i = 0; i < feedsToFetch.length; i += batchSize) {
                const batch = feedsToFetch.slice(i, i + batchSize);
                const promises = batch.map(async feed => {
                    const articles = await fetchRSS(feed.url);
                    return articles.map(article => ({
                        ...article,
                        feedId: feed.id,
                        feedName: feed.name,
                        feedCategory: feed.category
                    }));
                });
                
                const results = await Promise.all(promises);
                results.forEach(articles => {
                    allArticles = allArticles.concat(articles);
                });
            }
            
            // DBä¿å­˜ï¼ˆ60æ—¥ä»¥å†…ï¼‰
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 60);
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€ãƒãƒƒãƒã§ä¿å­˜
            const articlesToSave = allArticles.filter(article => {
                const pubDate = new Date(article.pubDate);
                return pubDate > cutoffDate && !article.isError;
            });
            
            if (articlesToSave.length > 0 && db) {
                try {
                    const transaction = db.transaction(['articles'], 'readwrite');
                    const store = transaction.objectStore('articles');
                    
                    for (const article of articlesToSave) {
                        try {
                            // æ—¢å­˜ãƒã‚§ãƒƒã‚¯ã¯çœç•¥ã—ã¦putã‚’ä½¿ç”¨
                            store.put({
                                ...article,
                                id: article.guid || article.link,
                                savedAt: new Date().toISOString()
                            });
                        } catch (e) {
                            console.error('è¨˜äº‹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                        }
                    }
                    
                    transaction.oncomplete = () => {
                        console.log(`${articlesToSave.length}ä»¶ã®è¨˜äº‹ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                    };
                } catch (e) {
                    console.error('ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
                }
            }
            
            displayArticles();
        }

        // è¨˜äº‹è¡¨ç¤º
        async function displayArticles() {
            const articles = await getArticles();
            const container = document.getElementById('articlesContainer');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredArticles = articles;
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ ãƒ•ã‚£ãƒ«ã‚¿
            const selectedFeed = document.getElementById('feedSelector').value;
            if (selectedFeed !== 'all') {
                filteredArticles = filteredArticles.filter(a => a.feedId == selectedFeed);
            }
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredArticles = filteredArticles.filter(a => 
                    a.title.toLowerCase().includes(searchTerm) ||
                    a.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            if (dateFrom) {
                filteredArticles = filteredArticles.filter(a => 
                    new Date(a.pubDate) >= new Date(dateFrom)
                );
            }
            if (dateTo) {
                const endDate = new Date(dateTo);
                endDate.setHours(23, 59, 59);
                filteredArticles = filteredArticles.filter(a => 
                    new Date(a.pubDate) <= endDate
                );
            }
            
            // çµ±è¨ˆæ›´æ–°
            document.getElementById('articleCount').textContent = filteredArticles.length;
            document.getElementById('feedCount').textContent = new Set(filteredArticles.map(a => a.feedId)).size;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            if (filteredArticles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“°</div>
                        <div class="empty-state-text">è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
                return;
            }
            
            // è¨˜äº‹ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
            container.innerHTML = filteredArticles.map(article => {
                const pubDate = new Date(article.pubDate);
                const dateStr = pubDate.toLocaleDateString('ja-JP');
                const timeStr = pubDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="article-card" onclick="showArticle('${encodeURIComponent(JSON.stringify(article))}')">
                        <div class="article-header">
                            <span class="article-source">${article.feedName || 'Unknown'}</span>
                            <span class="article-date">${dateStr} ${timeStr}</span>
                        </div>
                        <h3 class="article-title">${article.title}</h3>
                        <p class="article-description">${stripHtml(article.description)}</p>
                        <div class="article-footer">
                            <a href="${article.link}" class="article-link" target="_blank" onclick="event.stopPropagation()">
                                è¨˜äº‹ã‚’èª­ã‚€ â†’
                            </a>
                            <div class="article-actions">
                                <button class="action-btn ${article.saved ? 'saved' : ''}" onclick="event.stopPropagation(); toggleSave('${article.id}')">
                                    ${article.saved ? 'â˜… ä¿å­˜æ¸ˆã¿' : 'â˜† ä¿å­˜'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // HTML ã‚¿ã‚°é™¤å»
        function stripHtml(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || '';
        }

        // è¨˜äº‹è©³ç´°è¡¨ç¤º
        function showArticle(encodedArticle) {
            const article = JSON.parse(decodeURIComponent(encodedArticle));
            document.getElementById('modalTitle').textContent = article.title;
            document.getElementById('modalMeta').textContent = `${article.feedName} | ${new Date(article.pubDate).toLocaleString('ja-JP')}`;
            document.getElementById('modalBody').innerHTML = article.description;
            document.getElementById('articleModal').classList.add('active');
            
            // ç¾åœ¨ã®è¨˜äº‹ã‚’ä¿å­˜
            window.currentArticle = article;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('articleModal').classList.remove('active');
        }

        // è¨˜äº‹ä¿å­˜åˆ‡ã‚Šæ›¿ãˆ
        async function toggleSave(articleId) {
            const transaction = db.transaction(['articles'], 'readwrite');
            const store = transaction.objectStore('articles');
            const article = await store.get(parseInt(articleId));
            
            article.onsuccess = async () => {
                const art = article.result;
                art.saved = !art.saved;
                await store.put(art);
                displayArticles();
            };
        }

        // è¨˜äº‹ã‚’åŸ·ç­†ç”¨ã«ä¿å­˜
        function saveArticle() {
            if (window.currentArticle) {
                let savedArticles = JSON.parse(localStorage.getItem('saved-articles') || '[]');
                savedArticles.push({
                    ...window.currentArticle,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem('saved-articles', JSON.stringify(savedArticles));
                alert('è¨˜äº‹ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                closeModal();
            }
        }

        // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function setView(view) {
            const container = document.getElementById('articlesContainer');
            const buttons = document.querySelectorAll('.view-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'grid') {
                container.classList.add('grid-view');
            } else {
                container.classList.remove('grid-view');
            }
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        async function clearCache() {
            if (confirm('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿä¿å­˜ã—ãŸè¨˜äº‹ã¯æ®‹ã‚Šã¾ã™ã€‚')) {
                const transaction = db.transaction(['articles'], 'readwrite');
                const store = transaction.objectStore('articles');
                const articles = await store.getAll();
                
                articles.onsuccess = async () => {
                    for (const article of articles.result) {
                        if (!article.saved) {
                            await store.delete(article.id);
                        }
                    }
                    alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    fetchArticles();
                };
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportArticles() {
            const articles = await getArticles();
            const filteredArticles = articles.filter(a => a.saved);
            
            if (filteredArticles.length === 0) {
                alert('ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                articles: filteredArticles
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `articles-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
        async function updateFeedSelector() {
            const feeds = await getFeeds();
            const selector = document.getElementById('feedSelector');
            
            selector.innerHTML = '<option value="all">ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰</option>' +
                feeds.filter(f => f.active).map(feed => 
                    `<option value="${feed.id}">${feed.name}</option>`
                ).join('');
        }

        // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('searchInput').addEventListener('input', displayArticles);
        document.getElementById('dateFrom').addEventListener('change', displayArticles);
        document.getElementById('dateTo').addEventListener('change', displayArticles);
        document.getElementById('feedSelector').addEventListener('change', displayArticles);

        // åˆæœŸåŒ–
        (async () => {
            await initDB();
            await updateFeedSelector();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateTo').value = today;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
            
            await fetchArticles();
        })();
    </script>
</body>
</html>