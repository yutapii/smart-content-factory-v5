<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS2JSON ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        .container {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            color: #fff;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 10px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            background: #3d3d3d;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .status-ok {
            color: #4caf50;
            font-weight: bold;
        }
        .status-error {
            color: #f44336;
            font-weight: bold;
        }
        .status-warning {
            color: #ff9800;
            font-weight: bold;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #ff5252;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            color: #aed581;
            border: 1px solid #444;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            font-family: monospace;
            font-size: 12px;
            border-left: 3px solid #555;
            padding-left: 10px;
        }
        .log-success {
            border-left-color: #4caf50;
            color: #81c784;
        }
        .log-error {
            border-left-color: #f44336;
            color: #ef5350;
        }
        .log-info {
            border-left-color: #2196f3;
            color: #64b5f6;
        }
        .api-key-display {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” RSS2JSON ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="debug-section">
            <h2>1ï¸âƒ£ API Key è©³ç´°ãƒã‚§ãƒƒã‚¯</h2>
            <button onclick="checkApiKeyDetails()">è©³ç´°ç¢ºèª</button>
            <div id="apiKeyDetails"></div>
        </div>

        <div class="debug-section">
            <h2>2ï¸âƒ£ ç›´æ¥APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="directApiTest()">GIGAZINEã§ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testMultipleFeeds()">è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
            <div id="apiTestResult"></div>
        </div>

        <div class="debug-section">
            <h2>3ï¸âƒ£ 05_rss-reader å®Ÿè£…ç¢ºèª</h2>
            <button onclick="check05Implementation()">å®Ÿè£…çŠ¶æ…‹ç¢ºèª</button>
            <div id="implementationCheck"></div>
        </div>

        <div class="debug-section">
            <h2>4ï¸âƒ£ ãƒ•ã‚£ãƒ¼ãƒ‰åˆ¥çŠ¶æ…‹</h2>
            <button onclick="analyzeFeedStatus()">ãƒ•ã‚£ãƒ¼ãƒ‰åˆ†æ</button>
            <div id="feedAnalysis"></div>
        </div>

        <div class="debug-section">
            <h2>5ï¸âƒ£ å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</h2>
            <button onclick="fullReset()" style="background: #f44336;">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
            <button onclick="reloadApiKey()">API Keyå†èª­ã¿è¾¼ã¿</button>
            <div id="resetResult"></div>
        </div>

        <div class="debug-section">
            <h2>ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°</h2>
            <div id="debugLog"></div>
        </div>
    </div>

    <script src="40_settings/api-config.js"></script>
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function checkApiKeyDetails() {
            const detailsDiv = document.getElementById('apiKeyDetails');
            const localStorageKey = localStorage.getItem('rss2json-api-key');
            const configKey = typeof API_CONFIG !== 'undefined' ? API_CONFIG.RSS2JSON_API_KEY : 'undefined';
            
            let html = '<h3>API Key çŠ¶æ…‹</h3>';
            
            // LocalStorage
            if (localStorageKey) {
                html += `<p class="status-ok">âœ… LocalStorage: è¨­å®šæ¸ˆã¿</p>`;
                html += `<div class="api-key-display">Key: ${localStorageKey}</div>`;
                html += `<p>é•·ã•: ${localStorageKey.length}æ–‡å­—</p>`;
            } else {
                html += `<p class="status-error">âŒ LocalStorage: æœªè¨­å®š</p>`;
            }
            
            // api-config.js
            if (configKey && configKey !== 'undefined' && configKey !== '') {
                html += `<p class="status-ok">âœ… api-config.js: è¨­å®šæ¸ˆã¿</p>`;
                html += `<div class="api-key-display">Key: ${configKey}</div>`;
                html += `<p>é•·ã•: ${configKey.length}æ–‡å­—</p>`;
            } else {
                html += `<p class="status-error">âŒ api-config.js: æœªè¨­å®šã¾ãŸã¯ç©º</p>`;
            }
            
            // ä¸€è‡´ç¢ºèª
            if (localStorageKey && configKey && localStorageKey === configKey) {
                html += `<p class="status-ok">âœ… ä¸¡æ–¹ä¸€è‡´</p>`;
            } else if (localStorageKey !== configKey) {
                html += `<p class="status-warning">âš ï¸ LocalStorageã¨api-config.jsãŒä¸ä¸€è‡´</p>`;
            }
            
            detailsDiv.innerHTML = html;
            log('API Keyè©³ç´°ç¢ºèªå®Œäº†', 'info');
        }

        async function directApiTest() {
            const resultDiv = document.getElementById('apiTestResult');
            const apiKey = localStorage.getItem('rss2json-api-key');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<p class="status-error">âŒ API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                log('API Keyæœªè¨­å®š', 'error');
                return;
            }
            
            resultDiv.innerHTML = '<p>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';
            log(`API Keyã§ãƒ†ã‚¹ãƒˆé–‹å§‹: ${apiKey.substring(0, 10)}...`, 'info');
            
            try {
                // ãƒ†ã‚¹ãƒˆ1: API Keyã‚ã‚Š
                const url1 = `https://api.rss2json.com/v1/api.json?rss_url=https://gigazine.net/news/rss_2.0/&api_key=${apiKey}&count=2`;
                log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${url1}`, 'info');
                
                const response1 = await fetch(url1);
                const data1 = await response1.json();
                
                let html = '<h3>API Keyä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆçµæœ</h3>';
                if (data1.status === 'ok') {
                    html += `<p class="status-ok">âœ… æˆåŠŸ: ${data1.items.length}ä»¶å–å¾—</p>`;
                    html += `<pre>${JSON.stringify(data1.feed, null, 2)}</pre>`;
                    log(`æˆåŠŸ: ${data1.items.length}ä»¶å–å¾—`, 'success');
                } else {
                    html += `<p class="status-error">âŒ ã‚¨ãƒ©ãƒ¼: ${data1.message}</p>`;
                    log(`ã‚¨ãƒ©ãƒ¼: ${data1.message}`, 'error');
                }
                
                // ãƒ†ã‚¹ãƒˆ2: API Keyãªã—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
                const url2 = `https://api.rss2json.com/v1/api.json?rss_url=https://gigazine.net/news/rss_2.0/&count=2`;
                const response2 = await fetch(url2);
                const data2 = await response2.json();
                
                html += '<h3>API Keyãªã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµæœï¼ˆæ¯”è¼ƒï¼‰</h3>';
                if (data2.status === 'ok') {
                    html += `<p class="status-warning">âš ï¸ API Keyãªã—ã§ã‚‚å‹•ä½œï¼ˆç„¡æ–™æ ï¼‰</p>`;
                } else {
                    html += `<p class="status-info">â„¹ï¸ ${data2.message}</p>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="status-error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testMultipleFeeds() {
            const resultDiv = document.getElementById('apiTestResult');
            const apiKey = localStorage.getItem('rss2json-api-key');
            
            const testFeeds = [
                'https://techcrunch.com/feed/',
                'https://www.theverge.com/rss/index.xml',
                'https://feeds.feedburner.com/hatena/b/hotentry',
                'https://blog.google/technology/ai/rss/',
                'https://www.bmbf.de/SiteGlobals/Functions/RSSFeed/BMBF_RSSNewsfeed.xml'
            ];
            
            resultDiv.innerHTML = '<h3>è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆä¸­...</h3>';
            let results = [];
            
            for (const feedUrl of testFeeds) {
                try {
                    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}&api_key=${apiKey}&count=1`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    const domain = new URL(feedUrl).hostname;
                    if (data.status === 'ok') {
                        results.push(`âœ… ${domain}: æˆåŠŸ`);
                        log(`${domain}: æˆåŠŸ`, 'success');
                    } else {
                        results.push(`âŒ ${domain}: ${data.message}`);
                        log(`${domain}: ${data.message}`, 'error');
                    }
                } catch (error) {
                    const domain = new URL(feedUrl).hostname;
                    results.push(`âŒ ${domain}: ${error.message}`);
                    log(`${domain}: ${error.message}`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            resultDiv.innerHTML = '<h3>ãƒ†ã‚¹ãƒˆçµæœ</h3>' + results.map(r => `<p>${r}</p>`).join('');
        }

        function check05Implementation() {
            const checkDiv = document.getElementById('implementationCheck');
            
            // 05_rss-readerã®testFeedé–¢æ•°ã‚’ç¢ºèª
            let html = '<h3>å®Ÿè£…çŠ¶æ…‹</h3>';
            
            // LocalStorageã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ç¢ºèª
            const feeds = JSON.parse(localStorage.getItem('rss-feeds') || '[]');
            const successFeeds = feeds.filter(f => f.status === 'âœ… OK' || f.status === 'OK');
            const rss2jsonFeeds = successFeeds.filter(f => f.message && f.message.includes('RSS2JSON'));
            
            html += `<p>ç·ãƒ•ã‚£ãƒ¼ãƒ‰æ•°: ${feeds.length}</p>`;
            html += `<p>æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰: ${successFeeds.length}</p>`;
            html += `<p>RSS2JSONçµŒç”±: ${rss2jsonFeeds.length}</p>`;
            
            if (rss2jsonFeeds.length === 0) {
                html += '<p class="status-error">âŒ RSS2JSONãŒä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ï¼</p>';
                html += '<p>åŸå› : testFeedé–¢æ•°ã§RSS2JSONãŒå„ªå…ˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§</p>';
            } else {
                html += '<p class="status-ok">âœ… RSS2JSONãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™</p>';
                html += '<h4>RSS2JSONæˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰:</h4>';
                rss2jsonFeeds.slice(0, 5).forEach(feed => {
                    html += `<p>ãƒ»${feed.name}</p>`;
                });
            }
            
            checkDiv.innerHTML = html;
            log('å®Ÿè£…ç¢ºèªå®Œäº†', 'info');
        }

        function analyzeFeedStatus() {
            const analysisDiv = document.getElementById('feedAnalysis');
            const feeds = JSON.parse(localStorage.getItem('rss-feeds') || '[]');
            
            const categories = {};
            feeds.forEach(feed => {
                const category = feed.category || 'æœªåˆ†é¡';
                if (!categories[category]) {
                    categories[category] = { success: 0, error: 0, total: 0 };
                }
                categories[category].total++;
                
                if (feed.status === 'âœ… OK' || feed.status === 'OK') {
                    categories[category].success++;
                } else {
                    categories[category].error++;
                }
            });
            
            let html = '<h3>ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆ†æ</h3><table style="width:100%;">';
            html += '<tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æˆåŠŸ</th><th>ã‚¨ãƒ©ãƒ¼</th><th>æˆåŠŸç‡</th></tr>';
            
            Object.entries(categories).forEach(([cat, stats]) => {
                const rate = ((stats.success / stats.total) * 100).toFixed(1);
                const rateClass = rate > 50 ? 'status-ok' : rate > 25 ? 'status-warning' : 'status-error';
                html += `<tr>
                    <td>${cat}</td>
                    <td>${stats.success}</td>
                    <td>${stats.error}</td>
                    <td class="${rateClass}">${rate}%</td>
                </tr>`;
            });
            
            html += '</table>';
            analysisDiv.innerHTML = html;
            log('ãƒ•ã‚£ãƒ¼ãƒ‰åˆ†æå®Œäº†', 'info');
        }

        function fullReset() {
            if (!confirm('å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const feeds = JSON.parse(localStorage.getItem('rss-feeds') || '[]');
            feeds.forEach(feed => {
                feed.status = 'æœªãƒ†ã‚¹ãƒˆ';
                feed.lastChecked = null;
                feed.errorType = null;
                feed.articleCount = null;
                feed.message = null;
            });
            localStorage.setItem('rss-feeds', JSON.stringify(feeds));
            
            document.getElementById('resetResult').innerHTML = 
                '<p class="status-ok">âœ… ãƒªã‚»ãƒƒãƒˆå®Œäº†ã€‚05_rss-readerã§å†ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚</p>';
            log('å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå®Œäº†', 'success');
        }

        function reloadApiKey() {
            if (typeof API_CONFIG !== 'undefined' && API_CONFIG.RSS2JSON_API_KEY) {
                localStorage.setItem('rss2json-api-key', API_CONFIG.RSS2JSON_API_KEY);
                document.getElementById('resetResult').innerHTML = 
                    `<p class="status-ok">âœ… API Keyå†èª­ã¿è¾¼ã¿å®Œäº†: ${API_CONFIG.RSS2JSON_API_KEY.substring(0, 20)}...</p>`;
                log('API Keyå†èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } else {
                document.getElementById('resetResult').innerHTML = 
                    '<p class="status-error">âŒ api-config.jsã‹ã‚‰API Keyã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“</p>';
                log('API Keyèª­ã¿è¾¼ã¿å¤±æ•—', 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', () => {
            log('ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«èµ·å‹•', 'info');
            checkApiKeyDetails();
        });
    </script>
</body>
</html>