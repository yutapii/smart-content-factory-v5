<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® „Ç®„É©„Éº„É¢„Éã„Çø„Éº - RSSÂèñÂæóÁä∂Ê≥ÅÁõ£Ë¶ñ | SCF V5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
        }

        .alert-icon {
            font-size: 4em;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card.error {
            background: rgba(255, 67, 54, 0.2);
            border-color: #ff4336;
            animation: errorPulse 2s infinite;
        }

        @keyframes errorPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 67, 54, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 67, 54, 0); }
        }

        .stat-card.warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }

        .stat-card.success {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .error-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ff4336;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .error-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .error-item.warning {
            border-left-color: #ffc107;
        }

        .error-item.info {
            border-left-color: #2196f3;
        }

        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .error-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
        }

        .error-time {
            font-size: 0.9em;
            opacity: 0.7;
        }

        .error-url {
            color: #64b5f6;
            font-size: 0.9em;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .error-message {
            background: rgba(255, 67, 54, 0.1);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .error-code {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .auto-refresh {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-refresh input {
            width: 20px;
            height: 20px;
        }

        .auto-refresh label {
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="alert-icon">üö®</div>
        <h1>RSS „Ç®„É©„Éº„É¢„Éã„Çø„Éº</h1>
        <p>„É™„Ç¢„É´„Çø„Ç§„É†„ÅßRSS„Éï„Ç£„Éº„Éâ„ÅÆÁä∂ÊÖã„ÇíÁõ£Ë¶ñ</p>
    </div>

    <div class="stats-container">
        <div class="stat-card error">
            <div class="stat-value" id="errorCount">0</div>
            <div class="stat-label">„Ç®„É©„Éº</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="warningCount">0</div>
            <div class="stat-label">Ë≠¶Âëä</div>
        </div>
        <div class="stat-card success">
            <div class="stat-value" id="successCount">0</div>
            <div class="stat-label">Ê≠£Â∏∏</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalCount">0</div>
            <div class="stat-label">Á∑è„Éï„Ç£„Éº„ÉâÊï∞</div>
        </div>
    </div>

    <div class="control-panel">
        <button class="btn btn-refresh" onclick="checkAllFeeds()">üîÑ ÂÖ®„Éï„Ç£„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ</button>
        <button class="btn btn-clear" onclick="clearErrors()">üóëÔ∏è „Ç®„É©„Éº„Çí„ÇØ„É™„Ç¢</button>
        <button class="btn btn-export" onclick="exportErrors()">üì• „Ç®„É©„Éº„É≠„Ç∞„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
    </div>

    <div class="filter-tabs">
        <div class="tab active" onclick="filterErrors('all')">„Åô„Åπ„Å¶</div>
        <div class="tab" onclick="filterErrors('error')">„Ç®„É©„Éº„ÅÆ„Åø</div>
        <div class="tab" onclick="filterErrors('warning')">Ë≠¶Âëä„ÅÆ„Åø</div>
        <div class="tab" onclick="filterErrors('http500')">500„Ç®„É©„Éº</div>
        <div class="tab" onclick="filterErrors('network')">„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº</div>
    </div>

    <div class="error-list" id="errorList">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>„Éï„Ç£„Éº„ÉâÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
    </div>

    <div class="auto-refresh">
        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
        <label for="autoRefresh">30Áßí„Åî„Å®„Å´Ëá™ÂãïÊõ¥Êñ∞</label>
    </div>

    <script>
        let autoRefreshInterval = null;
        let currentFilter = 'all';
        let feedErrors = [];

        // IndexedDBÂàùÊúüÂåñ
        let db;
        const DB_NAME = 'SCFV5_RSS';
        const DB_VERSION = 2;

        async function initDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('DBÊé•Á∂ö„Ç®„É©„Éº');
                    db = null;
                    resolve(null);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('feeds')) {
                        db.createObjectStore('feeds', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // „Éï„Ç£„Éº„ÉâÂèñÂæó
        async function getAllFeeds() {
            // LocalStorage„Åã„ÇâÂèñÂæó
            try {
                const stored = localStorage.getItem('rss-feeds');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.error('LocalStorageË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }

            // IndexedDB„Åã„ÇâÂèñÂæó
            if (db) {
                try {
                    const transaction = db.transaction(['feeds'], 'readonly');
                    const store = transaction.objectStore('feeds');
                    return new Promise((resolve) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => resolve([]);
                    });
                } catch (e) {
                    console.error('DBË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
                }
            }
            
            return [];
        }

        // „Éï„Ç£„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkFeed(feed) {
            const workerUrl = 'https://polished-snow-477a.yutapii.workers.dev';
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${workerUrl}?url=${encodeURIComponent(feed.url)}`, {
                    method: 'GET',
                    mode: 'cors',
                    signal: AbortSignal.timeout(10000) // 10Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                });
                
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('<rss') || text.includes('<feed') || text.includes('<item>')) {
                        return {
                            ...feed,
                            status: 'success',
                            message: 'Ê≠£Â∏∏„Å´ÂèñÂæó',
                            responseTime: responseTime
                        };
                    } else if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                        return {
                            ...feed,
                            status: 'error',
                            message: 'HTML„ÅåËøî„Åï„Çå„Åæ„Åó„ÅüÔºàRSS„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ',
                            errorCode: 'HTML_CONTENT',
                            responseTime: responseTime
                        };
                    }
                } else {
                    return {
                        ...feed,
                        status: 'error',
                        message: `HTTP ${response.status}„Ç®„É©„Éº`,
                        errorCode: `HTTP_${response.status}`,
                        responseTime: responseTime
                    };
                }
            } catch (error) {
                // RSS2JSON„ÅßÂÜçË©¶Ë°å
                try {
                    const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`;
                    const response = await fetch(apiUrl, {
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'ok') {
                            return {
                                ...feed,
                                status: 'warning',
                                message: 'RSS2JSONÁµåÁî±„ÅßÂèñÂæó',
                                responseTime: Date.now() - startTime
                            };
                        }
                    }
                } catch (e) {
                    // ÁÑ°Ë¶ñ
                }
                
                return {
                    ...feed,
                    status: 'error',
                    message: error.message || '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº',
                    errorCode: 'NETWORK_ERROR',
                    responseTime: Date.now() - startTime
                };
            }
        }

        // ÂÖ®„Éï„Ç£„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkAllFeeds() {
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...</p></div>';
            
            const feeds = await getAllFeeds();
            feedErrors = [];
            
            let errorCount = 0;
            let warningCount = 0;
            let successCount = 0;
            
            // ‰∏¶Âàó„Åß„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÂ§ß5ÂêåÊôÇÔºâ
            const batchSize = 5;
            for (let i = 0; i < feeds.length; i += batchSize) {
                const batch = feeds.slice(i, i + batchSize);
                const results = await Promise.all(batch.map(feed => checkFeed(feed)));
                
                results.forEach(result => {
                    if (result.status === 'error') {
                        errorCount++;
                        feedErrors.push(result);
                    } else if (result.status === 'warning') {
                        warningCount++;
                        feedErrors.push(result);
                    } else {
                        successCount++;
                    }
                });
                
                // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞
                updateStats(errorCount, warningCount, successCount, feeds.length);
            }
            
            displayErrors();
        }

        // Áµ±Ë®àÊõ¥Êñ∞
        function updateStats(errors, warnings, success, total) {
            document.getElementById('errorCount').textContent = errors;
            document.getElementById('warningCount').textContent = warnings;
            document.getElementById('successCount').textContent = success;
            document.getElementById('totalCount').textContent = total;
        }

        // „Ç®„É©„ÉºË°®Á§∫
        function displayErrors() {
            const errorList = document.getElementById('errorList');
            let filtered = feedErrors;
            
            if (currentFilter === 'error') {
                filtered = feedErrors.filter(f => f.status === 'error');
            } else if (currentFilter === 'warning') {
                filtered = feedErrors.filter(f => f.status === 'warning');
            } else if (currentFilter === 'http500') {
                filtered = feedErrors.filter(f => f.errorCode === 'HTTP_500');
            } else if (currentFilter === 'network') {
                filtered = feedErrors.filter(f => f.errorCode === 'NETWORK_ERROR');
            }
            
            if (filtered.length === 0) {
                errorList.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">„Ç®„É©„Éº„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            errorList.innerHTML = filtered.map(feed => `
                <div class="error-item ${feed.status}">
                    <div class="error-header">
                        <div class="error-title">
                            ${feed.status === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${feed.name || 'Unknown'}
                            ${feed.errorCode ? `<span class="error-code">${feed.errorCode}</span>` : ''}
                        </div>
                        <div class="error-time">${new Date().toLocaleTimeString('ja-JP')}</div>
                    </div>
                    <div class="error-url">${feed.url}</div>
                    <div class="error-message">${feed.message}</div>
                    ${feed.responseTime ? `<div style="margin-top: 5px; opacity: 0.7;">ÂøúÁ≠îÊôÇÈñì: ${feed.responseTime}ms</div>` : ''}
                </div>
            `).join('');
        }

        // „Éï„Ç£„É´„Çø„Éº
        function filterErrors(type) {
            currentFilter = type;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayErrors();
        }

        // „Ç®„É©„Éº„ÇØ„É™„Ç¢
        function clearErrors() {
            feedErrors = [];
            displayErrors();
            updateStats(0, 0, 0, 0);
        }

        // „Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportErrors() {
            const data = {
                timestamp: new Date().toISOString(),
                errors: feedErrors,
                stats: {
                    total: document.getElementById('totalCount').textContent,
                    errors: document.getElementById('errorCount').textContent,
                    warnings: document.getElementById('warningCount').textContent,
                    success: document.getElementById('successCount').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rss-errors-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Ëá™ÂãïÊõ¥Êñ∞
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(checkAllFeeds, 30000);
            } else {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // ÂàùÊúüÂåñ
        window.addEventListener('load', async () => {
            await initDB();
            await checkAllFeeds();
        });
    </script>
</body>
</html>