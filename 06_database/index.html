<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>06 データベース</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        .article {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .article:hover {
            background-color: #f5f5f5;
        }
        .article.selected {
            background-color: #e3f2fd;
            border-color: #1976d2;
        }
        .checkbox-wrapper {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .article-content {
            margin-left: 40px;
        }
        .title {
            font-weight: bold;
            color: #333;
        }
        .meta {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .selection-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .selection-bar.active {
            display: block;
        }
        .selection-count {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .btn-send {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-clear {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <a href="../index.html" style="text-decoration: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; border-radius: 8px; display: inline-block; font-weight: bold;">
            ← トップページに戻る
        </a>
        <a href="../10_rss-to-article.html" style="text-decoration: none; background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; padding: 10px 20px; border-radius: 8px; display: inline-block; font-weight: bold;">
            → [10] RSS→記事連携へ
        </a>
    </div>
    <h1>06 データベース - 記事一覧</h1>
    <button onclick="loadFromFile()">ファイルから読み込み</button>
    <button onclick="loadFromRSS()">05_RSSから読み込み</button>
    <button onclick="filterByCategory('AI')">AIのみ</button>
    <button onclick="filterByCategory('ロボット')">ロボットのみ</button>
    <button onclick="filterByCategory('自動運転')">自動運転のみ</button>
    <button onclick="filterByCategory('通信')">通信のみ</button>
    <button onclick="showAll()">全て表示</button>
    <button onclick="clearRSSData()" style="background: #ff5722; color: white;">RSSデータをクリア</button>
    <button onclick="selectAll()" style="background: #2196f3; color: white;">全て選択</button>
    <button onclick="deselectAll()" style="background: #9e9e9e; color: white;">選択解除</button>
    <div id="count"></div>
    <div id="articles"></div>
    
    <!-- 選択バー -->
    <div class="selection-bar" id="selectionBar">
        <div class="selection-count" id="selectionCount">0件選択中</div>
        <div class="action-buttons">
            <button class="btn-send" onclick="sendToModule10()">
                [10]へ送信
            </button>
            <button class="btn-clear" onclick="deselectAll()">
                クリア
            </button>
        </div>
    </div>

    <script>
        let allData = null;
        let selectedArticles = new Set();
        let currentDisplayedArticles = [];
        
        // ファイルから読み込み（既存のdata.json）
        async function loadFromFile() {
            try {
                const response = await fetch('./data/batch_001.json');
                allData = await response.json();
                displayArticles(allData.articles);
                showMessage('ファイルからデータを読み込みました', 'success');
            } catch (error) {
                console.error('ファイル読み込みエラー:', error);
                showMessage('ファイルの読み込みに失敗しました', 'error');
            }
        }
        
        // 05_rss-readerから読み込み（localStorage）
        function loadFromRSS() {
            try {
                const stored = localStorage.getItem('06_database_articles');
                if (stored) {
                    allData = JSON.parse(stored);
                    displayArticles(allData.articles);
                    showMessage(`05_rss-readerから${allData.articles.length}件の記事を読み込みました`, 'success');
                } else {
                    showMessage('05_rss-readerからのデータがありません。先に05_rss-readerで「06へ保存」を実行してください', 'warning');
                }
            } catch (error) {
                console.error('localStorage読み込みエラー:', error);
                showMessage('データの読み込みに失敗しました', 'error');
            }
        }
        
        // RSSデータをクリア
        function clearRSSData() {
            if (confirm('05_rss-readerから保存されたデータをクリアしますか？')) {
                localStorage.removeItem('06_database_articles');
                allData = null;
                document.getElementById('articles').innerHTML = '';
                document.getElementById('count').textContent = '';
                showMessage('RSSデータをクリアしました', 'success');
            }
        }
        
        // メッセージ表示
        function showMessage(message, type) {
            const count = document.getElementById('count');
            const color = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#ff9800';
            count.innerHTML = `<span style="color: ${color}; font-weight: bold;">${message}</span>`;
            setTimeout(() => {
                if (allData && allData.articles) {
                    count.textContent = `表示中: ${allData.articles.length}件`;
                }
            }, 3000);
        }
        
        function displayArticles(articles) {
            const container = document.getElementById('articles');
            const count = document.getElementById('count');
            
            count.textContent = `表示中: ${articles.length}件`;
            currentDisplayedArticles = articles;
            
            // 記事を日付の新しい順にソート
            const sortedArticles = [...articles].sort((a, b) => {
                const dateA = new Date(a.date || '2000-01-01');
                const dateB = new Date(b.date || '2000-01-01');
                return dateB - dateA;
            });
            
            container.innerHTML = sortedArticles.map((article, index) => {
                const uniqueId = `article-${article.id || index}`;
                const isSelected = selectedArticles.has(uniqueId);
                return `
                <div class="article ${isSelected ? 'selected' : ''}" data-article-id="${uniqueId}" onclick="toggleSelection('${uniqueId}')">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelection('${uniqueId}')">
                    </div>
                    <div class="article-content">
                        <div class="title">${article.id}. ${article.title}</div>
                        <div>${article.description || ''}</div>
                        <div class="meta">
                            📅 ${article.date || '日付不明'} | 📰 ${article.source || '不明'} | 🏷️ ${article.category || 'その他'}
                            ${article.url ? `| <a href="${article.url}" target="_blank" style="color: #1976d2;" onclick="event.stopPropagation();">🔗 記事を読む</a>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
            
            updateSelectionBar();
        }
        
        // 記事の選択をトグル
        function toggleSelection(articleId) {
            const articleElement = document.querySelector(`[data-article-id="${articleId}"]`);
            const checkbox = articleElement.querySelector('input[type="checkbox"]');
            
            if (selectedArticles.has(articleId)) {
                selectedArticles.delete(articleId);
                articleElement.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedArticles.add(articleId);
                articleElement.classList.add('selected');
                checkbox.checked = true;
            }
            
            updateSelectionBar();
        }
        
        // 全て選択
        function selectAll() {
            const articles = document.querySelectorAll('.article');
            articles.forEach(article => {
                const articleId = article.dataset.articleId;
                selectedArticles.add(articleId);
                article.classList.add('selected');
                const checkbox = article.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = true;
            });
            updateSelectionBar();
        }
        
        // 選択解除
        function deselectAll() {
            selectedArticles.clear();
            const articles = document.querySelectorAll('.article');
            articles.forEach(article => {
                article.classList.remove('selected');
                const checkbox = article.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
            updateSelectionBar();
        }
        
        // 選択バーの更新
        function updateSelectionBar() {
            const selectionBar = document.getElementById('selectionBar');
            const selectionCount = document.getElementById('selectionCount');
            
            if (selectedArticles.size > 0) {
                selectionBar.classList.add('active');
                selectionCount.textContent = `${selectedArticles.size}件選択中`;
            } else {
                selectionBar.classList.remove('active');
            }
        }
        
        // モジュール10へ送信
        function sendToModule10() {
            if (selectedArticles.size === 0) {
                showMessage('記事を選択してください', 'warning');
                return;
            }
            
            // 選択された記事のデータを取得
            const selectedData = [];
            currentDisplayedArticles.forEach((article, index) => {
                const uniqueId = `article-${article.id || index}`;
                if (selectedArticles.has(uniqueId)) {
                    selectedData.push(article);
                }
            });
            
            // localStorageに保存
            localStorage.setItem('selected_articles_for_10', JSON.stringify({
                articles: selectedData,
                selectedAt: new Date().toISOString(),
                source: '06_database'
            }));
            
            showMessage(`${selectedData.length}件の記事を[10]へ送信しました`, 'success');
            
            // 3秒後に10へ遷移
            setTimeout(() => {
                window.location.href = '../10_rss-to-article.html';
            }, 2000);
        }
        
        function filterByCategory(category) {
            if (!allData) {
                showMessage('先にデータを読み込んでください', 'warning');
                return;
            }
            const filtered = allData.articles.filter(a => a.category === category);
            displayArticles(filtered);
        }
        
        function showAll() {
            if (!allData) {
                showMessage('先にデータを読み込んでください', 'warning');
                return;
            }
            displayArticles(allData.articles);
        }
        
        // ページ読み込み時に自動でRSSデータを確認
        window.addEventListener('load', () => {
            const stored = localStorage.getItem('06_database_articles');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated).toLocaleString('ja-JP') : '不明';
                    showMessage(`05_rss-readerからのデータあり（最終更新: ${lastUpdated}）`, 'success');
                } catch (e) {
                    console.error('データ確認エラー:', e);
                }
            }
        });
    </script>
</body>
</html>