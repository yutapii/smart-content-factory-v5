<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS一覧 - 配信元管理 | SCF V5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 探索中アニメーション */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        @keyframes searchMove {
            0%, 100% { transform: translateX(0) rotate(-15deg); }
            25% { transform: translateX(5px) rotate(-15deg); }
            75% { transform: translateX(-5px) rotate(-15deg); }
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .searching-animation {
            display: inline-flex;
            align-items: center;
            gap: 15px;
        }
        
        .search-icon-animated {
            font-size: 2.5em;
            animation: searchMove 1.5s ease-in-out infinite;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .dots-container {
            display: inline-flex;
            gap: 5px;
        }
        
        .dots-container .pulse-dot:nth-child(1) { animation-delay: 0s; }
        .dots-container .pulse-dot:nth-child(2) { animation-delay: 0.2s; }
        .dots-container .pulse-dot:nth-child(3) { animation-delay: 0.4s; }
        
        .search-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
            color: #667eea;
        }
        
        .search-progress {
            width: 100%;
            height: 4px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .search-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            animation: progress 3s ease-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 60%; }
            100% { width: 90%; }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .stats-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .add-form {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .add-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .add-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .feed-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .feed-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .feed-item:hover {
            background: #f8f9fa;
        }

        .feed-info {
            flex: 1;
        }

        .feed-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .feed-url {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
            word-break: break-all;
            line-height: 1.6;
        }
        
        .feed-url a {
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .feed-url a:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        .feed-meta {
            display: flex;
            gap: 20px;
            font-size: 0.85em;
            color: #999;
        }

        .feed-category {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 3px;
        }

        .feed-error-badge {
            background: #ffebee;
            color: #c62828;
            padding: 2px 8px;
            border-radius: 3px;
            margin-left: 10px;
            cursor: help;
            animation: errorPulse 2s infinite;
        }

        @keyframes errorPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .feed-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .import-area {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            font-family: monospace;
            resize: vertical;
        }

        .file-input-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .import-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .import-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .import-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .import-panel {
            display: none;
        }

        .import-panel.active {
            display: block;
        }

        .import-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .import-preview-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }

        .import-preview-item:last-child {
            border-bottom: none;
        }

        .import-preview-item.error {
            background: #ffebee;
            color: #c62828;
        }

        .import-preview-item.duplicate {
            background: #fff3e0;
            color: #e65100;
        }

        .import-preview-item.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .category-tag {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .category-tag:hover {
            background: #e0e0e0;
        }

        .category-tag.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }
            
            .add-form {
                flex-direction: column;
            }
            
            .feed-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .feed-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
            }
        }
        
        /* 通知トースト */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideIn 0.3s ease;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left: 4px solid #4caf50;
        }
        
        .toast.error {
            border-left: 4px solid #f44336;
        }
        
        .toast.warning {
            border-left: 4px solid #ff9800;
        }
        
        .toast.info {
            border-left: 4px solid #2196f3;
        }
        
        .toast-icon {
            font-size: 1.2em;
        }
        
        .toast-message {
            flex: 1;
            color: #333;
            font-size: 14px;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- トースト通知コンテナ -->
    <div class="toast-container" id="toastContainer"></div>
    <div class="header">
        <div class="header-content">
            <h1>📰 RSS一覧 - 配信元管理 <span id="feedCountBadge" style="font-size: 0.5em; background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 15px; margin-left: 10px;">(0件)</span></h1>
            <a href="../index.html" class="back-btn">← ダッシュボードへ</a>
        </div>
    </div>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalFeeds">0</div>
                <div class="stat-label">登録フィード数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activeFeeds">0</div>
                <div class="stat-label">アクティブ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="categoryCount">0</div>
                <div class="stat-label">カテゴリ数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdate">--:--</div>
                <div class="stat-label">最終更新</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <form class="add-form" id="addFeedForm">
                    <input type="text" id="feedName" placeholder="フィード名（例：TechCrunch）" required>
                    <input type="url" id="feedUrl" placeholder="RSS URL（https://...）" required>
                    <select id="feedCategory">
                        <option value="">カテゴリ選択</option>
                        <option value="テクノロジー">テクノロジー</option>
                        <option value="ビジネス">ビジネス</option>
                        <option value="AI・機械学習">AI・機械学習</option>
                        <option value="スタートアップ">スタートアップ</option>
                        <option value="官公庁">官公庁</option>
                        <option value="その他">その他</option>
                    </select>
                    <button type="submit" class="btn btn-primary">追加</button>
                </form>
            </div>
            <div class="control-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="フィードを検索...">
                </div>
                <select id="errorFilter" onchange="displayFeeds()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                    <option value="all">全て表示</option>
                    <option value="normal">✅ 正常のみ</option>
                    <option value="error">❌ エラーのみ</option>
                    <option value="html_error">📄 HTMLエラー</option>
                    <option value="invalid_feed">⚠️ 無効なRSS</option>
                    <option value="network_error">🌐 ネットワークエラー</option>
                    <option value="restricted">🔒 アクセス制限</option>
                    <option value="stopped">⏸️ 停止中</option>
                </select>
                <button class="btn btn-secondary" onclick="showImportModal()">📥 一括インポート</button>
                <button class="btn btn-success" onclick="showExportOptions()">📤 エクスポート</button>
                <button class="btn btn-primary" onclick="showAIRSSFinder()">🤖 RSS探索</button>
                <button class="btn btn-primary" onclick="showAutoTestModal()" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    🔄 自動テスト
                </button>
            </div>
            <div class="category-tags" id="categoryFilter">
                <span class="category-tag active" data-category="all">すべて</span>
            </div>
        </div>

        <div class="feed-list" id="feedList">
            <div class="empty-state">
                <div class="empty-state-icon">📡</div>
                <div class="empty-state-text">まだフィードが登録されていません</div>
                <div class="empty-state-text">上のフォームから追加してください</div>
            </div>
        </div>
    </div>

    <!-- インポートモーダル -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeImportModal()">&times;</span>
                <h2>RSSフィード一括インポート</h2>
            </div>
            
            <div class="import-tabs">
                <button class="import-tab active" onclick="switchImportTab('text')">テキスト入力</button>
                <button class="import-tab" onclick="switchImportTab('file')">ファイルアップロード</button>
            </div>
            
            <!-- テキスト入力パネル -->
            <div id="textImportPanel" class="import-panel active">
                <p>1行1フィードで入力してください（名前|URL|カテゴリ）</p>
                <textarea class="import-area" id="importData" placeholder="TechCrunch|https://techcrunch.com/feed/|テクノロジー
Bloomberg|https://www.bloomberg.com/feed/|ビジネス
MIT Tech Review|https://www.technologyreview.com/feed/|AI・機械学習"></textarea>
            </div>
            
            <!-- ファイルアップロードパネル -->
            <div id="fileImportPanel" class="import-panel">
                <div class="file-input-container">
                    <label for="fileInput" class="file-input-label">
                        📁 ファイルを選択
                    </label>
                    <input type="file" id="fileInput" class="file-input" accept=".txt,.csv,.tsv,.json" onchange="handleFileSelect(event)">
                    <div class="file-info" id="fileInfo">対応形式: .txt, .csv, .tsv, .json</div>
                </div>
                <div id="filePreview" style="display: none;">
                    <h4 style="margin-bottom: 10px;">プレビュー:</h4>
                    <div class="import-preview" id="fileImportPreview"></div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">キャンセル</button>
                <button type="button" class="btn btn-primary" id="importBtn" style="margin-left: 10px;">インポート</button>
            </div>
        </div>
    </div>

    <!-- エラーハンドリング・ログシステム -->
    <script src="../js/logger.js"></script>
    <script src="../js/error-handler.js"></script>
    
    <script>
        // IndexedDB設定
        let db;
        const DB_NAME = 'SCFV5_RSS';
        const DB_VERSION = 2; // バージョンを2に統一
        
        // トースト通知システム
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            // 自動で消える
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            return toast;
        }

        // IndexedDB初期化（改善版）
        async function initDB() {
            return new Promise((resolve, reject) => {
                // 既存のDB接続を閉じる
                if (db) {
                    try {
                        db.close();
                        db = null;
                    } catch (e) {
                        console.log('既存DB接続のクローズ中のエラー（無視可）:', e);
                    }
                }
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB接続エラー:', request.error);
                    // エラーでもLocalStorageで動作継続
                    db = null;
                    resolve(null);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB接続成功: バージョン', db.version);
                    
                    // DB接続が切れた場合の処理
                    db.onversionchange = () => {
                        db.close();
                        db = null;
                        console.log('DBバージョンが変更されたため接続を閉じました');
                    };
                    
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    const oldVersion = event.oldVersion;
                    const newVersion = event.newVersion;
                    
                    console.log(`DBアップグレード: ${oldVersion} → ${newVersion}`);
                    
                    // feeds store（RSS一覧用）
                    if (!db.objectStoreNames.contains('feeds')) {
                        const store = db.createObjectStore('feeds', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('active', 'active', { unique: false });
                        console.log('feeds storeを作成しました');
                    }
                    
                    // articles store（配信RSS用、バージョン2で追加）
                    if (!db.objectStoreNames.contains('articles')) {
                        const articleStore = db.createObjectStore('articles', { keyPath: 'id', autoIncrement: true });
                        articleStore.createIndex('feedId', 'feedId', { unique: false });
                        articleStore.createIndex('pubDate', 'pubDate', { unique: false });
                        articleStore.createIndex('saved', 'saved', { unique: false });
                        console.log('articles storeを作成しました');
                    }
                };
                
                request.onblocked = () => {
                    console.warn('DB接続がブロックされています - 他のタブを閉じてください');
                    showToast('データベース接続がブロックされています。他のタブを閉じてからページをリロードしてください。', 'warning', 5000);
                };
            });
        }

        // フィード形式を検出する関数
        function detectFeedFormat(xmlText) {
            // Atom 1.0
            if (xmlText.includes('<feed xmlns="http://www.w3.org/2005/Atom"') || 
                xmlText.includes('<feed') && xmlText.includes('xmlns:atom=')) {
                return 'Atom 1.0';
            }
            
            // RSS 2.0
            if (xmlText.includes('<rss version="2.0"') || 
                xmlText.includes('<rss') && xmlText.includes('version="2.0"')) {
                return 'RSS 2.0';
            }
            
            // RSS 1.0 (RDF)
            if (xmlText.includes('<rdf:RDF') || 
                xmlText.includes('xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"')) {
                return 'RSS 1.0';
            }
            
            // RSS version不明
            if (xmlText.includes('<rss') || xmlText.includes('<channel>')) {
                return 'RSS';
            }
            
            // その他
            if (xmlText.includes('<feed') || xmlText.includes('<entry>')) {
                return 'Atom';
            }
            
            return 'Unknown';
        }
        
        // サイトから利用可能なフィードを検出し、優先順位で返す
        async function detectAvailableFeeds(siteUrl) {
            const feeds = [];
            
            try {
                const response = await fetch(`https://polished-snow-477a.yutapii.workers.dev?url=${encodeURIComponent(siteUrl)}`);
                const html = await response.text();
                
                // Atom フィードを検索
                const atomRegex = /<link[^>]+type=["']application\/atom\+xml["'][^>]*href=["']([^"']+)["'][^>]*>/gi;
                let match;
                while ((match = atomRegex.exec(html)) !== null) {
                    feeds.push({ type: 'Atom 1.0', url: match[1], priority: 1 });
                }
                
                // RSS 2.0 フィードを検索
                const rss2Regex = /<link[^>]+type=["']application\/rss\+xml["'][^>]*href=["']([^"']+)["'][^>]*>/gi;
                while ((match = rss2Regex.exec(html)) !== null) {
                    feeds.push({ type: 'RSS 2.0', url: match[1], priority: 2 });
                }
                
                // RSS 1.0 (RDF) フィードを検索
                const rss1Regex = /<link[^>]+type=["']application\/rdf\+xml["'][^>]*href=["']([^"']+)["'][^>]*>/gi;
                while ((match = rss1Regex.exec(html)) !== null) {
                    feeds.push({ type: 'RSS 1.0', url: match[1], priority: 3 });
                }
                
                // 優先順位でソート
                feeds.sort((a, b) => a.priority - b.priority);
                
            } catch (error) {
                console.error('フィード検出エラー:', error);
            }
            
            return feeds;
        }

        // フィード追加
        async function addFeed(feed) {
            // dbが未定義の場合は初期化
            if (!db) {
                await initDB();
                
                // それでもdbがnullの場合はLocalStorageを使用
                if (!db) {
                    console.log('LocalStorageにフィードを保存');
                    let feeds = [];
                    try {
                        const stored = localStorage.getItem('rss-feeds');
                        if (stored) {
                            feeds = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('LocalStorage読み込みエラー:', e);
                        feeds = [];
                    }
                    
                    // 新しいフィードを追加
                    feed.id = Date.now() + Math.random();
                    feed.createdAt = new Date().toISOString();
                    feed.lastUpdate = new Date().toISOString();
                    feed.active = true;
                    feeds.push(feed);
                    
                    localStorage.setItem('rss-feeds', JSON.stringify(feeds));
                    return Promise.resolve(feed);
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['feeds'], 'readwrite');
                const store = transaction.objectStore('feeds');
                
                feed.active = true;
                feed.lastUpdate = new Date().toISOString();
                feed.createdAt = new Date().toISOString();
                
                const request = store.add(feed);
                
                request.onsuccess = () => {
                    console.log('フィード追加成功:', feed.name);
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    console.error('フィード追加エラー:', request.error);
                    reject(request.error);
                };
            });
        }

        // 全フィード取得
        async function getAllFeeds() {
            // dbが未定義の場合は初期化
            if (!db) {
                await initDB();
                
                // それでもdbがnullの場合はLocalStorageから取得
                if (!db) {
                    console.log('LocalStorageからフィードを取得');
                    try {
                        const stored = localStorage.getItem('rss-feeds');
                        if (stored) {
                            return JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('LocalStorage読み込みエラー:', e);
                    }
                    return [];
                }
            }
            
            const transaction = db.transaction(['feeds'], 'readonly');
            const store = transaction.objectStore('feeds');
            
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // フィード削除
        async function deleteFeed(id) {
            if (!db) {
                await initDB();
            }
            const transaction = db.transaction(['feeds'], 'readwrite');
            const store = transaction.objectStore('feeds');
            return store.delete(id);
        }

        // フィード更新
        async function updateFeed(feed) {
            if (!db) {
                await initDB();
            }
            const transaction = db.transaction(['feeds'], 'readwrite');
            const store = transaction.objectStore('feeds');
            feed.lastUpdate = new Date().toISOString();
            return store.put(feed);
        }

        // フィード表示
        async function displayFeeds(filter = '') {
            const feeds = await getAllFeeds();
            const feedList = document.getElementById('feedList');
            
            // フィルタリング
            let filteredFeeds = feeds;
            if (filter && filter !== 'all') {
                filteredFeeds = feeds.filter(f => f.category === filter);
            }
            
            // エラーフィルタ
            const errorFilter = document.getElementById('errorFilter')?.value || 'all';
            if (errorFilter !== 'all') {
                switch(errorFilter) {
                    case 'normal':
                        filteredFeeds = filteredFeeds.filter(f => !f.fetchError && f.active);
                        break;
                    case 'error':
                        filteredFeeds = filteredFeeds.filter(f => f.fetchError);
                        break;
                    case 'html_error':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && f.lastError.includes('HTMLページが返されました')
                        );
                        break;
                    case 'invalid_feed':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && f.lastError.includes('有効なRSSフィードではない')
                        );
                        break;
                    case 'network_error':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && (f.lastError.includes('ネットワーク') || 
                                          f.lastError.includes('Network') ||
                                          f.lastError.includes('HTTP'))
                        );
                        break;
                    case 'restricted':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && f.lastError.includes('アクセス制限')
                        );
                        break;
                    case 'stopped':
                        filteredFeeds = filteredFeeds.filter(f => !f.active);
                        break;
                }
            }
            
            // 検索フィルタ
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredFeeds = filteredFeeds.filter(f => 
                    f.name.toLowerCase().includes(searchTerm) ||
                    f.url.toLowerCase().includes(searchTerm) ||
                    (f.category && f.category.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredFeeds.length === 0) {
                feedList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📡</div>
                        <div class="empty-state-text">フィードが見つかりません</div>
                    </div>
                `;
                return;
            }
            
            feedList.innerHTML = filteredFeeds.map(feed => {
                // ステータス表示のロジックを改善
                let statusDisplay = '';
                if (feed.fetchError) {
                    // エラーがある場合
                    statusDisplay = '❌ エラー';
                } else if (!feed.active) {
                    // 停止中の場合
                    statusDisplay = '⏸️ 停止中';
                } else {
                    // 正常にアクティブな場合
                    statusDisplay = '✅ 正常';
                }
                
                // URLからホームページURLを推定
                let homepageUrl = '';
                try {
                    const url = new URL(feed.url);
                    homepageUrl = `${url.protocol}//${url.hostname}`;
                } catch (e) {
                    homepageUrl = feed.url;
                }
                
                return `
                <div class="feed-item">
                    <div class="feed-info">
                        <div class="feed-name">${feed.name}</div>
                        <div class="feed-url">
                            <div style="margin-bottom: 3px;">
                                <span style="color: #666; font-size: 0.85em;">🏠 ホーム:</span>
                                <a href="${homepageUrl}" target="_blank" rel="noopener noreferrer" style="color: #4caf50; text-decoration: none; margin-left: 5px;">
                                    ${homepageUrl}
                                </a>
                            </div>
                            <div>
                                <span style="color: #666; font-size: 0.85em;">📡 RSS:</span>
                                <a href="${feed.url}" target="_blank" rel="noopener noreferrer" style="color: #1976d2; text-decoration: none; margin-left: 5px;">
                                    ${feed.url}
                                </a>
                            </div>
                        </div>
                        <div class="feed-meta">
                            ${feed.category ? `<span class="feed-category">${feed.category}</span>` : ''}
                            ${feed.feedFormat ? `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 3px; font-weight: bold;">📋 ${feed.feedFormat}</span>` : ''}
                            <span>最終更新: ${new Date(feed.lastUpdate).toLocaleString('ja-JP')}</span>
                            <span>ステータス: ${statusDisplay}</span>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-weight: bold;">📊 記事数: <span id="articleCount-${feed.id}">読込中...</span></span>
                            ${feed.fetchError ? `
                                <span class="feed-error-badge" title="${feed.lastError || '取得エラーが発生しました'}">⚠️ ${feed.lastError || '取得エラー'}</span>
                                ${(feed.lastError && (
                                    feed.lastError.includes('有効なRSSフィードではない') ||
                                    feed.lastError.includes('HTMLページが返されました') ||
                                    feed.lastError.includes('HTTP') ||
                                    feed.lastError.includes('Network') ||
                                    feed.lastError.includes('エラー')
                                )) ? `
                                    <button class="btn btn-small btn-success" onclick="findAlternativeRSS(${feed.id}, '${feed.name.replace(/'/g, "\\'")}')"
                                            style="margin-left: 10px; font-size: 11px; padding: 3px 8px;" 
                                            title="AIが代替RSSを探します">
                                        🤖 代替を探す
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    </div>
                    <div class="feed-actions">
                        <button class="btn btn-small btn-primary" onclick="testFeed('${feed.url}', ${feed.id})">テスト</button>
                        <button class="btn btn-small btn-secondary" onclick="toggleFeed(${feed.id})">
                            ${feed.active ? '停止' : '開始'}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="removeFeed(${feed.id})">削除</button>
                    </div>
                </div>
            `}).join('');
            
            updateStats();
            
            // 各フィードの記事数を取得
            updateArticleCounts(filteredFeeds);
        }
        
        // 記事数を取得して表示
        async function updateArticleCounts(feeds) {
            if (!db) return;
            
            for (const feed of feeds) {
                try {
                    const transaction = db.transaction(['articles'], 'readonly');
                    const store = transaction.objectStore('articles');
                    const index = store.index('feedId');
                    const countRequest = index.count(feed.id);
                    
                    countRequest.onsuccess = () => {
                        const count = countRequest.result;
                        const countElement = document.getElementById(`articleCount-${feed.id}`);
                        if (countElement) {
                            countElement.textContent = count || 0;
                        }
                    };
                } catch (error) {
                    // IndexedDBが使えない場合は0を表示
                    const countElement = document.getElementById(`articleCount-${feed.id}`);
                    if (countElement) {
                        countElement.textContent = '0';
                    }
                }
            }
        }

        // 統計更新
        async function updateStats() {
            const feeds = await getAllFeeds();
            document.getElementById('totalFeeds').textContent = feeds.length;
            document.getElementById('activeFeeds').textContent = feeds.filter(f => f.active && !f.fetchError).length;
            
            // ヘッダーの件数バッジも更新
            const feedCountBadge = document.getElementById('feedCountBadge');
            if (feedCountBadge) {
                feedCountBadge.textContent = `(${feeds.length}件)`;
            }
            
            // エラー数を表示（フィルターに反映）
            const errorCount = feeds.filter(f => f.fetchError).length;
            const errorFilter = document.getElementById('errorFilter');
            if (errorFilter) {
                // エラー数をオプションテキストに表示
                errorFilter.options[2].text = `❌ エラーのみ (${errorCount})`;
                
                // 各エラータイプの数を計算
                const htmlErrors = feeds.filter(f => f.lastError && f.lastError.includes('HTMLページ')).length;
                const invalidFeeds = feeds.filter(f => f.lastError && f.lastError.includes('有効なRSSフィードではない')).length;
                const networkErrors = feeds.filter(f => f.lastError && (f.lastError.includes('ネットワーク') || f.lastError.includes('HTTP'))).length;
                const restrictedSites = feeds.filter(f => f.lastError && f.lastError.includes('アクセス制限')).length;
                const stoppedFeeds = feeds.filter(f => !f.active).length;
                
                if (htmlErrors > 0) errorFilter.options[3].text = `📄 HTMLエラー (${htmlErrors})`;
                if (invalidFeeds > 0) errorFilter.options[4].text = `⚠️ 無効なRSS (${invalidFeeds})`;
                if (networkErrors > 0) errorFilter.options[5].text = `🌐 ネットワークエラー (${networkErrors})`;
                if (restrictedSites > 0) errorFilter.options[6].text = `🔒 アクセス制限 (${restrictedSites})`;
                if (stoppedFeeds > 0) errorFilter.options[7].text = `⏸️ 停止中 (${stoppedFeeds})`;
            }
            
            const categories = [...new Set(feeds.map(f => f.category).filter(c => c))];
            document.getElementById('categoryCount').textContent = categories.length;
            
            // カテゴリフィルター更新
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = `
                <span class="category-tag active" data-category="all" onclick="filterByCategory('all')">すべて</span>
                ${categories.map(cat => 
                    `<span class="category-tag" data-category="${cat}" onclick="filterByCategory('${cat}')">${cat}</span>`
                ).join('')}
            `;
            
            // 最終更新時刻
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // カテゴリフィルター
        function filterByCategory(category) {
            document.querySelectorAll('.category-tag').forEach(tag => {
                tag.classList.remove('active');
                if (tag.dataset.category === category) {
                    tag.classList.add('active');
                }
            });
            displayFeeds(category);
        }

        // フィード追加フォーム
        document.getElementById('addFeedForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const feed = {
                name: document.getElementById('feedName').value,
                url: document.getElementById('feedUrl').value,
                category: document.getElementById('feedCategory').value
            };
            
            try {
                await addFeed(feed);
                e.target.reset();
                displayFeeds();
                showToast('フィードを追加しました', 'success');
            } catch (error) {
                showToast('エラー: ' + error.message, 'error');
            }
        });

        // 検索
        document.getElementById('searchInput').addEventListener('input', () => {
            displayFeeds(document.querySelector('.category-tag.active').dataset.category);
        });

        // フィード削除
        async function removeFeed(id) {
            if (confirm('このフィードを削除しますか？')) {
                await deleteFeed(id);
                displayFeeds();
            }
        }

        // フィード有効/無効切り替え
        async function toggleFeed(id) {
            const feeds = await getAllFeeds();
            const feed = feeds.find(f => f.id === id);
            if (feed) {
                feed.active = !feed.active;
                await updateFeed(feed);
                displayFeeds();
            }
        }

        // フィードテスト（エラー詳細情報を表示 + エラーハンドリング統合）
        async function testFeed(url, feedId = null) {
            await Logger.info(`Testing feed: ${url}`, { context: 'testFeed', feedId });
            // 既知の問題があるドメインを特別処理
            const problematicDomains = [
                'bmbf.de', 'bsi.bund.de', 'economie.gouv.fr', 
                'ssi.gouv.fr', 'inria.fr', 'enisa.europa.eu',
                'digital.canada.ca', 'nrc.canada.ca'
            ];
            
            const urlDomain = new URL(url).hostname;
            const isProblematicDomain = problematicDomains.some(domain => urlDomain.includes(domain));
            
            // 制限があるサイトの場合、代替プロキシを試す
            if (isProblematicDomain) {
                console.log(`制限付きドメイン検出: ${urlDomain}、代替方法を試します`);
                
                // 複数のプロキシサービスを試す
                const proxyServices = [
                    {
                        name: 'RSS2JSON',
                        url: `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`,
                        parseResponse: async (response) => {
                            const data = await response.json();
                            if (data.status === 'ok' && data.items) {
                                return {
                                    success: true,
                                    message: `✅ ${data.items.length}件の記事を取得（RSS2JSON経由）`,
                                    errorCode: null
                                };
                            }
                            return {
                                success: false,
                                message: '❌ 取得失敗（RSS2JSON）',
                                errorCode: 'RSS2JSON_FAILED'
                            };
                        }
                    },
                    {
                        name: 'AllOrigins',
                        url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                        parseResponse: async (response) => {
                            const data = await response.json();
                            if (data.contents && (data.contents.includes('<rss') || data.contents.includes('<feed'))) {
                                const parser = new DOMParser();
                                const xml = parser.parseFromString(data.contents, 'text/xml');
                                const items = xml.querySelectorAll('item, entry');
                                return {
                                    success: true,
                                    message: `✅ ${items.length}件の記事を取得（AllOrigins経由）`,
                                    errorCode: null
                                };
                            }
                            return {
                                success: false,
                                message: '❌ 取得失敗（AllOrigins）',
                                errorCode: 'ALLORIGINS_FAILED'
                            };
                        }
                    }
                ];
                
                // 各プロキシサービスを順番に試す
                for (const proxy of proxyServices) {
                    try {
                        console.log(`${proxy.name}を試しています...`);
                        const response = await fetch(proxy.url, {
                            mode: 'cors',
                            credentials: 'omit'
                        }).catch(err => ({ ok: false }));
                        
                        if (response.ok) {
                            const result = await proxy.parseResponse(response);
                            if (result.success) {
                                // 成功した場合、DB更新
                                if (feedId && db) {
                                    try {
                                        const transaction = db.transaction(['feeds'], 'readwrite');
                                        const store = transaction.objectStore('feeds');
                                        const feedRequest = store.get(feedId);
                                        
                                        feedRequest.onsuccess = () => {
                                            const feed = feedRequest.result;
                                            if (feed) {
                                                feed.fetchError = false;
                                                feed.lastError = null;
                                                feed.lastErrorCode = null;
                                                feed.lastChecked = new Date().toISOString();
                                                feed.proxyRequired = proxy.name; // 使用したプロキシを記録
                                                store.put(feed);
                                            }
                                        };
                                    } catch (e) {
                                        console.log('DB更新エラー:', e);
                                    }
                                }
                                
                                if (!feedId) showToast(result.message, result.success ? 'success' : 'error');
                                return result;
                            }
                        }
                    } catch (error) {
                        console.log(`${proxy.name}でエラー:`, error.message);
                    }
                }
                
                // すべてのプロキシが失敗した場合
                const errorInfo = {
                    success: false,
                    message: '⚠️ このサイトは現在アクセス制限があります\n\n代替プロキシも試しましたが、アクセスできませんでした。',
                    errorCode: 'RESTRICTED_SITE'
                };
                
                // DB更新
                if (feedId && db) {
                    try {
                        const transaction = db.transaction(['feeds'], 'readwrite');
                        const store = transaction.objectStore('feeds');
                        const feedRequest = store.get(feedId);
                        
                        feedRequest.onsuccess = () => {
                            const feed = feedRequest.result;
                            if (feed) {
                                feed.fetchError = true;
                                feed.lastError = errorInfo.message;
                                feed.lastErrorCode = errorInfo.errorCode;
                                feed.lastChecked = new Date().toISOString();
                                store.put(feed);
                            }
                        };
                    } catch (e) {
                        console.log('DB更新スキップ');
                    }
                }
                
                if (!feedId) showToast(errorInfo.message, errorInfo.success ? 'success' : 'error');
                return errorInfo;
            }
            
            // 設定済みのCloudflare Worker URLを使用
            const workerUrl = 'https://polished-snow-477a.yutapii.workers.dev';
            let errorInfo = null;
            
            try {
                // console.logを条件付きに変更（デバッグモード以外は表示しない）
                if (localStorage.getItem('debug-mode') === 'true') {
                    console.log('接続テスト開始:', url);
                }
                const testUrl = `${workerUrl}?url=${encodeURIComponent(url)}`;
                // エラーを事前にキャッチ
                let response;
                try {
                    response = await fetch(testUrl, {
                        mode: 'cors',
                        credentials: 'omit'
                    });
                } catch (fetchError) {
                    // エラーハンドラーで処理
                    await ErrorHandler.handle(fetchError, 'testFeed-fetch', { url, feedId });
                    
                    // リトライ判定
                    const recovery = await ErrorHandler.attemptRecovery(
                        ErrorHandler.classify(fetchError),
                        'testFeed-fetch',
                        { url, feedId }
                    );
                    
                    if (recovery.retry && recovery.delay) {
                        await new Promise(resolve => setTimeout(resolve, recovery.delay));
                        // リトライ
                        return testFeed(url, feedId);
                    }
                    
                    return { 
                        success: false, 
                        message: `❌ ネットワークエラー`,
                        errorCode: 'NETWORK_ERROR'
                    };
                }
                
                if (response.ok) {
                    const text = await response.text();
                    // HTMLチェック
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        errorInfo = {
                            success: false,
                            message: 'HTMLページが返されました（RSSではありません）',
                            errorCode: 'HTML_CONTENT'
                        };
                    } else if (text.includes('<rss') || text.includes('<feed') || text.includes('<item>') || text.includes('<entry>')) {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(text, 'text/xml');
                        const items = xml.querySelectorAll('item, entry');
                        
                        // フィード形式を検出
                        const feedFormat = detectFeedFormat(text);
                        
                        errorInfo = {
                            success: true,
                            message: `✅ ${items.length}件の記事を取得 (${feedFormat})`,
                            errorCode: null,
                            feedFormat: feedFormat
                        };
                        
                        // 成功をログに記録
                        await Logger.info(`Feed test successful: ${items.length} items`, {
                            context: 'testFeed',
                            url,
                            feedId,
                            feedFormat,
                            itemCount: items.length
                        });
                    } else {
                        errorInfo = {
                            success: false,
                            message: '⚠️ 有効なRSSフィードではない可能性があります',
                            errorCode: 'INVALID_FEED'
                        };
                    }
                } else {
                    errorInfo = {
                        success: false,
                        message: `❌ HTTP ${response.status}`,
                        errorCode: `HTTP_${response.status}`
                    };
                }
            } catch (firstError) {
                console.error('接続テストエラー:', firstError);
                // フォールバック: RSS2JSON
                try {
                    const fallbackUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
                    const response = await fetch(fallbackUrl, {
                        mode: 'cors',
                        credentials: 'omit'
                    }).catch(err => {
                        console.log('RSS2JSON error caught:', err.message);
                        return { ok: false, status: 0 };
                    });
                    
                    if (response.ok) {
                        try {
                            const responseData = await response.json();
                            if (responseData && responseData.status === 'ok') {
                                errorInfo = {
                                    success: true,
                                    message: `✅ ${responseData.items ? responseData.items.length : 0}件の記事を取得（RSS2JSON経由）`,
                                    errorCode: null
                                };
                            } else {
                                const errorMsg = responseData?.message || 'Unknown error';
                                errorInfo = {
                                    success: false,
                                    message: `❌ ${errorMsg}`,
                                    errorCode: 'RSS2JSON_ERROR'
                                };
                            }
                        } catch (jsonError) {
                            console.error('JSON parse error:', jsonError);
                            errorInfo = {
                                success: false,
                                message: '❌ Invalid response format',
                                errorCode: 'JSON_PARSE_ERROR'
                            };
                        }
                    } else {
                        errorInfo = {
                            success: false,
                            message: `❌ HTTP ${response.status}`,
                            errorCode: `HTTP_${response.status}`
                        };
                    }
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    errorInfo = {
                        success: false,
                        message: '❌ Network error',
                        errorCode: 'NETWORK_ERROR'
                    };
                }
            }
            
            // フィードIDが指定されていればDB更新
            if (feedId && db) {
                try {
                    const transaction = db.transaction(['feeds'], 'readwrite');
                    const store = transaction.objectStore('feeds');
                    const feedRequest = store.get(feedId);
                    
                    feedRequest.onsuccess = () => {
                        const feed = feedRequest.result;
                        if (feed) {
                            feed.fetchError = !errorInfo.success;
                            feed.lastError = errorInfo.success ? null : errorInfo.message;
                            feed.lastErrorCode = errorInfo.errorCode;
                            feed.lastChecked = new Date().toISOString();
                            // フィード形式を保存
                            if (errorInfo.feedFormat) {
                                feed.feedFormat = errorInfo.feedFormat;
                            }
                            store.put(feed);
                        }
                    };
                    
                    transaction.oncomplete = () => {
                        // トランザクション完了後にUI更新
                        displayFeeds();
                    };
                } catch (e) {
                    console.error('フィードステータス更新エラー:', e);
                }
            }
            
            // UIへのアラート表示（エラーの場合は詳細情報も含める）
            if (!errorInfo.success && errorInfo.errorCode) {
                let detailMessage = errorInfo.message;
                
                // エラーコードに応じた詳細説明を追加
                switch(errorInfo.errorCode) {
                    case 'NETWORK_ERROR':
                        detailMessage += '\n\n【エラー詳細】\nネットワーク接続を確認してください。\nプロキシやファイアウォールの設定も確認してください。';
                        break;
                    case 'HTML_CONTENT':
                        detailMessage += '\n\n【エラー詳細】\nURLがRSSフィードではなく、通常のWebページを指している可能性があります。\n正しいRSS/AtomフィードのURLか確認してください。';
                        break;
                    case 'INVALID_FEED':
                        detailMessage += '\n\n【エラー詳細】\nXML形式が正しくないか、RSS/Atomフィードの仕様に準拠していません。\nフィード提供元に問題がある可能性があります。';
                        break;
                    case 'RESTRICTED_SITE':
                        detailMessage += '\n\n【エラー詳細】\nこのサイトは地域制限またはアクセス制限があります。\nVPNを使用するか、別のRSSサービス経由でアクセスしてみてください。';
                        break;
                    case 'JSON_PARSE_ERROR':
                        detailMessage += '\n\n【エラー詳細】\nサーバーからの応答を解析できませんでした。\nフィードが一時的に利用できない可能性があります。';
                        break;
                    default:
                        if (errorInfo.errorCode.startsWith('HTTP_')) {
                            const statusCode = errorInfo.errorCode.replace('HTTP_', '');
                            detailMessage += `\n\n【エラー詳細】\nHTTPステータスコード: ${statusCode}\n`;
                            
                            // 一般的なHTTPエラーコードの説明
                            switch(statusCode) {
                                case '403':
                                    detailMessage += 'アクセスが拒否されました。認証が必要か、アクセス権限がありません。';
                                    break;
                                case '404':
                                    detailMessage += 'フィードが見つかりません。URLが正しいか確認してください。';
                                    break;
                                case '500':
                                case '502':
                                case '503':
                                    detailMessage += 'サーバー側でエラーが発生しています。時間をおいて再度お試しください。';
                                    break;
                                case '429':
                                    detailMessage += 'リクエスト制限に達しました。時間をおいて再度お試しください。';
                                    break;
                            }
                        }
                }
                
                showToast(detailMessage, 'info', 5000);
            } else {
                showToast(errorInfo.message, errorInfo.success ? 'success' : 'error');
            }
            
            return errorInfo;
        }

        // この関数は削除（「全て更新」ボタンを削除したため不要）

        // インポートモーダル
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
            
            // モーダルが開かれた時にもボタンイベントを設定
            setTimeout(() => {
                const importBtn = document.getElementById('importBtn');
                if (importBtn) {
                    // 既存のイベントリスナーを削除
                    const newImportBtn = importBtn.cloneNode(true);
                    importBtn.parentNode.replaceChild(newImportBtn, importBtn);
                    
                    // 新しいイベントリスナーを追加
                    newImportBtn.addEventListener('click', async function() {
                        console.log('インポートボタンがクリックされました（モーダル内）');
                        await performImport();
                    });
                }
            }, 100);
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importData').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').textContent = '対応形式: .txt, .csv, .tsv, .json';
            document.getElementById('filePreview').style.display = 'none';
            fileContent = '';
            currentImportTab = 'text';
            
            // タブをリセット
            document.querySelectorAll('.import-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.import-tab').classList.add('active');
            document.getElementById('textImportPanel').classList.add('active');
            document.getElementById('fileImportPanel').classList.remove('active');
        }

        // フィード一括インポート
        let fileContent = '';
        let currentImportTab = 'text';
        
        async function performImport() {
            try {
                console.log('インポート開始');
                console.log('currentImportTab:', currentImportTab);
                console.log('fileContent length:', fileContent.length);
                
                // DBを強制的に初期化（既存の状態に関わらず）
                console.log('DBを初期化中...');
                try {
                    await initDB();
                    console.log('DB初期化完了, db=', db);
                } catch (dbError) {
                    console.error('DB初期化エラー:', dbError);
                    showToast('データベースの初期化に失敗しました。ページをリロードしてください。', 'error', 5000);
                    return;
                }
                
                let data;
                if (currentImportTab === 'text') {
                    data = document.getElementById('importData').value;
                } else {
                    data = fileContent;
                }
                
                if (!data || !data.trim()) {
                    showToast('インポートするデータがありません', 'warning');
                    return;
                }
                
                await importFeeds(data);
                
            } catch (error) {
                console.error('performImport エラー:', error);
                showToast('インポート処理中にエラーが発生しました: ' + error.message, 'error', 5000);
            }
        }
        
        async function importFeeds(data) {
            console.log('importFeeds called with data length:', data.length);
            
            // DBの確認
            if (!db) {
                console.log('importFeeds: DBが未初期化のため再初期化');
                await initDB();
            }
            
            const lines = data.trim().split('\n');
            let imported = 0;
            let skipped = 0;
            let errors = [];
            
            // 既存のフィードを取得して重複チェック用
            let existingFeeds = [];
            let existingUrls = [];
            
            try {
                existingFeeds = await getAllFeeds();
                existingUrls = existingFeeds.map(f => f.url.toLowerCase());
                console.log('既存フィード数:', existingFeeds.length);
            } catch (e) {
                console.error('既存フィード取得エラー:', e);
                existingFeeds = [];
                existingUrls = [];
            }
            
            // JSON形式の場合の処理
            if (isJsonFormat(data)) {
                try {
                    const jsonData = JSON.parse(data);
                    const result = await importJsonFeeds(jsonData, existingUrls);
                    imported = result.imported;
                    skipped = result.skipped;
                    errors = result.errors;
                } catch (e) {
                    errors.push(`JSONパースエラー: ${e.message}`);
                }
            } else {
                // テキスト形式の処理
                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    let parts;
                    // CSVまたはTSVの場合
                    if (line.includes('\t')) {
                        parts = line.split('\t');
                    } else if (line.includes(',') && !line.includes('|')) {
                        // CSVの場合（カンマ区切り）
                        parts = parseCSVLine(line);
                    } else {
                        // パイプ区切り（デフォルト）
                        parts = line.split('|');
                    }
                    
                    if (parts.length >= 2) {
                        const feedUrl = parts[1].trim();
                        
                        // URL検証
                        try {
                            new URL(feedUrl);
                        } catch (e) {
                            errors.push(`無効なURL: ${feedUrl}`);
                            continue;
                        }
                        
                        // 重複チェック
                        if (existingUrls.includes(feedUrl.toLowerCase())) {
                            skipped++;
                            continue;
                        }
                        
                        const feed = {
                            name: parts[0].trim(),
                            url: feedUrl,
                            category: parts[2] ? parts[2].trim() : 'その他'
                        };
                        
                        try {
                            await addFeed(feed);
                            imported++;
                            existingUrls.push(feedUrl.toLowerCase());
                        } catch (error) {
                            console.error('Import error:', error);
                            errors.push(`インポートエラー: ${feed.name}`);
                        }
                    }
                }
            }
            
            closeImportModal();
            
            // インポート成功後にフィード一覧を更新
            await displayFeeds();
            
            let message = `✅ ${imported}個のフィードをインポートしました`;
            if (skipped > 0) {
                message += `\n⚠️ ${skipped}個は既に登録済みのためスキップ`;
            }
            if (errors.length > 0) {
                message += `\n❌ エラー: ${errors.length}個\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    message += `\n...他${errors.length - 5}個のエラー`;
                }
            }
            
            console.log('インポート完了:', message);
            showToast(message, 'success', 5000);
            
            // ページをリロードして最新状態を表示
            if (imported > 0) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }
        
        // JSON形式かどうかを判定
        function isJsonFormat(data) {
            const trimmed = data.trim();
            return (trimmed.startsWith('{') && trimmed.endsWith('}')) || 
                   (trimmed.startsWith('[') && trimmed.endsWith(']'));
        }
        
        // JSONフィードのインポート処理
        async function importJsonFeeds(jsonData, existingUrlsArray) {
            let imported = 0;
            let skipped = 0;
            let errors = [];
            
            // existingUrlsを配列のコピーとして作成（元の配列を変更しないため）
            const existingUrls = [...existingUrlsArray];
            
            // フラットなフィード配列を作成
            let feedsToImport = [];
            
            console.log('JSONデータ構造:', jsonData); // デバッグログ
            
            // v4形式のJSON構造に対応（ネストされたカテゴリ構造）
            if (jsonData.feeds && Array.isArray(jsonData.feeds)) {
                console.log('v4形式を検出');
                for (const categoryGroup of jsonData.feeds) {
                    const category = categoryGroup.category || 'その他';
                    if (categoryGroup.feeds && Array.isArray(categoryGroup.feeds)) {
                        for (const feed of categoryGroup.feeds) {
                            feedsToImport.push({
                                name: feed.name || feed.title || '無題',
                                url: feed.url || feed.link || '',
                                category: category,
                                description: feed.description || '',
                                tags: feed.tags || [],
                                priority: feed.priority || 'normal',
                                language: feed.language || 'ja'
                            });
                        }
                    }
                }
            }
            // フラット配列形式のJSON
            else if (Array.isArray(jsonData)) {
                console.log('配列形式を検出');
                feedsToImport = jsonData.map(feed => ({
                    name: feed.name || feed.title || '無題',
                    url: feed.url || feed.link || '',
                    category: feed.category || 'その他',
                    description: feed.description || ''
                }));
            }
            // 単一オブジェクト形式
            else if (jsonData.name && jsonData.url) {
                console.log('単一オブジェクト形式を検出');
                feedsToImport = [{
                    name: jsonData.name,
                    url: jsonData.url,
                    category: jsonData.category || 'その他'
                }];
            }
            
            console.log(`インポート対象: ${feedsToImport.length}件`);
            
            // 各フィードをインポート
            for (const feedData of feedsToImport) {
                if (!feedData.url) {
                    errors.push(`URLが空: ${feedData.name}`);
                    continue;
                }
                
                // URL検証
                try {
                    new URL(feedData.url);
                } catch (e) {
                    errors.push(`無効なURL: ${feedData.url}`);
                    continue;
                }
                
                // 重複チェック
                if (existingUrls.includes(feedData.url.toLowerCase())) {
                    skipped++;
                    console.log(`重複スキップ: ${feedData.name}`);
                    continue;
                }
                
                const feed = {
                    name: feedData.name,
                    url: feedData.url,
                    category: feedData.category
                };
                
                // 追加のメタデータがあれば保存
                if (feedData.description) feed.description = feedData.description;
                if (feedData.tags) feed.tags = feedData.tags;
                if (feedData.priority) feed.priority = feedData.priority;
                if (feedData.language) feed.language = feedData.language;
                
                try {
                    await addFeed(feed);
                    imported++;
                    existingUrls.push(feedData.url.toLowerCase());
                    console.log(`インポート成功: ${feedData.name}`);
                } catch (error) {
                    console.error('Import error for', feedData.name, ':', error);
                    // エラーの詳細を記録
                    const errorMsg = error?.message || error?.toString() || '不明なエラー';
                    errors.push(`${feedData.name}: ${errorMsg}`);
                }
            }
            
            console.log(`結果: 成功=${imported}, スキップ=${skipped}, エラー=${errors.length}`);
            return { imported, skipped, errors };
        }
        
        // CSV行のパース（カンマ区切り、引用符対応）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(s => s.replace(/^"|"$/g, ''));
        }
        
        // タブ切り替え
        function switchImportTab(tab) {
            currentImportTab = tab;
            
            // タブボタンの状態を更新
            document.querySelectorAll('.import-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // パネルの表示を切り替え
            document.getElementById('textImportPanel').classList.toggle('active', tab === 'text');
            document.getElementById('fileImportPanel').classList.toggle('active', tab === 'file');
        }
        
        // ファイル選択ハンドラ
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                fileContent = '';
                return;
            }
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.textContent = `選択: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            
            console.log('ファイル選択:', file.name, file.type, file.size);
            
            try {
                fileContent = await readFile(file);
                console.log('ファイル読み込み成功, サイズ:', fileContent.length);
                showFilePreview(fileContent);
            } catch (error) {
                console.error('ファイル読み込みエラー:', error);
                showToast('ファイルの読み込みに失敗しました: ' + error.message, 'error');
                fileContent = '';
            }
        }
        
        // ファイル読み込み
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('ファイル読み込みエラー'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ファイルプレビュー表示
        async function showFilePreview(content) {
            const previewContainer = document.getElementById('filePreview');
            const preview = document.getElementById('fileImportPreview');
            
            if (!content.trim()) {
                previewContainer.style.display = 'none';
                return;
            }
            
            const lines = content.trim().split('\n').slice(0, 10); // 最初の10行を表示
            const existingFeeds = await getAllFeeds();
            const existingUrls = existingFeeds.map(f => f.url.toLowerCase());
            
            let previewHtml = '';
            let validCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;
            
            // JSON形式の場合の処理
            if (isJsonFormat(content)) {
                try {
                    const jsonData = JSON.parse(content);
                    
                    // プレビュー用のフィード配列を作成（実際のインポートはしない）
                    const feedsToShow = [];
                    let allFeeds = [];
                    
                    // v4形式のJSON構造を解析
                    if (jsonData.feeds && Array.isArray(jsonData.feeds)) {
                        for (const categoryGroup of jsonData.feeds) {
                            const category = categoryGroup.category || 'その他';
                            if (categoryGroup.feeds && Array.isArray(categoryGroup.feeds)) {
                                for (const feed of categoryGroup.feeds) {
                                    allFeeds.push({
                                        name: feed.name || feed.title || '無題',
                                        url: feed.url || feed.link || '',
                                        category: category
                                    });
                                }
                            }
                        }
                    }
                    // フラット配列形式
                    else if (Array.isArray(jsonData)) {
                        allFeeds = jsonData.map(feed => ({
                            name: feed.name || feed.title || '無題',
                            url: feed.url || feed.link || '',
                            category: feed.category || 'その他'
                        }));
                    }
                    // 単一オブジェクト形式
                    else if (jsonData.name && jsonData.url) {
                        allFeeds = [{
                            name: jsonData.name,
                            url: jsonData.url,
                            category: jsonData.category || 'その他'
                        }];
                    }
                    
                    // 統計情報を計算
                    for (const feed of allFeeds) {
                        if (!feed.url) {
                            errorCount++;
                            continue;
                        }
                        
                        try {
                            new URL(feed.url);
                            if (existingUrls.includes(feed.url.toLowerCase())) {
                                duplicateCount++;
                            } else {
                                validCount++;
                            }
                        } catch (e) {
                            errorCount++;
                        }
                    }
                    
                    // プレビュー表示（最初の10件）
                    for (const feed of allFeeds.slice(0, 10)) {
                        const url = feed.url;
                        let className = 'success';
                        let status = '✅ 新規';
                        
                        if (!url) {
                            className = 'error';
                            status = '❌ URLなし';
                        } else {
                            try {
                                new URL(url);
                                if (existingUrls.includes(url.toLowerCase())) {
                                    className = 'duplicate';
                                    status = '⚠️ 重複';
                                }
                            } catch (e) {
                                className = 'error';
                                status = '❌ 無効';
                            }
                        }
                        
                        previewHtml += `
                            <div class="import-preview-item ${className}">
                                ${status} | ${feed.name} | ${feed.category}
                            </div>
                        `;
                    }
                    
                    if (allFeeds.length > 10) {
                        previewHtml += `<div style="text-align: center; color: #666; margin-top: 10px;">... 他 ${allFeeds.length - 10} 件のフィード</div>`;
                    }
                    
                } catch (e) {
                    previewHtml += `
                        <div class="import-preview-item error">
                            ❌ JSONパースエラー: ${e.message}
                        </div>
                    `;
                    errorCount++;
                }
            } else {
                // テキスト形式の処理
                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    let parts;
                    if (line.includes('\t')) {
                        parts = line.split('\t');
                    } else if (line.includes(',') && !line.includes('|')) {
                        parts = parseCSVLine(line);
                    } else {
                        parts = line.split('|');
                    }
                    
                    if (parts.length >= 2) {
                    const url = parts[1].trim();
                    let className = 'success';
                    let status = '✅ 新規';
                    
                    try {
                        new URL(url);
                        if (existingUrls.includes(url.toLowerCase())) {
                            className = 'duplicate';
                            status = '⚠️ 重複';
                            duplicateCount++;
                        } else {
                            validCount++;
                        }
                    } catch (e) {
                        className = 'error';
                        status = '❌ 無効';
                        errorCount++;
                    }
                    
                    previewHtml += `
                        <div class="import-preview-item ${className}">
                            ${status} | ${parts[0].trim()} | ${url}
                        </div>
                    `;
                    } else {
                        previewHtml += `
                            <div class="import-preview-item error">
                                ❌ 無効な形式: ${line.substring(0, 50)}...
                            </div>
                        `;
                        errorCount++;
                    }
                }
            }
            
            const totalLines = content.trim().split('\n').length;
            if (totalLines > 10) {
                previewHtml += `<div style="text-align: center; color: #666; margin-top: 10px;">... 他 ${totalLines - 10} 行</div>`;
            }
            
            previewHtml = `
                <div style="margin-bottom: 10px; font-weight: bold;">
                    ✅ 新規: ${validCount} | ⚠️ 重複: ${duplicateCount} | ❌ エラー: ${errorCount}
                </div>
                ${previewHtml}
            `;
            
            preview.innerHTML = previewHtml;
            previewContainer.style.display = 'block';
        }

        // エクスポートオプション表示
        function showExportOptions() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>📤 エクスポート設定</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="exportWithStatus" checked>
                            ステータス情報を含める
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="exportOnlyActive">
                            正常なフィードのみエクスポート
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="exportWithErrors" checked>
                            エラー詳細を含める
                        </label>
                    </div>
                    <div style="text-align: right;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">キャンセル</button>
                        <button class="btn btn-success" onclick="exportFeeds()" style="margin-left: 10px;">エクスポート</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // エクスポート実行
        async function exportFeeds() {
            const feeds = await getAllFeeds();
            const withStatus = document.getElementById('exportWithStatus')?.checked ?? true;
            const onlyActive = document.getElementById('exportOnlyActive')?.checked ?? false;
            const withErrors = document.getElementById('exportWithErrors')?.checked ?? true;
            
            let filteredFeeds = feeds;
            if (onlyActive) {
                filteredFeeds = feeds.filter(f => f.active && !f.fetchError);
            }
            
            let exportData = '';
            
            if (withStatus || withErrors) {
                // 詳細フォーマット（JSON）
                const exportObj = {
                    exportDate: new Date().toISOString(),
                    totalCount: filteredFeeds.length,
                    feeds: filteredFeeds.map(f => {
                        const feedData = {
                            name: f.name,
                            url: f.url,
                            category: f.category || ''
                        };
                        
                        if (withStatus) {
                            feedData.active = f.active;
                            feedData.lastUpdate = f.lastUpdate;
                            feedData.lastChecked = f.lastChecked || null;
                        }
                        
                        if (withErrors && f.fetchError) {
                            feedData.error = {
                                hasError: true,
                                message: f.lastError || 'エラー詳細なし',
                                errorCode: f.lastErrorCode || 'UNKNOWN'
                            };
                        }
                        
                        return feedData;
                    })
                };
                exportData = JSON.stringify(exportObj, null, 2);
                
                const blob = new Blob([exportData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rss-feeds-detailed-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // シンプルフォーマット（テキスト）
                exportData = filteredFeeds.map(f => `${f.name}|${f.url}|${f.category || ''}`).join('\n');
                
                const blob = new Blob([exportData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rss-feeds-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            // モーダルを閉じる
            document.querySelector('.modal.active')?.remove();
            
            showToast(`${filteredFeeds.length}件のフィードをエクスポートしました`, 'success');
        }

        // AI RSS探索機能
        function showAIRSSFinder() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>🤖 AI RSS探索</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <p style="margin-bottom: 15px;">探したいサイトやトピックを入力してください：</p>
                        <textarea id="aiSearchQuery" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                  placeholder="例：\n・日本のAI関連ニュースサイト\n・量子コンピュータの最新情報\n・スタートアップ企業のブログ\n・特定のサイト名（TechCrunch Japan など）"></textarea>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <strong>💡 ヒント：</strong>
                            <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: #666;">
                                <li>具体的なサイト名を入力すると、そのサイトのRSSフィードを探します</li>
                                <li>トピックを入力すると、関連するサイトのRSSを提案します</li>
                                <li>複数のキーワードをカンマで区切って入力できます</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="aiSearchResults" style="display: none; margin: 20px 0; max-height: 300px; overflow-y: auto;"></div>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">閉じる</button>
                        <button class="btn btn-primary" onclick="searchRSSWithAI()" style="margin-left: 10px;">🔍 探索開始</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // AI RSS探索実行
        async function searchRSSWithAI() {
            const query = document.getElementById('aiSearchQuery').value.trim();
            if (!query) {
                showToast('検索キーワードを入力してください', 'warning');
                return;
            }
            
            const resultsDiv = document.getElementById('aiSearchResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="searching-animation">
                        <div class="search-icon-animated">🔍</div>
                        <div class="spinner"></div>
                    </div>
                    <div style="margin-top: 15px; color: #667eea;">
                        「${query}」に関連するRSSを探しています...
                    </div>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            // アニメーションを表示してから検索実行
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // よく知られたRSSフィードのデータベース（実際の運用では外部APIを使用）
            const knownFeeds = {
                'techcrunch': ['https://jp.techcrunch.com/feed/', 'TechCrunch Japan', 'テクノロジー'],
                'gigazine': ['https://gigazine.net/news/rss_2.0/', 'GIGAZINE', 'テクノロジー'],
                'itmedia': ['https://rss.itmedia.co.jp/rss/2.0/aiplus.xml', 'ITmedia AI+', 'AI・機械学習'],
                'zdnet': ['https://japan.zdnet.com/rss/index.rdf', 'ZDNet Japan', 'テクノロジー'],
                'cnet': ['https://japan.cnet.com/rss/index.rdf', 'CNET Japan', 'テクノロジー'],
                'publickey': ['https://www.publickey1.jp/atom.xml', 'Publickey', 'テクノロジー'],
                'gihyo': ['https://gihyo.jp/feed/rss2', '技術評論社', 'テクノロジー'],
                'atmarkit': ['https://rss.itmedia.co.jp/rss/2.0/ait.xml', '@IT', 'テクノロジー'],
                'wired': ['https://wired.jp/rssfeeder/', 'WIRED.jp', 'テクノロジー'],
                'engadget': ['https://japanese.engadget.com/rss.xml', 'Engadget 日本版', 'ガジェット'],
                'lifehacker': ['https://www.lifehacker.jp/index.xml', 'ライフハッカー', 'ライフスタイル'],
                'business': ['https://www.businessinsider.jp/feed/index.xml', 'Business Insider Japan', 'ビジネス'],
                'newspicks': ['https://newspicks.com/feed', 'NewsPicks', 'ビジネス'],
                '経産省': ['https://www.meti.go.jp/news/news_rss.xml', '経済産業省', '官公庁'],
                '総務省': ['https://www.soumu.go.jp/news/news_rss.xml', '総務省', '官公庁'],
                'ai': ['https://ledge.ai/rss/', 'Ledge.ai', 'AI・機械学習'],
                'quantum': ['https://quantum.fixstars.com/feed/', 'Fixstars Quantum', '量子コンピュータ'],
                'startup': ['https://jp.startupdb.news/rss', 'STARTUP DB NEWS', 'スタートアップ']
            };
            
            // キーワードマッチング
            const queryLower = query.toLowerCase();
            const matches = [];
            
            for (const [key, value] of Object.entries(knownFeeds)) {
                if (queryLower.includes(key) || 
                    value[1].toLowerCase().includes(queryLower) ||
                    value[2].includes(query) ||
                    (query.includes('AI') && value[2].includes('AI')) ||
                    (query.includes('量子') && key.includes('quantum')) ||
                    (query.includes('スタートアップ') && value[2].includes('スタートアップ'))) {
                    matches.push(value);
                }
            }
            
            // カテゴリベースの推薦
            if (query.includes('ニュース') || query.includes('news')) {
                matches.push(
                    ['https://news.yahoo.co.jp/rss/topics/it.xml', 'Yahoo!ニュース IT', 'ニュース'],
                    ['https://www3.nhk.or.jp/rss/news/cat7.xml', 'NHK 科学・IT', 'ニュース']
                );
            }
            
            if (query.includes('ブログ') || query.includes('blog')) {
                matches.push(
                    ['https://blog.google/rss/', 'Google Blog', 'ブログ'],
                    ['https://aws.amazon.com/jp/blogs/news/feed/', 'AWS News Blog', 'クラウド']
                );
            }
            
            // 結果表示
            if (matches.length > 0) {
                let html = `
                    <h3 style="margin-bottom: 15px;">🎯 見つかったRSSフィード（${matches.length}件）</h3>
                    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                `;
                
                for (const [url, name, category] of matches) {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${name}</strong> 
                                <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-left: 10px;">${category}</span>
                                <div style="color: #666; font-size: 0.85em; margin-top: 5px;">${url}</div>
                            </div>
                            <button class="btn btn-small btn-primary" onclick="addAISuggestedFeed('${name}', '${url}', '${category}')">追加</button>
                        </div>
                    `;
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px;">😔</div>
                        <div>該当するRSSフィードが見つかりませんでした</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">別のキーワードで試してみてください</div>
                    </div>
                `;
            }
        }
        
        // エラー発生時の代替RSS探索
        async function findAlternativeRSS(feedId, feedName) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>🤖 代替RSS探索</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <p style="margin-bottom: 15px;">
                            <strong>${feedName}</strong> のRSSが取得できません。<br>
                            代替のRSS URLを探しています...
                        </p>
                        <div id="alternativeResults" style="text-align: center; padding: 20px;">
                            <div class="searching-animation">
                                <div class="search-icon-animated">🔍</div>
                                <div class="spinner"></div>
                                <div class="dots-container">
                                    <div class="pulse-dot"></div>
                                    <div class="pulse-dot"></div>
                                    <div class="pulse-dot"></div>
                                </div>
                            </div>
                            <div class="search-status">
                                <div id="searchStatusText">代替RSSを探索中...</div>
                                <div class="search-progress">
                                    <div class="search-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 遅延実行でモーダル表示後に探索開始
            setTimeout(() => searchAlternativeFeeds(feedId, feedName), 100);
        }
        
        // 代替RSSの探索実行
        async function searchAlternativeFeeds(feedId, feedName) {
            const resultsDiv = document.getElementById('alternativeResults');
            const statusText = document.getElementById('searchStatusText');
            
            // ステータス更新関数
            const updateStatus = (message) => {
                if (statusText) {
                    statusText.textContent = message;
                }
            };
            
            // 現在のフィード情報を取得
            const feeds = await getAllFeeds();
            const currentFeed = feeds.find(f => f.id === feedId);
            const currentUrl = currentFeed ? currentFeed.url : '';
            
            // URLからドメインを抽出
            let domain = '';
            try {
                const urlObj = new URL(currentUrl);
                domain = urlObj.hostname;
            } catch (e) {
                // URLが無効な場合はフィード名から推測
            }
            
            // サイト名からキーワードを抽出
            const keywords = feedName.toLowerCase()
                .replace(/日本版|日本|japan|jp/gi, '')
                .replace(/rss|feed|news|ニュース/gi, '')
                .trim();
            
            // 代替候補のパターン
            const alternativePatterns = {
                // サイト名から一般的なRSS URLパターンを生成
                'techcrunch': [
                    'https://jp.techcrunch.com/feed/',
                    'https://techcrunch.com/feed/',
                    'https://jp.techcrunch.com/rss',
                    'https://techcrunch.com/category/artificial-intelligence/feed/'
                ],
                'gigazine': [
                    'https://gigazine.net/news/rss_2.0/',
                    'https://gigazine.net/news/rss_1.0/',
                    'https://gigazine.net/feed/'
                ],
                'itmedia': [
                    'https://rss.itmedia.co.jp/rss/2.0/aiplus.xml',
                    'https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml',
                    'https://rss.itmedia.co.jp/rss/2.0/it.xml',
                    'https://www.itmedia.co.jp/rss/index.html'
                ],
                'zdnet': [
                    'https://japan.zdnet.com/rss/index.rdf',
                    'https://japan.zdnet.com/rss/news/index.rdf',
                    'https://feeds.japan.zdnet.com/rss/zdnet/all.rdf'
                ],
                'cnet': [
                    'https://japan.cnet.com/rss/index.rdf',
                    'https://feeds.japan.cnet.com/rss/cnet/all.rdf',
                    'https://japan.cnet.com/rss/'
                ],
                'wired': [
                    'https://wired.jp/rssfeeder/',
                    'https://wired.jp/feed/',
                    'https://www.wired.jp/rss/index.xml'
                ],
                'engadget': [
                    'https://japanese.engadget.com/rss.xml',
                    'https://www.engadget.com/rss.xml',
                    'https://japanese.engadget.com/feed/'
                ],
                'note': [
                    'https://note.com/api/v2/rss',
                    'https://note.mu/rss'
                ],
                'qiita': [
                    'https://qiita.com/popular-items/feed',
                    'https://qiita.com/tags/ai/feed',
                    'https://qiita.com/tags/machinelearning/feed'
                ],
                'zenn': [
                    'https://zenn.dev/feed',
                    'https://zenn.dev/topics/ai/feed',
                    'https://zenn.dev/topics/machinelearning/feed'
                ]
            };
            
            // マッチする代替候補を探す
            let alternatives = [];
            let matched = false;
            
            for (const [key, urls] of Object.entries(alternativePatterns)) {
                if (keywords.includes(key) || feedName.toLowerCase().includes(key)) {
                    matched = true;
                    // 各URLをテスト
                    for (const url of urls) {
                        alternatives.push({
                            url: url,
                            name: `${feedName} (代替${alternatives.length + 1})`,
                            status: 'testing'
                        });
                    }
                    break;
                }
            }
            
            // マッチしない場合は一般的なURLパターンを試す
            if (!matched) {
                // 現在のドメインがある場合はそれを使用
                if (domain) {
                    // よく使われるRSSパス
                    const commonPaths = [
                        '/feed/', '/feeds/', '/rss/', '/rss',
                        '/rss.xml', '/feed.xml', '/atom.xml', '/index.xml',
                        '/index.rdf', '/rss2.xml', '/rss1.xml',
                        '/blog/feed/', '/news/feed/', '/articles/feed/',
                        '/posts/feed/', '/feed/rss/', '/feed/atom/',
                        '/?feed=rss2', '/?feed=rss', '/?feed=atom',
                        '/api/rss', '/api/feed', '/api/v1/rss',
                        '/en/feed/', '/ja/feed/', '/jp/feed/',
                        '/feeds/all.atom.xml', '/feeds/news.xml'
                    ];
                    
                    for (const path of commonPaths) {
                        alternatives.push({
                            url: `https://${domain}${path}`,
                            name: `${domain}${path}`,
                            priority: path.includes('feed') || path.includes('rss') ? 1 : 2
                        });
                    }
                    
                    // サブドメインも試す
                    if (!domain.startsWith('www.')) {
                        alternatives.push(
                            { url: `https://www.${domain}/feed/`, name: `www.${domain}/feed/`, priority: 2 },
                            { url: `https://www.${domain}/rss/`, name: `www.${domain}/rss/`, priority: 2 }
                        );
                    }
                    
                    // 言語別パスも試す（ENISAなど国際機関向け）
                    if (domain.includes('.eu') || domain.includes('.europa')) {
                        alternatives.push(
                            { url: `https://${domain}/rss-feeds`, name: `${domain}/rss-feeds`, priority: 1 },
                            { url: `https://${domain}/news/rss`, name: `${domain}/news/rss`, priority: 1 },
                            { url: `https://${domain}/media/news-items/RSS`, name: `${domain}/media/news-items/RSS`, priority: 2 }
                        );
                    }
                } else {
                    // ドメインがない場合はキーワードから推測
                    const possibleDomains = [
                        keywords.replace(/\s+/g, '') + '.com',
                        keywords.replace(/\s+/g, '') + '.jp',
                        keywords.replace(/\s+/g, '') + '.net',
                        keywords.replace(/\s+/g, '') + '.org',
                        keywords.replace(/\s+/g, '') + '.io'
                    ];
                    
                    for (const d of possibleDomains.slice(0, 2)) { // 最初の2つだけ試す
                        alternatives.push(
                            { url: `https://${d}/feed/`, name: `${d}/feed/`, priority: 3 },
                            { url: `https://${d}/rss/`, name: `${d}/rss/`, priority: 3 }
                        );
                    }
                }
                
                // 優先度でソート
                alternatives.sort((a, b) => (a.priority || 999) - (b.priority || 999));
            }
            
            // 結果表示
            if (alternatives.length > 0) {
                let html = `
                    <h3 style="margin-bottom: 15px;">🎯 代替候補（${alternatives.length}件）</h3>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                `;
                
                // 各URLをテスト
                const totalTests = Math.min(alternatives.length, 10);
                let testedCount = 0;
                
                for (const alt of alternatives.slice(0, totalTests)) {
                    testedCount++;
                    updateStatus(`テスト中 (${testedCount}/${totalTests}): ${alt.name || alt.url}`);
                    
                    const testResult = await testFeedQuick(alt.url);
                    
                    if (testResult.success) {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #e8f5e9;">
                                <div>
                                    <div style="color: #2e7d32; font-weight: bold;">✅ ${alt.name || alt.url}</div>
                                    <div style="color: #666; font-size: 0.85em; margin-top: 5px;">${alt.url}</div>
                                    <div style="color: #4caf50; font-size: 0.85em;">${testResult.message}</div>
                                </div>
                                <button class="btn btn-small btn-primary" onclick="replaceRSSUrl(${feedId}, '${alt.url}')"
                                        title="このURLに置き換え">
                                    置き換え
                                </button>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; opacity: 0.5;">
                                <div style="color: #999;">❌ ${alt.name || alt.url}</div>
                                <div style="color: #999; font-size: 0.85em;">${testResult.message}</div>
                            </div>
                        `;
                    }
                }
                
                html += `
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <strong>💡 ヒント：</strong>
                        <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: #666;">
                            <li>緑色の候補は正常に動作しているRSSフィードです</li>
                            <li>「置き換え」をクリックすると、現在のURLを新しいURLに更新します</li>
                            <li>表示されていない場合は、手動で正しいURLを入力してください</li>
                        </ul>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
            } else {
                // アニメーションを停止して結果表示
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px; animation: pulse 2s ease-in-out;">😔</div>
                        <div>代替RSSが見つかりませんでした</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            サイトの公式ページからRSSリンクを探してみてください
                        </div>
                    </div>
                `;
            }
        }
        
        // クイックRSSテスト（タイムアウト付き）
        async function testFeedQuick(url) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒タイムアウト
                
                const workerUrl = 'https://polished-snow-477a.yutapii.workers.dev';
                const testUrl = `${workerUrl}?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(testUrl, {
                    mode: 'cors',
                    credentials: 'omit',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('<rss') || text.includes('<feed') || text.includes('<item>') || text.includes('<entry>')) {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(text, 'text/xml');
                        const items = xml.querySelectorAll('item, entry');
                        return {
                            success: true,
                            message: `${items.length}件の記事を検出`
                        };
                    }
                }
                
                return {
                    success: false,
                    message: `HTTP ${response.status}`
                };
            } catch (error) {
                return {
                    success: false,
                    message: error.name === 'AbortError' ? 'タイムアウト' : 'エラー'
                };
            }
        }
        
        // RSS URLの置き換え
        async function replaceRSSUrl(feedId, newUrl) {
            if (!confirm(`RSS URLを\n${newUrl}\nに置き換えますか？`)) {
                return;
            }
            
            try {
                const feeds = await getAllFeeds();
                const feed = feeds.find(f => f.id === feedId);
                
                if (feed) {
                    feed.url = newUrl;
                    feed.fetchError = false;
                    feed.lastError = null;
                    feed.lastErrorCode = null;
                    feed.lastUpdate = new Date().toISOString();
                    
                    await updateFeed(feed);
                    
                    showToast('RSS URLを更新しました', 'success');
                    
                    // モーダルを閉じて一覧を更新
                    document.querySelector('.modal.active')?.remove();
                    await displayFeeds();
                }
            } catch (error) {
                showToast('更新に失敗しました: ' + error.message, 'error');
            }
        }
        
        // AI提案フィードの追加
        async function addAISuggestedFeed(name, url, category) {
            // 既存のフィードと重複チェック
            const existingFeeds = await getAllFeeds();
            if (existingFeeds.some(f => f.url === url)) {
                showToast('このフィードは既に登録されています', 'warning');
                return;
            }
            
            const feed = {
                name: name,
                url: url,
                category: category
            };
            
            try {
                await addFeed(feed);
                showToast('フィードを追加しました', 'success');
                
                // モーダルを閉じて一覧を更新
                document.querySelector('.modal.active')?.remove();
                await displayFeeds();
            } catch (error) {
                showToast('追加に失敗しました: ' + error.message, 'error');
            }
        }
        
        // 自動テスト機能
        function showAutoTestModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>🔄 自動テスト設定</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <h3 style="margin-bottom: 15px;">テスト対象を選択：</h3>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="all" checked>
                                <strong>全てのフィード</strong> - 登録されている全フィードをテスト
                            </label>
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="active">
                                <strong>アクティブのみ</strong> - 有効化されているフィードのみ
                            </label>
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="error">
                                <strong>エラーのみ</strong> - エラーが発生しているフィードのみ
                            </label>
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="category">
                                <strong>カテゴリ別</strong> - 特定のカテゴリのみ
                                <select id="testCategory" style="margin-left: 10px; padding: 5px;">
                                    <option value="">選択してください</option>
                                    <option value="テクノロジー">テクノロジー</option>
                                    <option value="ビジネス">ビジネス</option>
                                    <option value="AI・機械学習">AI・機械学習</option>
                                    <option value="スタートアップ">スタートアップ</option>
                                    <option value="官公庁">官公庁</option>
                                    <option value="その他">その他</option>
                                </select>
                            </label>
                        </div>
                        
                        <h3 style="margin: 20px 0 15px 0;">オプション：</h3>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="autoFix" checked>
                            <strong>エラーを自動修正</strong> - エラーが見つかった場合、代替RSSを自動探索
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="stopOnError">
                            <strong>エラーで停止</strong> - エラーが発生したらテストを中断
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="detailedLog" checked>
                            <strong>詳細ログ表示</strong> - テスト結果を詳細に表示
                        </label>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <strong>💡 ヒント：</strong>
                            <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: #666;">
                                <li>テストはバックグラウンドで実行されます</li>
                                <li>エラー自動修正を有効にすると、代替RSSが見つかった場合自動的にURLを更新します</li>
                                <li>テスト中でも他の操作は可能です</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="autoTestProgress" style="display: none; margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <h3 style="margin-bottom: 10px;">🎯 テスト進行中...</h3>
                        <div class="search-progress">
                            <div id="testProgressBar" class="search-progress-bar" style="width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div id="testStatusText" style="margin-top: 10px; font-size: 0.9em;"></div>
                        <div id="testResults" style="margin-top: 15px; max-height: 200px; overflow-y: auto; font-size: 0.85em;"></div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">閉じる</button>
                        <button id="startTestBtn" class="btn btn-success" onclick="startAutoTest()" style="margin-left: 10px;">
                            🚀 テスト開始
                        </button>
                        <button id="stopTestBtn" class="btn btn-danger" onclick="stopAutoTest()" style="margin-left: 10px; display: none;">
                            ⏹️ 中止
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        let autoTestRunning = false;
        let autoTestAborted = false;
        
        // 自動テスト開始
        async function startAutoTest() {
            if (autoTestRunning) return;
            
            autoTestRunning = true;
            autoTestAborted = false;
            
            // UI更新
            document.getElementById('startTestBtn').style.display = 'none';
            document.getElementById('stopTestBtn').style.display = 'inline-block';
            document.getElementById('autoTestProgress').style.display = 'block';
            
            // 設定取得
            const testTarget = document.querySelector('input[name="testTarget"]:checked').value;
            const autoFix = document.getElementById('autoFix').checked;
            const stopOnError = document.getElementById('stopOnError').checked;
            const detailedLog = document.getElementById('detailedLog').checked;
            const testCategory = document.getElementById('testCategory').value;
            
            // テスト対象フィードを取得
            let feeds = await getAllFeeds();
            let testFeeds = [];
            
            switch(testTarget) {
                case 'all':
                    testFeeds = feeds;
                    break;
                case 'active':
                    testFeeds = feeds.filter(f => f.active);
                    break;
                case 'error':
                    testFeeds = feeds.filter(f => f.fetchError);
                    break;
                case 'category':
                    if (testCategory) {
                        testFeeds = feeds.filter(f => f.category === testCategory);
                    }
                    break;
            }
            
            if (testFeeds.length === 0) {
                showToast('テスト対象のフィードがありません', 'warning');
                autoTestRunning = false;
                document.getElementById('startTestBtn').style.display = 'inline-block';
                document.getElementById('stopTestBtn').style.display = 'none';
                return;
            }
            
            // テスト実行
            const progressBar = document.getElementById('testProgressBar');
            const statusText = document.getElementById('testStatusText');
            const resultsDiv = document.getElementById('testResults');
            
            let successCount = 0;
            let errorCount = 0;
            let fixedCount = 0;
            let results = [];
            
            statusText.textContent = `テスト中... (0/${testFeeds.length})`;
            resultsDiv.innerHTML = '';
            
            for (let i = 0; i < testFeeds.length; i++) {
                if (autoTestAborted) {
                    statusText.textContent = 'テストが中断されました';
                    break;
                }
                
                const feed = testFeeds[i];
                const progress = ((i + 1) / testFeeds.length) * 100;
                progressBar.style.width = progress + '%';
                statusText.textContent = `テスト中... (${i + 1}/${testFeeds.length}) - ${feed.name}`;
                
                // テスト実行
                const result = await testFeed(feed.url, feed.id);
                
                if (result.success) {
                    successCount++;
                    if (detailedLog) {
                        resultsDiv.innerHTML += `<div style="color: green;">✅ ${feed.name}: ${result.message}</div>`;
                    }
                } else {
                    errorCount++;
                    if (detailedLog) {
                        resultsDiv.innerHTML += `<div style="color: red;">❌ ${feed.name}: ${result.message}</div>`;
                    }
                    
                    // 自動修正
                    if (autoFix && (result.errorCode === 'HTML_CONTENT' || result.errorCode === 'INVALID_FEED')) {
                        statusText.textContent = `${feed.name} の代替RSSを探索中...`;
                        
                        // 代替RSSを探す
                        const alternatives = await searchAlternativesQuietly(feed);
                        if (alternatives.length > 0) {
                            // 最初の有効な代替を使用
                            const newUrl = alternatives[0].url;
                            feed.url = newUrl;
                            feed.fetchError = false;
                            feed.lastError = null;
                            await updateFeed(feed);
                            fixedCount++;
                            
                            if (detailedLog) {
                                resultsDiv.innerHTML += `<div style="color: blue;">🔧 ${feed.name}: URLを自動修正しました</div>`;
                            }
                        }
                    }
                    
                    // エラーで停止
                    if (stopOnError) {
                        statusText.textContent = 'エラーが発生したためテストを停止しました';
                        break;
                    }
                }
                
                // 少し待機（サーバー負荷軽減）
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // 完了
            progressBar.style.width = '100%';
            statusText.innerHTML = `
                <strong>テスト完了！</strong><br>
                ✅ 成功: ${successCount} | ❌ エラー: ${errorCount} | 🔧 自動修正: ${fixedCount}
            `;
            
            // フィード一覧を更新
            await displayFeeds();
            
            // UIリセット
            autoTestRunning = false;
            document.getElementById('startTestBtn').style.display = 'inline-block';
            document.getElementById('stopTestBtn').style.display = 'none';
        }
        
        // 自動テスト中止
        function stopAutoTest() {
            autoTestAborted = true;
            autoTestRunning = false;
            document.getElementById('startTestBtn').style.display = 'inline-block';
            document.getElementById('stopTestBtn').style.display = 'none';
        }
        
        // 静かに代替RSSを探す（モーダルを表示しない）
        async function searchAlternativesQuietly(feed) {
            const currentUrl = feed.url;
            let domain = '';
            try {
                const urlObj = new URL(currentUrl);
                domain = urlObj.hostname;
            } catch (e) {
                return [];
            }
            
            if (!domain) return [];
            
            // 一般的なRSSパスを試す
            const commonPaths = [
                '/feed/', '/rss/', '/rss.xml', '/feed.xml', 
                '/atom.xml', '/index.xml', '/index.rdf'
            ];
            
            const alternatives = [];
            for (const path of commonPaths) {
                const testUrl = `https://${domain}${path}`;
                const result = await testFeedQuick(testUrl);
                if (result.success) {
                    alternatives.push({ url: testUrl, success: true });
                }
            }
            
            return alternatives;
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded: 初期化開始');
            
            try {
                await initDB();
                console.log('初期DB初期化完了');
            } catch (e) {
                console.error('初期DB初期化エラー:', e);
            }
            
            await displayFeeds();
            
            // サンプルデータ（初回のみ）
            const feeds = await getAllFeeds();
            if (feeds.length === 0) {
                const samples = [
                    { name: 'TechCrunch Japan', url: 'https://jp.techcrunch.com/feed/', category: 'テクノロジー' },
                    { name: 'GIGAZINE', url: 'https://gigazine.net/news/rss_2.0/', category: 'テクノロジー' },
                    { name: 'ITmedia AI+', url: 'https://rss.itmedia.co.jp/rss/2.0/aiplus.xml', category: 'AI・機械学習' }
                ];
                
                for (const sample of samples) {
                    await addFeed(sample);
                }
                displayFeeds();
            }
            
            // インポートボタンにイベントリスナーを追加
            const importBtn = document.getElementById('importBtn');
            if (importBtn) {
                importBtn.addEventListener('click', async function() {
                    console.log('インポートボタンがクリックされました');
                    await performImport();
                });
            } else {
                console.error('インポートボタンが見つかりません');
            }
            
            // 既存フィードの形式を非同期で更新
            setTimeout(async () => {
                const feeds = await getAllFeeds();
                let updatedCount = 0;
                
                for (const feed of feeds) {
                    if (!feed.feedFormat && !feed.fetchError) {
                        try {
                            const response = await fetch(`https://polished-snow-477a.yutapii.workers.dev?url=${encodeURIComponent(feed.url)}`);
                            if (response.ok) {
                                const text = await response.text();
                                const feedFormat = detectFeedFormat(text);
                                
                                if (feedFormat !== 'Unknown') {
                                    // DBを更新
                                    if (db) {
                                        const transaction = db.transaction(['feeds'], 'readwrite');
                                        const store = transaction.objectStore('feeds');
                                        feed.feedFormat = feedFormat;
                                        store.put(feed);
                                        updatedCount++;
                                    }
                                }
                            }
                        } catch (error) {
                            console.log(`フィード形式の検出エラー (${feed.name}):`, error);
                        }
                    }
                }
                
                if (updatedCount > 0) {
                    console.log(`${updatedCount}個のフィード形式を更新しました`);
                    displayFeeds();
                }
            }, 2000);
        });
    </script>
</body>
</html>