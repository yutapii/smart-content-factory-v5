<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSSä¸€è¦§ - é…ä¿¡å…ƒç®¡ç† | SCF V5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* æ¢ç´¢ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        @keyframes searchMove {
            0%, 100% { transform: translateX(0) rotate(-15deg); }
            25% { transform: translateX(5px) rotate(-15deg); }
            75% { transform: translateX(-5px) rotate(-15deg); }
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .searching-animation {
            display: inline-flex;
            align-items: center;
            gap: 15px;
        }
        
        .search-icon-animated {
            font-size: 2.5em;
            animation: searchMove 1.5s ease-in-out infinite;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .dots-container {
            display: inline-flex;
            gap: 5px;
        }
        
        .dots-container .pulse-dot:nth-child(1) { animation-delay: 0s; }
        .dots-container .pulse-dot:nth-child(2) { animation-delay: 0.2s; }
        .dots-container .pulse-dot:nth-child(3) { animation-delay: 0.4s; }
        
        .search-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
            color: #667eea;
        }
        
        .search-progress {
            width: 100%;
            height: 4px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .search-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            animation: progress 3s ease-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 60%; }
            100% { width: 90%; }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .stats-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .add-form {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .add-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .add-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .feed-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .feed-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .feed-item:hover {
            background: #f8f9fa;
        }

        .feed-info {
            flex: 1;
        }

        .feed-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .feed-url {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
            word-break: break-all;
            line-height: 1.6;
        }
        
        .feed-url a {
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .feed-url a:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        .feed-meta {
            display: flex;
            gap: 20px;
            font-size: 0.85em;
            color: #999;
        }

        .feed-category {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 3px;
        }

        .feed-error-badge {
            background: #ffebee;
            color: #c62828;
            padding: 2px 8px;
            border-radius: 3px;
            margin-left: 10px;
            cursor: help;
            animation: errorPulse 2s infinite;
        }

        @keyframes errorPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .feed-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .import-area {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            font-family: monospace;
            resize: vertical;
        }

        .file-input-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .import-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .import-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .import-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .import-panel {
            display: none;
        }

        .import-panel.active {
            display: block;
        }

        .import-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .import-preview-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }

        .import-preview-item:last-child {
            border-bottom: none;
        }

        .import-preview-item.error {
            background: #ffebee;
            color: #c62828;
        }

        .import-preview-item.duplicate {
            background: #fff3e0;
            color: #e65100;
        }

        .import-preview-item.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .category-tag {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .category-tag:hover {
            background: #e0e0e0;
        }

        .category-tag.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }
            
            .add-form {
                flex-direction: column;
            }
            
            .feed-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .feed-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
            }
        }
        
        /* é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideIn 0.3s ease;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left: 4px solid #4caf50;
        }
        
        .toast.error {
            border-left: 4px solid #f44336;
        }
        
        .toast.warning {
            border-left: 4px solid #ff9800;
        }
        
        .toast.info {
            border-left: 4px solid #2196f3;
        }
        
        .toast-icon {
            font-size: 1.2em;
        }
        
        .toast-message {
            flex: 1;
            color: #333;
            font-size: 14px;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="toast-container" id="toastContainer"></div>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“° RSSä¸€è¦§ - é…ä¿¡å…ƒç®¡ç† <span id="feedCountBadge" style="font-size: 0.5em; background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 15px; margin-left: 10px;">(0ä»¶)</span></h1>
            <a href="../index.html" class="back-btn">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</a>
        </div>
    </div>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalFeeds">0</div>
                <div class="stat-label">ç™»éŒ²ãƒ•ã‚£ãƒ¼ãƒ‰æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activeFeeds">0</div>
                <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="categoryCount">0</div>
                <div class="stat-label">ã‚«ãƒ†ã‚´ãƒªæ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdate">--:--</div>
                <div class="stat-label">æœ€çµ‚æ›´æ–°</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <form class="add-form" id="addFeedForm">
                    <input type="text" id="feedName" placeholder="ãƒ•ã‚£ãƒ¼ãƒ‰åï¼ˆä¾‹ï¼šTechCrunchï¼‰" required>
                    <input type="url" id="feedUrl" placeholder="RSS URLï¼ˆhttps://...ï¼‰" required>
                    <select id="feedCategory">
                        <option value="">ã‚«ãƒ†ã‚´ãƒªé¸æŠ</option>
                        <option value="ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼">ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼</option>
                        <option value="ãƒ“ã‚¸ãƒã‚¹">ãƒ“ã‚¸ãƒã‚¹</option>
                        <option value="AIãƒ»æ©Ÿæ¢°å­¦ç¿’">AIãƒ»æ©Ÿæ¢°å­¦ç¿’</option>
                        <option value="ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—">ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—</option>
                        <option value="å®˜å…¬åº">å®˜å…¬åº</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    <button type="submit" class="btn btn-primary">è¿½åŠ </button>
                </form>
            </div>
            <div class="control-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¤œç´¢...">
                </div>
                <select id="errorFilter" onchange="displayFeeds()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                    <option value="all">å…¨ã¦è¡¨ç¤º</option>
                    <option value="normal">âœ… æ­£å¸¸ã®ã¿</option>
                    <option value="error">âŒ ã‚¨ãƒ©ãƒ¼ã®ã¿</option>
                    <option value="html_error">ğŸ“„ HTMLã‚¨ãƒ©ãƒ¼</option>
                    <option value="invalid_feed">âš ï¸ ç„¡åŠ¹ãªRSS</option>
                    <option value="network_error">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</option>
                    <option value="restricted">ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™</option>
                    <option value="stopped">â¸ï¸ åœæ­¢ä¸­</option>
                </select>
                <button class="btn btn-secondary" onclick="showImportModal()">ğŸ“¥ ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-success" onclick="showExportOptions()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-primary" onclick="showAIRSSFinder()">ğŸ¤– RSSæ¢ç´¢</button>
                <button class="btn btn-primary" onclick="showAutoTestModal()" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    ğŸ”„ è‡ªå‹•ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
            <div class="category-tags" id="categoryFilter">
                <span class="category-tag active" data-category="all">ã™ã¹ã¦</span>
            </div>
        </div>

        <div class="feed-list" id="feedList">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“¡</div>
                <div class="empty-state-text">ã¾ã ãƒ•ã‚£ãƒ¼ãƒ‰ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                <div class="empty-state-text">ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</div>
            </div>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeImportModal()">&times;</span>
                <h2>RSSãƒ•ã‚£ãƒ¼ãƒ‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            </div>
            
            <div class="import-tabs">
                <button class="import-tab active" onclick="switchImportTab('text')">ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</button>
                <button class="import-tab" onclick="switchImportTab('file')">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            
            <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ‘ãƒãƒ« -->
            <div id="textImportPanel" class="import-panel active">
                <p>1è¡Œ1ãƒ•ã‚£ãƒ¼ãƒ‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆåå‰|URL|ã‚«ãƒ†ã‚´ãƒªï¼‰</p>
                <textarea class="import-area" id="importData" placeholder="TechCrunch|https://techcrunch.com/feed/|ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼
Bloomberg|https://www.bloomberg.com/feed/|ãƒ“ã‚¸ãƒã‚¹
MIT Tech Review|https://www.technologyreview.com/feed/|AIãƒ»æ©Ÿæ¢°å­¦ç¿’"></textarea>
            </div>
            
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« -->
            <div id="fileImportPanel" class="import-panel">
                <div class="file-input-container">
                    <label for="fileInput" class="file-input-label">
                        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </label>
                    <input type="file" id="fileInput" class="file-input" accept=".txt,.csv,.tsv,.json" onchange="handleFileSelect(event)">
                    <div class="file-info" id="fileInfo">å¯¾å¿œå½¢å¼: .txt, .csv, .tsv, .json</div>
                </div>
                <div id="filePreview" style="display: none;">
                    <h4 style="margin-bottom: 10px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</h4>
                    <div class="import-preview" id="fileImportPreview"></div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" id="importBtn" style="margin-left: 10px;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="../js/logger.js"></script>
    <script src="../js/error-handler.js"></script>
    
    <script>
        // IndexedDBè¨­å®š
        let db;
        const DB_NAME = 'SCFV5_RSS';
        const DB_VERSION = 2; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’2ã«çµ±ä¸€
        
        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            container.appendChild(toast);
            
            // è‡ªå‹•ã§æ¶ˆãˆã‚‹
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            return toast;
        }

        // IndexedDBåˆæœŸåŒ–ï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function initDB() {
            return new Promise((resolve, reject) => {
                // æ—¢å­˜ã®DBæ¥ç¶šã‚’é–‰ã˜ã‚‹
                if (db) {
                    try {
                        db.close();
                        db = null;
                    } catch (e) {
                        console.log('æ—¢å­˜DBæ¥ç¶šã®ã‚¯ãƒ­ãƒ¼ã‚ºä¸­ã®ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–å¯ï¼‰:', e);
                    }
                }
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDBæ¥ç¶šã‚¨ãƒ©ãƒ¼:', request.error);
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚LocalStorageã§å‹•ä½œç¶™ç¶š
                    db = null;
                    resolve(null);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDBæ¥ç¶šæˆåŠŸ: ãƒãƒ¼ã‚¸ãƒ§ãƒ³', db.version);
                    
                    // DBæ¥ç¶šãŒåˆ‡ã‚ŒãŸå ´åˆã®å‡¦ç†
                    db.onversionchange = () => {
                        db.close();
                        db = null;
                        console.log('DBãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸãŸã‚æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸ');
                    };
                    
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    const oldVersion = event.oldVersion;
                    const newVersion = event.newVersion;
                    
                    console.log(`DBã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰: ${oldVersion} â†’ ${newVersion}`);
                    
                    // feeds storeï¼ˆRSSä¸€è¦§ç”¨ï¼‰
                    if (!db.objectStoreNames.contains('feeds')) {
                        const store = db.createObjectStore('feeds', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('active', 'active', { unique: false });
                        console.log('feeds storeã‚’ä½œæˆã—ã¾ã—ãŸ');
                    }
                    
                    // articles storeï¼ˆé…ä¿¡RSSç”¨ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³2ã§è¿½åŠ ï¼‰
                    if (!db.objectStoreNames.contains('articles')) {
                        const articleStore = db.createObjectStore('articles', { keyPath: 'id', autoIncrement: true });
                        articleStore.createIndex('feedId', 'feedId', { unique: false });
                        articleStore.createIndex('pubDate', 'pubDate', { unique: false });
                        articleStore.createIndex('saved', 'saved', { unique: false });
                        console.log('articles storeã‚’ä½œæˆã—ã¾ã—ãŸ');
                    }
                };
                
                request.onblocked = () => {
                    console.warn('DBæ¥ç¶šãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ - ä»–ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„');
                    showToast('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»–ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'warning', 5000);
                };
            });
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼ã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°
        function detectFeedFormat(xmlText) {
            // Atom 1.0
            if (xmlText.includes('<feed xmlns="http://www.w3.org/2005/Atom"') || 
                xmlText.includes('<feed') && xmlText.includes('xmlns:atom=')) {
                return 'Atom 1.0';
            }
            
            // RSS 2.0
            if (xmlText.includes('<rss version="2.0"') || 
                xmlText.includes('<rss') && xmlText.includes('version="2.0"')) {
                return 'RSS 2.0';
            }
            
            // RSS 1.0 (RDF)
            if (xmlText.includes('<rdf:RDF') || 
                xmlText.includes('xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"')) {
                return 'RSS 1.0';
            }
            
            // RSS versionä¸æ˜
            if (xmlText.includes('<rss') || xmlText.includes('<channel>')) {
                return 'RSS';
            }
            
            // ãã®ä»–
            if (xmlText.includes('<feed') || xmlText.includes('<entry>')) {
                return 'Atom';
            }
            
            return 'Unknown';
        }
        
        // ã‚µã‚¤ãƒˆã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã€å„ªå…ˆé †ä½ã§è¿”ã™
        async function detectAvailableFeeds(siteUrl) {
            const feeds = [];
            
            try {
                const response = await fetch(`https://polished-snow-477a.yutapii.workers.dev?url=${encodeURIComponent(siteUrl)}`);
                const html = await response.text();
                
                // Atom ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¤œç´¢
                const atomRegex = /<link[^>]+type=["']application\/atom\+xml["'][^>]*href=["']([^"']+)["'][^>]*>/gi;
                let match;
                while ((match = atomRegex.exec(html)) !== null) {
                    feeds.push({ type: 'Atom 1.0', url: match[1], priority: 1 });
                }
                
                // RSS 2.0 ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¤œç´¢
                const rss2Regex = /<link[^>]+type=["']application\/rss\+xml["'][^>]*href=["']([^"']+)["'][^>]*>/gi;
                while ((match = rss2Regex.exec(html)) !== null) {
                    feeds.push({ type: 'RSS 2.0', url: match[1], priority: 2 });
                }
                
                // RSS 1.0 (RDF) ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¤œç´¢
                const rss1Regex = /<link[^>]+type=["']application\/rdf\+xml["'][^>]*href=["']([^"']+)["'][^>]*>/gi;
                while ((match = rss1Regex.exec(html)) !== null) {
                    feeds.push({ type: 'RSS 1.0', url: match[1], priority: 3 });
                }
                
                // å„ªå…ˆé †ä½ã§ã‚½ãƒ¼ãƒˆ
                feeds.sort((a, b) => a.priority - b.priority);
                
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ¼ãƒ‰æ¤œå‡ºã‚¨ãƒ©ãƒ¼:', error);
            }
            
            return feeds;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ 
        async function addFeed(feed) {
            // dbãŒæœªå®šç¾©ã®å ´åˆã¯åˆæœŸåŒ–
            if (!db) {
                await initDB();
                
                // ãã‚Œã§ã‚‚dbãŒnullã®å ´åˆã¯LocalStorageã‚’ä½¿ç”¨
                if (!db) {
                    console.log('LocalStorageã«ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ä¿å­˜');
                    let feeds = [];
                    try {
                        const stored = localStorage.getItem('rss-feeds');
                        if (stored) {
                            feeds = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                        feeds = [];
                    }
                    
                    // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                    feed.id = Date.now() + Math.random();
                    feed.createdAt = new Date().toISOString();
                    feed.lastUpdate = new Date().toISOString();
                    feed.active = true;
                    feeds.push(feed);
                    
                    localStorage.setItem('rss-feeds', JSON.stringify(feeds));
                    return Promise.resolve(feed);
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['feeds'], 'readwrite');
                const store = transaction.objectStore('feeds');
                
                feed.active = true;
                feed.lastUpdate = new Date().toISOString();
                feed.createdAt = new Date().toISOString();
                
                const request = store.add(feed);
                
                request.onsuccess = () => {
                    console.log('ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ æˆåŠŸ:', feed.name);
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    console.error('ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ ã‚¨ãƒ©ãƒ¼:', request.error);
                    reject(request.error);
                };
            });
        }

        // å…¨ãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—
        async function getAllFeeds() {
            // dbãŒæœªå®šç¾©ã®å ´åˆã¯åˆæœŸåŒ–
            if (!db) {
                await initDB();
                
                // ãã‚Œã§ã‚‚dbãŒnullã®å ´åˆã¯LocalStorageã‹ã‚‰å–å¾—
                if (!db) {
                    console.log('LocalStorageã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å–å¾—');
                    try {
                        const stored = localStorage.getItem('rss-feeds');
                        if (stored) {
                            return JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error('LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                    }
                    return [];
                }
            }
            
            const transaction = db.transaction(['feeds'], 'readonly');
            const store = transaction.objectStore('feeds');
            
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰å‰Šé™¤
        async function deleteFeed(id) {
            if (!db) {
                await initDB();
            }
            const transaction = db.transaction(['feeds'], 'readwrite');
            const store = transaction.objectStore('feeds');
            return store.delete(id);
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰æ›´æ–°
        async function updateFeed(feed) {
            if (!db) {
                await initDB();
            }
            const transaction = db.transaction(['feeds'], 'readwrite');
            const store = transaction.objectStore('feeds');
            feed.lastUpdate = new Date().toISOString();
            return store.put(feed);
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰è¡¨ç¤º
        async function displayFeeds(filter = '') {
            const feeds = await getAllFeeds();
            const feedList = document.getElementById('feedList');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredFeeds = feeds;
            if (filter && filter !== 'all') {
                filteredFeeds = feeds.filter(f => f.category === filter);
            }
            
            // ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿
            const errorFilter = document.getElementById('errorFilter')?.value || 'all';
            if (errorFilter !== 'all') {
                switch(errorFilter) {
                    case 'normal':
                        filteredFeeds = filteredFeeds.filter(f => !f.fetchError && f.active);
                        break;
                    case 'error':
                        filteredFeeds = filteredFeeds.filter(f => f.fetchError);
                        break;
                    case 'html_error':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && f.lastError.includes('HTMLãƒšãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã—ãŸ')
                        );
                        break;
                    case 'invalid_feed':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && f.lastError.includes('æœ‰åŠ¹ãªRSSãƒ•ã‚£ãƒ¼ãƒ‰ã§ã¯ãªã„')
                        );
                        break;
                    case 'network_error':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && (f.lastError.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯') || 
                                          f.lastError.includes('Network') ||
                                          f.lastError.includes('HTTP'))
                        );
                        break;
                    case 'restricted':
                        filteredFeeds = filteredFeeds.filter(f => 
                            f.lastError && f.lastError.includes('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™')
                        );
                        break;
                    case 'stopped':
                        filteredFeeds = filteredFeeds.filter(f => !f.active);
                        break;
                }
            }
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredFeeds = filteredFeeds.filter(f => 
                    f.name.toLowerCase().includes(searchTerm) ||
                    f.url.toLowerCase().includes(searchTerm) ||
                    (f.category && f.category.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredFeeds.length === 0) {
                feedList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“¡</div>
                        <div class="empty-state-text">ãƒ•ã‚£ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
                return;
            }
            
            feedList.innerHTML = filteredFeeds.map(feed => {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ”¹å–„
                let statusDisplay = '';
                if (feed.fetchError) {
                    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
                    statusDisplay = 'âŒ ã‚¨ãƒ©ãƒ¼';
                } else if (!feed.active) {
                    // åœæ­¢ä¸­ã®å ´åˆ
                    statusDisplay = 'â¸ï¸ åœæ­¢ä¸­';
                } else {
                    // æ­£å¸¸ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆ
                    statusDisplay = 'âœ… æ­£å¸¸';
                }
                
                // URLã‹ã‚‰ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URLã‚’æ¨å®š
                let homepageUrl = '';
                try {
                    const url = new URL(feed.url);
                    homepageUrl = `${url.protocol}//${url.hostname}`;
                } catch (e) {
                    homepageUrl = feed.url;
                }
                
                return `
                <div class="feed-item">
                    <div class="feed-info">
                        <div class="feed-name">${feed.name}</div>
                        <div class="feed-url">
                            <div style="margin-bottom: 3px;">
                                <span style="color: #666; font-size: 0.85em;">ğŸ  ãƒ›ãƒ¼ãƒ :</span>
                                <a href="${homepageUrl}" target="_blank" rel="noopener noreferrer" style="color: #4caf50; text-decoration: none; margin-left: 5px;">
                                    ${homepageUrl}
                                </a>
                            </div>
                            <div>
                                <span style="color: #666; font-size: 0.85em;">ğŸ“¡ RSS:</span>
                                <a href="${feed.url}" target="_blank" rel="noopener noreferrer" style="color: #1976d2; text-decoration: none; margin-left: 5px;">
                                    ${feed.url}
                                </a>
                            </div>
                        </div>
                        <div class="feed-meta">
                            ${feed.category ? `<span class="feed-category">${feed.category}</span>` : ''}
                            ${feed.feedFormat ? `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 3px; font-weight: bold;">ğŸ“‹ ${feed.feedFormat}</span>` : ''}
                            <span>æœ€çµ‚æ›´æ–°: ${new Date(feed.lastUpdate).toLocaleString('ja-JP')}</span>
                            <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusDisplay}</span>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-weight: bold;">ğŸ“Š è¨˜äº‹æ•°: <span id="articleCount-${feed.id}">èª­è¾¼ä¸­...</span></span>
                            ${feed.fetchError ? `
                                <span class="feed-error-badge" title="${feed.lastError || 'å–å¾—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}">âš ï¸ ${feed.lastError || 'å–å¾—ã‚¨ãƒ©ãƒ¼'}</span>
                                ${(feed.lastError && (
                                    feed.lastError.includes('æœ‰åŠ¹ãªRSSãƒ•ã‚£ãƒ¼ãƒ‰ã§ã¯ãªã„') ||
                                    feed.lastError.includes('HTMLãƒšãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã—ãŸ') ||
                                    feed.lastError.includes('HTTP') ||
                                    feed.lastError.includes('Network') ||
                                    feed.lastError.includes('ã‚¨ãƒ©ãƒ¼')
                                )) ? `
                                    <button class="btn btn-small btn-success" onclick="findAlternativeRSS(${feed.id}, '${feed.name.replace(/'/g, "\\'")}')"
                                            style="margin-left: 10px; font-size: 11px; padding: 3px 8px;" 
                                            title="AIãŒä»£æ›¿RSSã‚’æ¢ã—ã¾ã™">
                                        ğŸ¤– ä»£æ›¿ã‚’æ¢ã™
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    </div>
                    <div class="feed-actions">
                        <button class="btn btn-small btn-primary" onclick="testFeed('${feed.url}', ${feed.id})">ãƒ†ã‚¹ãƒˆ</button>
                        <button class="btn btn-small btn-secondary" onclick="toggleFeed(${feed.id})">
                            ${feed.active ? 'åœæ­¢' : 'é–‹å§‹'}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="removeFeed(${feed.id})">å‰Šé™¤</button>
                    </div>
                </div>
            `}).join('');
            
            updateStats();
            
            // å„ãƒ•ã‚£ãƒ¼ãƒ‰ã®è¨˜äº‹æ•°ã‚’å–å¾—
            updateArticleCounts(filteredFeeds);
        }
        
        // è¨˜äº‹æ•°ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        async function updateArticleCounts(feeds) {
            if (!db) return;
            
            for (const feed of feeds) {
                try {
                    const transaction = db.transaction(['articles'], 'readonly');
                    const store = transaction.objectStore('articles');
                    const index = store.index('feedId');
                    const countRequest = index.count(feed.id);
                    
                    countRequest.onsuccess = () => {
                        const count = countRequest.result;
                        const countElement = document.getElementById(`articleCount-${feed.id}`);
                        if (countElement) {
                            countElement.textContent = count || 0;
                        }
                    };
                } catch (error) {
                    // IndexedDBãŒä½¿ãˆãªã„å ´åˆã¯0ã‚’è¡¨ç¤º
                    const countElement = document.getElementById(`articleCount-${feed.id}`);
                    if (countElement) {
                        countElement.textContent = '0';
                    }
                }
            }
        }

        // çµ±è¨ˆæ›´æ–°
        async function updateStats() {
            const feeds = await getAllFeeds();
            document.getElementById('totalFeeds').textContent = feeds.length;
            document.getElementById('activeFeeds').textContent = feeds.filter(f => f.active && !f.fetchError).length;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä»¶æ•°ãƒãƒƒã‚¸ã‚‚æ›´æ–°
            const feedCountBadge = document.getElementById('feedCountBadge');
            if (feedCountBadge) {
                feedCountBadge.textContent = `(${feeds.length}ä»¶)`;
            }
            
            // ã‚¨ãƒ©ãƒ¼æ•°ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åæ˜ ï¼‰
            const errorCount = feeds.filter(f => f.fetchError).length;
            const errorFilter = document.getElementById('errorFilter');
            if (errorFilter) {
                // ã‚¨ãƒ©ãƒ¼æ•°ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¡¨ç¤º
                errorFilter.options[2].text = `âŒ ã‚¨ãƒ©ãƒ¼ã®ã¿ (${errorCount})`;
                
                // å„ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã®æ•°ã‚’è¨ˆç®—
                const htmlErrors = feeds.filter(f => f.lastError && f.lastError.includes('HTMLãƒšãƒ¼ã‚¸')).length;
                const invalidFeeds = feeds.filter(f => f.lastError && f.lastError.includes('æœ‰åŠ¹ãªRSSãƒ•ã‚£ãƒ¼ãƒ‰ã§ã¯ãªã„')).length;
                const networkErrors = feeds.filter(f => f.lastError && (f.lastError.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯') || f.lastError.includes('HTTP'))).length;
                const restrictedSites = feeds.filter(f => f.lastError && f.lastError.includes('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™')).length;
                const stoppedFeeds = feeds.filter(f => !f.active).length;
                
                if (htmlErrors > 0) errorFilter.options[3].text = `ğŸ“„ HTMLã‚¨ãƒ©ãƒ¼ (${htmlErrors})`;
                if (invalidFeeds > 0) errorFilter.options[4].text = `âš ï¸ ç„¡åŠ¹ãªRSS (${invalidFeeds})`;
                if (networkErrors > 0) errorFilter.options[5].text = `ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ (${networkErrors})`;
                if (restrictedSites > 0) errorFilter.options[6].text = `ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ (${restrictedSites})`;
                if (stoppedFeeds > 0) errorFilter.options[7].text = `â¸ï¸ åœæ­¢ä¸­ (${stoppedFeeds})`;
            }
            
            const categories = [...new Set(feeds.map(f => f.category).filter(c => c))];
            document.getElementById('categoryCount').textContent = categories.length;
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = `
                <span class="category-tag active" data-category="all" onclick="filterByCategory('all')">ã™ã¹ã¦</span>
                ${categories.map(cat => 
                    `<span class="category-tag" data-category="${cat}" onclick="filterByCategory('${cat}')">${cat}</span>`
                ).join('')}
            `;
            
            // æœ€çµ‚æ›´æ–°æ™‚åˆ»
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterByCategory(category) {
            document.querySelectorAll('.category-tag').forEach(tag => {
                tag.classList.remove('active');
                if (tag.dataset.category === category) {
                    tag.classList.add('active');
                }
            });
            displayFeeds(category);
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('addFeedForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const feed = {
                name: document.getElementById('feedName').value,
                url: document.getElementById('feedUrl').value,
                category: document.getElementById('feedCategory').value
            };
            
            try {
                await addFeed(feed);
                e.target.reset();
                displayFeeds();
                showToast('ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                showToast('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // æ¤œç´¢
        document.getElementById('searchInput').addEventListener('input', () => {
            displayFeeds(document.querySelector('.category-tag.active').dataset.category);
        });

        // ãƒ•ã‚£ãƒ¼ãƒ‰å‰Šé™¤
        async function removeFeed(id) {
            if (confirm('ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                await deleteFeed(id);
                displayFeeds();
            }
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
        async function toggleFeed(id) {
            const feeds = await getAllFeeds();
            const feed = feeds.find(f => f.id === id);
            if (feed) {
                feed.active = !feed.active;
                await updateFeed(feed);
                displayFeeds();
            }
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º + ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±åˆï¼‰
        async function testFeed(url, feedId = null) {
            await Logger.info(`Testing feed: ${url}`, { context: 'testFeed', feedId });
            // æ—¢çŸ¥ã®å•é¡ŒãŒã‚ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç‰¹åˆ¥å‡¦ç†
            const problematicDomains = [
                'bmbf.de', 'bsi.bund.de', 'economie.gouv.fr', 
                'ssi.gouv.fr', 'inria.fr', 'enisa.europa.eu',
                'digital.canada.ca', 'nrc.canada.ca'
            ];
            
            const urlDomain = new URL(url).hostname;
            const isProblematicDomain = problematicDomains.some(domain => urlDomain.includes(domain));
            
            // åˆ¶é™ãŒã‚ã‚‹ã‚µã‚¤ãƒˆã®å ´åˆã€ä»£æ›¿ãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦ã™
            if (isProblematicDomain) {
                console.log(`åˆ¶é™ä»˜ããƒ‰ãƒ¡ã‚¤ãƒ³æ¤œå‡º: ${urlDomain}ã€ä»£æ›¿æ–¹æ³•ã‚’è©¦ã—ã¾ã™`);
                
                // è¤‡æ•°ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’è©¦ã™
                const proxyServices = [
                    {
                        name: 'RSS2JSON',
                        url: `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`,
                        parseResponse: async (response) => {
                            const data = await response.json();
                            if (data.status === 'ok' && data.items) {
                                return {
                                    success: true,
                                    message: `âœ… ${data.items.length}ä»¶ã®è¨˜äº‹ã‚’å–å¾—ï¼ˆRSS2JSONçµŒç”±ï¼‰`,
                                    errorCode: null
                                };
                            }
                            return {
                                success: false,
                                message: 'âŒ å–å¾—å¤±æ•—ï¼ˆRSS2JSONï¼‰',
                                errorCode: 'RSS2JSON_FAILED'
                            };
                        }
                    },
                    {
                        name: 'AllOrigins',
                        url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                        parseResponse: async (response) => {
                            const data = await response.json();
                            if (data.contents && (data.contents.includes('<rss') || data.contents.includes('<feed'))) {
                                const parser = new DOMParser();
                                const xml = parser.parseFromString(data.contents, 'text/xml');
                                const items = xml.querySelectorAll('item, entry');
                                return {
                                    success: true,
                                    message: `âœ… ${items.length}ä»¶ã®è¨˜äº‹ã‚’å–å¾—ï¼ˆAllOriginsçµŒç”±ï¼‰`,
                                    errorCode: null
                                };
                            }
                            return {
                                success: false,
                                message: 'âŒ å–å¾—å¤±æ•—ï¼ˆAllOriginsï¼‰',
                                errorCode: 'ALLORIGINS_FAILED'
                            };
                        }
                    }
                ];
                
                // å„ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’é †ç•ªã«è©¦ã™
                for (const proxy of proxyServices) {
                    try {
                        console.log(`${proxy.name}ã‚’è©¦ã—ã¦ã„ã¾ã™...`);
                        const response = await fetch(proxy.url, {
                            mode: 'cors',
                            credentials: 'omit'
                        }).catch(err => ({ ok: false }));
                        
                        if (response.ok) {
                            const result = await proxy.parseResponse(response);
                            if (result.success) {
                                // æˆåŠŸã—ãŸå ´åˆã€DBæ›´æ–°
                                if (feedId && db) {
                                    try {
                                        const transaction = db.transaction(['feeds'], 'readwrite');
                                        const store = transaction.objectStore('feeds');
                                        const feedRequest = store.get(feedId);
                                        
                                        feedRequest.onsuccess = () => {
                                            const feed = feedRequest.result;
                                            if (feed) {
                                                feed.fetchError = false;
                                                feed.lastError = null;
                                                feed.lastErrorCode = null;
                                                feed.lastChecked = new Date().toISOString();
                                                feed.proxyRequired = proxy.name; // ä½¿ç”¨ã—ãŸãƒ—ãƒ­ã‚­ã‚·ã‚’è¨˜éŒ²
                                                store.put(feed);
                                            }
                                        };
                                    } catch (e) {
                                        console.log('DBæ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
                                    }
                                }
                                
                                if (!feedId) showToast(result.message, result.success ? 'success' : 'error');
                                return result;
                            }
                        }
                    } catch (error) {
                        console.log(`${proxy.name}ã§ã‚¨ãƒ©ãƒ¼:`, error.message);
                    }
                }
                
                // ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ãŒå¤±æ•—ã—ãŸå ´åˆ
                const errorInfo = {
                    success: false,
                    message: 'âš ï¸ ã“ã®ã‚µã‚¤ãƒˆã¯ç¾åœ¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ãŒã‚ã‚Šã¾ã™\n\nä»£æ›¿ãƒ—ãƒ­ã‚­ã‚·ã‚‚è©¦ã—ã¾ã—ãŸãŒã€ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
                    errorCode: 'RESTRICTED_SITE'
                };
                
                // DBæ›´æ–°
                if (feedId && db) {
                    try {
                        const transaction = db.transaction(['feeds'], 'readwrite');
                        const store = transaction.objectStore('feeds');
                        const feedRequest = store.get(feedId);
                        
                        feedRequest.onsuccess = () => {
                            const feed = feedRequest.result;
                            if (feed) {
                                feed.fetchError = true;
                                feed.lastError = errorInfo.message;
                                feed.lastErrorCode = errorInfo.errorCode;
                                feed.lastChecked = new Date().toISOString();
                                store.put(feed);
                            }
                        };
                    } catch (e) {
                        console.log('DBæ›´æ–°ã‚¹ã‚­ãƒƒãƒ—');
                    }
                }
                
                if (!feedId) showToast(errorInfo.message, errorInfo.success ? 'success' : 'error');
                return errorInfo;
            }
            
            // è¨­å®šæ¸ˆã¿ã®Cloudflare Worker URLã‚’ä½¿ç”¨
            const workerUrl = 'https://polished-snow-477a.yutapii.workers.dev';
            let errorInfo = null;
            
            try {
                // console.logã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã¯è¡¨ç¤ºã—ãªã„ï¼‰
                if (localStorage.getItem('debug-mode') === 'true') {
                    console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹:', url);
                }
                const testUrl = `${workerUrl}?url=${encodeURIComponent(url)}`;
                // ã‚¨ãƒ©ãƒ¼ã‚’äº‹å‰ã«ã‚­ãƒ£ãƒƒãƒ
                let response;
                try {
                    response = await fetch(testUrl, {
                        mode: 'cors',
                        credentials: 'omit'
                    });
                } catch (fetchError) {
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§å‡¦ç†
                    await ErrorHandler.handle(fetchError, 'testFeed-fetch', { url, feedId });
                    
                    // ãƒªãƒˆãƒ©ã‚¤åˆ¤å®š
                    const recovery = await ErrorHandler.attemptRecovery(
                        ErrorHandler.classify(fetchError),
                        'testFeed-fetch',
                        { url, feedId }
                    );
                    
                    if (recovery.retry && recovery.delay) {
                        await new Promise(resolve => setTimeout(resolve, recovery.delay));
                        // ãƒªãƒˆãƒ©ã‚¤
                        return testFeed(url, feedId);
                    }
                    
                    return { 
                        success: false, 
                        message: `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼`,
                        errorCode: 'NETWORK_ERROR'
                    };
                }
                
                if (response.ok) {
                    const text = await response.text();
                    // HTMLãƒã‚§ãƒƒã‚¯
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        errorInfo = {
                            success: false,
                            message: 'HTMLãƒšãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã—ãŸï¼ˆRSSã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰',
                            errorCode: 'HTML_CONTENT'
                        };
                    } else if (text.includes('<rss') || text.includes('<feed') || text.includes('<item>') || text.includes('<entry>')) {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(text, 'text/xml');
                        const items = xml.querySelectorAll('item, entry');
                        
                        // ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼ã‚’æ¤œå‡º
                        const feedFormat = detectFeedFormat(text);
                        
                        errorInfo = {
                            success: true,
                            message: `âœ… ${items.length}ä»¶ã®è¨˜äº‹ã‚’å–å¾— (${feedFormat})`,
                            errorCode: null,
                            feedFormat: feedFormat
                        };
                        
                        // æˆåŠŸã‚’ãƒ­ã‚°ã«è¨˜éŒ²
                        await Logger.info(`Feed test successful: ${items.length} items`, {
                            context: 'testFeed',
                            url,
                            feedId,
                            feedFormat,
                            itemCount: items.length
                        });
                    } else {
                        errorInfo = {
                            success: false,
                            message: 'âš ï¸ æœ‰åŠ¹ãªRSSãƒ•ã‚£ãƒ¼ãƒ‰ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
                            errorCode: 'INVALID_FEED'
                        };
                    }
                } else {
                    errorInfo = {
                        success: false,
                        message: `âŒ HTTP ${response.status}`,
                        errorCode: `HTTP_${response.status}`
                    };
                }
            } catch (firstError) {
                console.error('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', firstError);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RSS2JSON
                try {
                    const fallbackUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
                    const response = await fetch(fallbackUrl, {
                        mode: 'cors',
                        credentials: 'omit'
                    }).catch(err => {
                        console.log('RSS2JSON error caught:', err.message);
                        return { ok: false, status: 0 };
                    });
                    
                    if (response.ok) {
                        try {
                            const responseData = await response.json();
                            if (responseData && responseData.status === 'ok') {
                                errorInfo = {
                                    success: true,
                                    message: `âœ… ${responseData.items ? responseData.items.length : 0}ä»¶ã®è¨˜äº‹ã‚’å–å¾—ï¼ˆRSS2JSONçµŒç”±ï¼‰`,
                                    errorCode: null
                                };
                            } else {
                                const errorMsg = responseData?.message || 'Unknown error';
                                errorInfo = {
                                    success: false,
                                    message: `âŒ ${errorMsg}`,
                                    errorCode: 'RSS2JSON_ERROR'
                                };
                            }
                        } catch (jsonError) {
                            console.error('JSON parse error:', jsonError);
                            errorInfo = {
                                success: false,
                                message: 'âŒ Invalid response format',
                                errorCode: 'JSON_PARSE_ERROR'
                            };
                        }
                    } else {
                        errorInfo = {
                            success: false,
                            message: `âŒ HTTP ${response.status}`,
                            errorCode: `HTTP_${response.status}`
                        };
                    }
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    errorInfo = {
                        success: false,
                        message: 'âŒ Network error',
                        errorCode: 'NETWORK_ERROR'
                    };
                }
            }
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°DBæ›´æ–°
            if (feedId && db) {
                try {
                    const transaction = db.transaction(['feeds'], 'readwrite');
                    const store = transaction.objectStore('feeds');
                    const feedRequest = store.get(feedId);
                    
                    feedRequest.onsuccess = () => {
                        const feed = feedRequest.result;
                        if (feed) {
                            feed.fetchError = !errorInfo.success;
                            feed.lastError = errorInfo.success ? null : errorInfo.message;
                            feed.lastErrorCode = errorInfo.errorCode;
                            feed.lastChecked = new Date().toISOString();
                            // ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼ã‚’ä¿å­˜
                            if (errorInfo.feedFormat) {
                                feed.feedFormat = errorInfo.feedFormat;
                            }
                            store.put(feed);
                        }
                    };
                    
                    transaction.oncomplete = () => {
                        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«UIæ›´æ–°
                        displayFeeds();
                    };
                } catch (e) {
                    console.error('ãƒ•ã‚£ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
                }
            }
            
            // UIã¸ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è©³ç´°æƒ…å ±ã‚‚å«ã‚ã‚‹ï¼‰
            if (!errorInfo.success && errorInfo.errorCode) {
                let detailMessage = errorInfo.message;
                
                // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸè©³ç´°èª¬æ˜ã‚’è¿½åŠ 
                switch(errorInfo.errorCode) {
                    case 'NETWORK_ERROR':
                        detailMessage += '\n\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nãƒ—ãƒ­ã‚­ã‚·ã‚„ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®šã‚‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'HTML_CONTENT':
                        detailMessage += '\n\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\nURLãŒRSSãƒ•ã‚£ãƒ¼ãƒ‰ã§ã¯ãªãã€é€šå¸¸ã®Webãƒšãƒ¼ã‚¸ã‚’æŒ‡ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\næ­£ã—ã„RSS/Atomãƒ•ã‚£ãƒ¼ãƒ‰ã®URLã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'INVALID_FEED':
                        detailMessage += '\n\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\nXMLå½¢å¼ãŒæ­£ã—ããªã„ã‹ã€RSS/Atomãƒ•ã‚£ãƒ¼ãƒ‰ã®ä»•æ§˜ã«æº–æ‹ ã—ã¦ã„ã¾ã›ã‚“ã€‚\nãƒ•ã‚£ãƒ¼ãƒ‰æä¾›å…ƒã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                        break;
                    case 'RESTRICTED_SITE':
                        detailMessage += '\n\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\nã“ã®ã‚µã‚¤ãƒˆã¯åœ°åŸŸåˆ¶é™ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚\nVPNã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€åˆ¥ã®RSSã‚µãƒ¼ãƒ“ã‚¹çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'JSON_PARSE_ERROR':
                        detailMessage += '\n\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\nã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ•ã‚£ãƒ¼ãƒ‰ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                        break;
                    default:
                        if (errorInfo.errorCode.startsWith('HTTP_')) {
                            const statusCode = errorInfo.errorCode.replace('HTTP_', '');
                            detailMessage += `\n\nã€ã‚¨ãƒ©ãƒ¼è©³ç´°ã€‘\nHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${statusCode}\n`;
                            
                            // ä¸€èˆ¬çš„ãªHTTPã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜
                            switch(statusCode) {
                                case '403':
                                    detailMessage += 'ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚èªè¨¼ãŒå¿…è¦ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                                    break;
                                case '404':
                                    detailMessage += 'ãƒ•ã‚£ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                                    break;
                                case '500':
                                case '502':
                                case '503':
                                    detailMessage += 'ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                                    break;
                                case '429':
                                    detailMessage += 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                                    break;
                            }
                        }
                }
                
                showToast(detailMessage, 'info', 5000);
            } else {
                showToast(errorInfo.message, errorInfo.success ? 'success' : 'error');
            }
            
            return errorInfo;
        }

        // ã“ã®é–¢æ•°ã¯å‰Šé™¤ï¼ˆã€Œå…¨ã¦æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ã—ãŸãŸã‚ä¸è¦ï¼‰

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸæ™‚ã«ã‚‚ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            setTimeout(() => {
                const importBtn = document.getElementById('importBtn');
                if (importBtn) {
                    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                    const newImportBtn = importBtn.cloneNode(true);
                    importBtn.parentNode.replaceChild(newImportBtn, importBtn);
                    
                    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    newImportBtn.addEventListener('click', async function() {
                        console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼‰');
                        await performImport();
                    });
                }
            }, 100);
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importData').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').textContent = 'å¯¾å¿œå½¢å¼: .txt, .csv, .tsv, .json';
            document.getElementById('filePreview').style.display = 'none';
            fileContent = '';
            currentImportTab = 'text';
            
            // ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.import-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.import-tab').classList.add('active');
            document.getElementById('textImportPanel').classList.add('active');
            document.getElementById('fileImportPanel').classList.remove('active');
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        let fileContent = '';
        let currentImportTab = 'text';
        
        async function performImport() {
            try {
                console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹');
                console.log('currentImportTab:', currentImportTab);
                console.log('fileContent length:', fileContent.length);
                
                // DBã‚’å¼·åˆ¶çš„ã«åˆæœŸåŒ–ï¼ˆæ—¢å­˜ã®çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšï¼‰
                console.log('DBã‚’åˆæœŸåŒ–ä¸­...');
                try {
                    await initDB();
                    console.log('DBåˆæœŸåŒ–å®Œäº†, db=', db);
                } catch (dbError) {
                    console.error('DBåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', dbError);
                    showToast('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error', 5000);
                    return;
                }
                
                let data;
                if (currentImportTab === 'text') {
                    data = document.getElementById('importData').value;
                } else {
                    data = fileContent;
                }
                
                if (!data || !data.trim()) {
                    showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                    return;
                }
                
                await importFeeds(data);
                
            } catch (error) {
                console.error('performImport ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error', 5000);
            }
        }
        
        async function importFeeds(data) {
            console.log('importFeeds called with data length:', data.length);
            
            // DBã®ç¢ºèª
            if (!db) {
                console.log('importFeeds: DBãŒæœªåˆæœŸåŒ–ã®ãŸã‚å†åˆæœŸåŒ–');
                await initDB();
            }
            
            const lines = data.trim().split('\n');
            let imported = 0;
            let skipped = 0;
            let errors = [];
            
            // æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨
            let existingFeeds = [];
            let existingUrls = [];
            
            try {
                existingFeeds = await getAllFeeds();
                existingUrls = existingFeeds.map(f => f.url.toLowerCase());
                console.log('æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ‰æ•°:', existingFeeds.length);
            } catch (e) {
                console.error('æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                existingFeeds = [];
                existingUrls = [];
            }
            
            // JSONå½¢å¼ã®å ´åˆã®å‡¦ç†
            if (isJsonFormat(data)) {
                try {
                    const jsonData = JSON.parse(data);
                    const result = await importJsonFeeds(jsonData, existingUrls);
                    imported = result.imported;
                    skipped = result.skipped;
                    errors = result.errors;
                } catch (e) {
                    errors.push(`JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                }
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®å‡¦ç†
                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    let parts;
                    // CSVã¾ãŸã¯TSVã®å ´åˆ
                    if (line.includes('\t')) {
                        parts = line.split('\t');
                    } else if (line.includes(',') && !line.includes('|')) {
                        // CSVã®å ´åˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                        parts = parseCSVLine(line);
                    } else {
                        // ãƒ‘ã‚¤ãƒ—åŒºåˆ‡ã‚Šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                        parts = line.split('|');
                    }
                    
                    if (parts.length >= 2) {
                        const feedUrl = parts[1].trim();
                        
                        // URLæ¤œè¨¼
                        try {
                            new URL(feedUrl);
                        } catch (e) {
                            errors.push(`ç„¡åŠ¹ãªURL: ${feedUrl}`);
                            continue;
                        }
                        
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                        if (existingUrls.includes(feedUrl.toLowerCase())) {
                            skipped++;
                            continue;
                        }
                        
                        const feed = {
                            name: parts[0].trim(),
                            url: feedUrl,
                            category: parts[2] ? parts[2].trim() : 'ãã®ä»–'
                        };
                        
                        try {
                            await addFeed(feed);
                            imported++;
                            existingUrls.push(feedUrl.toLowerCase());
                        } catch (error) {
                            console.error('Import error:', error);
                            errors.push(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${feed.name}`);
                        }
                    }
                }
            }
            
            closeImportModal();
            
            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸå¾Œã«ãƒ•ã‚£ãƒ¼ãƒ‰ä¸€è¦§ã‚’æ›´æ–°
            await displayFeeds();
            
            let message = `âœ… ${imported}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`;
            if (skipped > 0) {
                message += `\nâš ï¸ ${skipped}å€‹ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`;
            }
            if (errors.length > 0) {
                message += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${errors.length}å€‹\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    message += `\n...ä»–${errors.length - 5}å€‹ã®ã‚¨ãƒ©ãƒ¼`;
                }
            }
            
            console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:', message);
            showToast(message, 'success', 5000);
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’è¡¨ç¤º
            if (imported > 0) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }
        
        // JSONå½¢å¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isJsonFormat(data) {
            const trimmed = data.trim();
            return (trimmed.startsWith('{') && trimmed.endsWith('}')) || 
                   (trimmed.startsWith('[') && trimmed.endsWith(']'));
        }
        
        // JSONãƒ•ã‚£ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        async function importJsonFeeds(jsonData, existingUrlsArray) {
            let imported = 0;
            let skipped = 0;
            let errors = [];
            
            // existingUrlsã‚’é…åˆ—ã®ã‚³ãƒ”ãƒ¼ã¨ã—ã¦ä½œæˆï¼ˆå…ƒã®é…åˆ—ã‚’å¤‰æ›´ã—ãªã„ãŸã‚ï¼‰
            const existingUrls = [...existingUrlsArray];
            
            // ãƒ•ãƒ©ãƒƒãƒˆãªãƒ•ã‚£ãƒ¼ãƒ‰é…åˆ—ã‚’ä½œæˆ
            let feedsToImport = [];
            
            console.log('JSONãƒ‡ãƒ¼ã‚¿æ§‹é€ :', jsonData); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            
            // v4å½¢å¼ã®JSONæ§‹é€ ã«å¯¾å¿œï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªæ§‹é€ ï¼‰
            if (jsonData.feeds && Array.isArray(jsonData.feeds)) {
                console.log('v4å½¢å¼ã‚’æ¤œå‡º');
                for (const categoryGroup of jsonData.feeds) {
                    const category = categoryGroup.category || 'ãã®ä»–';
                    if (categoryGroup.feeds && Array.isArray(categoryGroup.feeds)) {
                        for (const feed of categoryGroup.feeds) {
                            feedsToImport.push({
                                name: feed.name || feed.title || 'ç„¡é¡Œ',
                                url: feed.url || feed.link || '',
                                category: category,
                                description: feed.description || '',
                                tags: feed.tags || [],
                                priority: feed.priority || 'normal',
                                language: feed.language || 'ja'
                            });
                        }
                    }
                }
            }
            // ãƒ•ãƒ©ãƒƒãƒˆé…åˆ—å½¢å¼ã®JSON
            else if (Array.isArray(jsonData)) {
                console.log('é…åˆ—å½¢å¼ã‚’æ¤œå‡º');
                feedsToImport = jsonData.map(feed => ({
                    name: feed.name || feed.title || 'ç„¡é¡Œ',
                    url: feed.url || feed.link || '',
                    category: feed.category || 'ãã®ä»–',
                    description: feed.description || ''
                }));
            }
            // å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼
            else if (jsonData.name && jsonData.url) {
                console.log('å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã‚’æ¤œå‡º');
                feedsToImport = [{
                    name: jsonData.name,
                    url: jsonData.url,
                    category: jsonData.category || 'ãã®ä»–'
                }];
            }
            
            console.log(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾è±¡: ${feedsToImport.length}ä»¶`);
            
            // å„ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            for (const feedData of feedsToImport) {
                if (!feedData.url) {
                    errors.push(`URLãŒç©º: ${feedData.name}`);
                    continue;
                }
                
                // URLæ¤œè¨¼
                try {
                    new URL(feedData.url);
                } catch (e) {
                    errors.push(`ç„¡åŠ¹ãªURL: ${feedData.url}`);
                    continue;
                }
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (existingUrls.includes(feedData.url.toLowerCase())) {
                    skipped++;
                    console.log(`é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${feedData.name}`);
                    continue;
                }
                
                const feed = {
                    name: feedData.name,
                    url: feedData.url,
                    category: feedData.category
                };
                
                // è¿½åŠ ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä¿å­˜
                if (feedData.description) feed.description = feedData.description;
                if (feedData.tags) feed.tags = feedData.tags;
                if (feedData.priority) feed.priority = feedData.priority;
                if (feedData.language) feed.language = feedData.language;
                
                try {
                    await addFeed(feed);
                    imported++;
                    existingUrls.push(feedData.url.toLowerCase());
                    console.log(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ: ${feedData.name}`);
                } catch (error) {
                    console.error('Import error for', feedData.name, ':', error);
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¨˜éŒ²
                    const errorMsg = error?.message || error?.toString() || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                    errors.push(`${feedData.name}: ${errorMsg}`);
                }
            }
            
            console.log(`çµæœ: æˆåŠŸ=${imported}, ã‚¹ã‚­ãƒƒãƒ—=${skipped}, ã‚¨ãƒ©ãƒ¼=${errors.length}`);
            return { imported, skipped, errors };
        }
        
        // CSVè¡Œã®ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€å¼•ç”¨ç¬¦å¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(s => s.replace(/^"|"$/g, ''));
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchImportTab(tab) {
            currentImportTab = tab;
            
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.import-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('textImportPanel').classList.toggle('active', tab === 'text');
            document.getElementById('fileImportPanel').classList.toggle('active', tab === 'file');
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                fileContent = '';
                return;
            }
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.textContent = `é¸æŠ: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', file.name, file.type, file.size);
            
            try {
                fileContent = await readFile(file);
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ, ã‚µã‚¤ã‚º:', fileContent.length);
                showFilePreview(fileContent);
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                fileContent = '';
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        async function showFilePreview(content) {
            const previewContainer = document.getElementById('filePreview');
            const preview = document.getElementById('fileImportPreview');
            
            if (!content.trim()) {
                previewContainer.style.display = 'none';
                return;
            }
            
            const lines = content.trim().split('\n').slice(0, 10); // æœ€åˆã®10è¡Œã‚’è¡¨ç¤º
            const existingFeeds = await getAllFeeds();
            const existingUrls = existingFeeds.map(f => f.url.toLowerCase());
            
            let previewHtml = '';
            let validCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;
            
            // JSONå½¢å¼ã®å ´åˆã®å‡¦ç†
            if (isJsonFormat(content)) {
                try {
                    const jsonData = JSON.parse(content);
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰é…åˆ—ã‚’ä½œæˆï¼ˆå®Ÿéš›ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ã—ãªã„ï¼‰
                    const feedsToShow = [];
                    let allFeeds = [];
                    
                    // v4å½¢å¼ã®JSONæ§‹é€ ã‚’è§£æ
                    if (jsonData.feeds && Array.isArray(jsonData.feeds)) {
                        for (const categoryGroup of jsonData.feeds) {
                            const category = categoryGroup.category || 'ãã®ä»–';
                            if (categoryGroup.feeds && Array.isArray(categoryGroup.feeds)) {
                                for (const feed of categoryGroup.feeds) {
                                    allFeeds.push({
                                        name: feed.name || feed.title || 'ç„¡é¡Œ',
                                        url: feed.url || feed.link || '',
                                        category: category
                                    });
                                }
                            }
                        }
                    }
                    // ãƒ•ãƒ©ãƒƒãƒˆé…åˆ—å½¢å¼
                    else if (Array.isArray(jsonData)) {
                        allFeeds = jsonData.map(feed => ({
                            name: feed.name || feed.title || 'ç„¡é¡Œ',
                            url: feed.url || feed.link || '',
                            category: feed.category || 'ãã®ä»–'
                        }));
                    }
                    // å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼
                    else if (jsonData.name && jsonData.url) {
                        allFeeds = [{
                            name: jsonData.name,
                            url: jsonData.url,
                            category: jsonData.category || 'ãã®ä»–'
                        }];
                    }
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
                    for (const feed of allFeeds) {
                        if (!feed.url) {
                            errorCount++;
                            continue;
                        }
                        
                        try {
                            new URL(feed.url);
                            if (existingUrls.includes(feed.url.toLowerCase())) {
                                duplicateCount++;
                            } else {
                                validCount++;
                            }
                        } catch (e) {
                            errorCount++;
                        }
                    }
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆæœ€åˆã®10ä»¶ï¼‰
                    for (const feed of allFeeds.slice(0, 10)) {
                        const url = feed.url;
                        let className = 'success';
                        let status = 'âœ… æ–°è¦';
                        
                        if (!url) {
                            className = 'error';
                            status = 'âŒ URLãªã—';
                        } else {
                            try {
                                new URL(url);
                                if (existingUrls.includes(url.toLowerCase())) {
                                    className = 'duplicate';
                                    status = 'âš ï¸ é‡è¤‡';
                                }
                            } catch (e) {
                                className = 'error';
                                status = 'âŒ ç„¡åŠ¹';
                            }
                        }
                        
                        previewHtml += `
                            <div class="import-preview-item ${className}">
                                ${status} | ${feed.name} | ${feed.category}
                            </div>
                        `;
                    }
                    
                    if (allFeeds.length > 10) {
                        previewHtml += `<div style="text-align: center; color: #666; margin-top: 10px;">... ä»– ${allFeeds.length - 10} ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ‰</div>`;
                    }
                    
                } catch (e) {
                    previewHtml += `
                        <div class="import-preview-item error">
                            âŒ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}
                        </div>
                    `;
                    errorCount++;
                }
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®å‡¦ç†
                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    let parts;
                    if (line.includes('\t')) {
                        parts = line.split('\t');
                    } else if (line.includes(',') && !line.includes('|')) {
                        parts = parseCSVLine(line);
                    } else {
                        parts = line.split('|');
                    }
                    
                    if (parts.length >= 2) {
                    const url = parts[1].trim();
                    let className = 'success';
                    let status = 'âœ… æ–°è¦';
                    
                    try {
                        new URL(url);
                        if (existingUrls.includes(url.toLowerCase())) {
                            className = 'duplicate';
                            status = 'âš ï¸ é‡è¤‡';
                            duplicateCount++;
                        } else {
                            validCount++;
                        }
                    } catch (e) {
                        className = 'error';
                        status = 'âŒ ç„¡åŠ¹';
                        errorCount++;
                    }
                    
                    previewHtml += `
                        <div class="import-preview-item ${className}">
                            ${status} | ${parts[0].trim()} | ${url}
                        </div>
                    `;
                    } else {
                        previewHtml += `
                            <div class="import-preview-item error">
                                âŒ ç„¡åŠ¹ãªå½¢å¼: ${line.substring(0, 50)}...
                            </div>
                        `;
                        errorCount++;
                    }
                }
            }
            
            const totalLines = content.trim().split('\n').length;
            if (totalLines > 10) {
                previewHtml += `<div style="text-align: center; color: #666; margin-top: 10px;">... ä»– ${totalLines - 10} è¡Œ</div>`;
            }
            
            previewHtml = `
                <div style="margin-bottom: 10px; font-weight: bold;">
                    âœ… æ–°è¦: ${validCount} | âš ï¸ é‡è¤‡: ${duplicateCount} | âŒ ã‚¨ãƒ©ãƒ¼: ${errorCount}
                </div>
                ${previewHtml}
            `;
            
            preview.innerHTML = previewHtml;
            previewContainer.style.display = 'block';
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function showExportOptions() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="exportWithStatus" checked>
                            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’å«ã‚ã‚‹
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="exportOnlyActive">
                            æ­£å¸¸ãªãƒ•ã‚£ãƒ¼ãƒ‰ã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="exportWithErrors" checked>
                            ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’å«ã‚ã‚‹
                        </label>
                    </div>
                    <div style="text-align: right;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-success" onclick="exportFeeds()" style="margin-left: 10px;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
        async function exportFeeds() {
            const feeds = await getAllFeeds();
            const withStatus = document.getElementById('exportWithStatus')?.checked ?? true;
            const onlyActive = document.getElementById('exportOnlyActive')?.checked ?? false;
            const withErrors = document.getElementById('exportWithErrors')?.checked ?? true;
            
            let filteredFeeds = feeds;
            if (onlyActive) {
                filteredFeeds = feeds.filter(f => f.active && !f.fetchError);
            }
            
            let exportData = '';
            
            if (withStatus || withErrors) {
                // è©³ç´°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆJSONï¼‰
                const exportObj = {
                    exportDate: new Date().toISOString(),
                    totalCount: filteredFeeds.length,
                    feeds: filteredFeeds.map(f => {
                        const feedData = {
                            name: f.name,
                            url: f.url,
                            category: f.category || ''
                        };
                        
                        if (withStatus) {
                            feedData.active = f.active;
                            feedData.lastUpdate = f.lastUpdate;
                            feedData.lastChecked = f.lastChecked || null;
                        }
                        
                        if (withErrors && f.fetchError) {
                            feedData.error = {
                                hasError: true,
                                message: f.lastError || 'ã‚¨ãƒ©ãƒ¼è©³ç´°ãªã—',
                                errorCode: f.lastErrorCode || 'UNKNOWN'
                            };
                        }
                        
                        return feedData;
                    })
                };
                exportData = JSON.stringify(exportObj, null, 2);
                
                const blob = new Blob([exportData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rss-feeds-detailed-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // ã‚·ãƒ³ãƒ—ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
                exportData = filteredFeeds.map(f => `${f.name}|${f.url}|${f.category || ''}`).join('\n');
                
                const blob = new Blob([exportData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rss-feeds-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.querySelector('.modal.active')?.remove();
            
            showToast(`${filteredFeeds.length}ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
        }

        // AI RSSæ¢ç´¢æ©Ÿèƒ½
        function showAIRSSFinder() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>ğŸ¤– AI RSSæ¢ç´¢</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <p style="margin-bottom: 15px;">æ¢ã—ãŸã„ã‚µã‚¤ãƒˆã‚„ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
                        <textarea id="aiSearchQuery" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                  placeholder="ä¾‹ï¼š\nãƒ»æ—¥æœ¬ã®AIé–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µã‚¤ãƒˆ\nãƒ»é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æœ€æ–°æƒ…å ±\nãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ä¼æ¥­ã®ãƒ–ãƒ­ã‚°\nãƒ»ç‰¹å®šã®ã‚µã‚¤ãƒˆåï¼ˆTechCrunch Japan ãªã©ï¼‰"></textarea>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong>
                            <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: #666;">
                                <li>å…·ä½“çš„ãªã‚µã‚¤ãƒˆåã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®ã‚µã‚¤ãƒˆã®RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‚’æ¢ã—ã¾ã™</li>
                                <li>ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é–¢é€£ã™ã‚‹ã‚µã‚¤ãƒˆã®RSSã‚’ææ¡ˆã—ã¾ã™</li>
                                <li>è¤‡æ•°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã§ãã¾ã™</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="aiSearchResults" style="display: none; margin: 20px 0; max-height: 300px; overflow-y: auto;"></div>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">é–‰ã˜ã‚‹</button>
                        <button class="btn btn-primary" onclick="searchRSSWithAI()" style="margin-left: 10px;">ğŸ” æ¢ç´¢é–‹å§‹</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // AI RSSæ¢ç´¢å®Ÿè¡Œ
        async function searchRSSWithAI() {
            const query = document.getElementById('aiSearchQuery').value.trim();
            if (!query) {
                showToast('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            const resultsDiv = document.getElementById('aiSearchResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="searching-animation">
                        <div class="search-icon-animated">ğŸ”</div>
                        <div class="spinner"></div>
                    </div>
                    <div style="margin-top: 15px; color: #667eea;">
                        ã€Œ${query}ã€ã«é–¢é€£ã™ã‚‹RSSã‚’æ¢ã—ã¦ã„ã¾ã™...
                    </div>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰æ¤œç´¢å®Ÿè¡Œ
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // ã‚ˆãçŸ¥ã‚‰ã‚ŒãŸRSSãƒ•ã‚£ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯å¤–éƒ¨APIã‚’ä½¿ç”¨ï¼‰
            const knownFeeds = {
                'techcrunch': ['https://jp.techcrunch.com/feed/', 'TechCrunch Japan', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'gigazine': ['https://gigazine.net/news/rss_2.0/', 'GIGAZINE', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'itmedia': ['https://rss.itmedia.co.jp/rss/2.0/aiplus.xml', 'ITmedia AI+', 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’'],
                'zdnet': ['https://japan.zdnet.com/rss/index.rdf', 'ZDNet Japan', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'cnet': ['https://japan.cnet.com/rss/index.rdf', 'CNET Japan', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'publickey': ['https://www.publickey1.jp/atom.xml', 'Publickey', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'gihyo': ['https://gihyo.jp/feed/rss2', 'æŠ€è¡“è©•è«–ç¤¾', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'atmarkit': ['https://rss.itmedia.co.jp/rss/2.0/ait.xml', '@IT', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'wired': ['https://wired.jp/rssfeeder/', 'WIRED.jp', 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼'],
                'engadget': ['https://japanese.engadget.com/rss.xml', 'Engadget æ—¥æœ¬ç‰ˆ', 'ã‚¬ã‚¸ã‚§ãƒƒãƒˆ'],
                'lifehacker': ['https://www.lifehacker.jp/index.xml', 'ãƒ©ã‚¤ãƒ•ãƒãƒƒã‚«ãƒ¼', 'ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«'],
                'business': ['https://www.businessinsider.jp/feed/index.xml', 'Business Insider Japan', 'ãƒ“ã‚¸ãƒã‚¹'],
                'newspicks': ['https://newspicks.com/feed', 'NewsPicks', 'ãƒ“ã‚¸ãƒã‚¹'],
                'çµŒç”£çœ': ['https://www.meti.go.jp/news/news_rss.xml', 'çµŒæ¸ˆç”£æ¥­çœ', 'å®˜å…¬åº'],
                'ç·å‹™çœ': ['https://www.soumu.go.jp/news/news_rss.xml', 'ç·å‹™çœ', 'å®˜å…¬åº'],
                'ai': ['https://ledge.ai/rss/', 'Ledge.ai', 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’'],
                'quantum': ['https://quantum.fixstars.com/feed/', 'Fixstars Quantum', 'é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿'],
                'startup': ['https://jp.startupdb.news/rss', 'STARTUP DB NEWS', 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—']
            };
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
            const queryLower = query.toLowerCase();
            const matches = [];
            
            for (const [key, value] of Object.entries(knownFeeds)) {
                if (queryLower.includes(key) || 
                    value[1].toLowerCase().includes(queryLower) ||
                    value[2].includes(query) ||
                    (query.includes('AI') && value[2].includes('AI')) ||
                    (query.includes('é‡å­') && key.includes('quantum')) ||
                    (query.includes('ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—') && value[2].includes('ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—'))) {
                    matches.push(value);
                }
            }
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ™ãƒ¼ã‚¹ã®æ¨è–¦
            if (query.includes('ãƒ‹ãƒ¥ãƒ¼ã‚¹') || query.includes('news')) {
                matches.push(
                    ['https://news.yahoo.co.jp/rss/topics/it.xml', 'Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹ IT', 'ãƒ‹ãƒ¥ãƒ¼ã‚¹'],
                    ['https://www3.nhk.or.jp/rss/news/cat7.xml', 'NHK ç§‘å­¦ãƒ»IT', 'ãƒ‹ãƒ¥ãƒ¼ã‚¹']
                );
            }
            
            if (query.includes('ãƒ–ãƒ­ã‚°') || query.includes('blog')) {
                matches.push(
                    ['https://blog.google/rss/', 'Google Blog', 'ãƒ–ãƒ­ã‚°'],
                    ['https://aws.amazon.com/jp/blogs/news/feed/', 'AWS News Blog', 'ã‚¯ãƒ©ã‚¦ãƒ‰']
                );
            }
            
            // çµæœè¡¨ç¤º
            if (matches.length > 0) {
                let html = `
                    <h3 style="margin-bottom: 15px;">ğŸ¯ è¦‹ã¤ã‹ã£ãŸRSSãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆ${matches.length}ä»¶ï¼‰</h3>
                    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                `;
                
                for (const [url, name, category] of matches) {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${name}</strong> 
                                <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-left: 10px;">${category}</span>
                                <div style="color: #666; font-size: 0.85em; margin-top: 5px;">${url}</div>
                            </div>
                            <button class="btn btn-small btn-primary" onclick="addAISuggestedFeed('${name}', '${url}', '${category}')">è¿½åŠ </button>
                        </div>
                    `;
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸ˜”</div>
                        <div>è©²å½“ã™ã‚‹RSSãƒ•ã‚£ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„</div>
                    </div>
                `;
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ä»£æ›¿RSSæ¢ç´¢
        async function findAlternativeRSS(feedId, feedName) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>ğŸ¤– ä»£æ›¿RSSæ¢ç´¢</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <p style="margin-bottom: 15px;">
                            <strong>${feedName}</strong> ã®RSSãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚<br>
                            ä»£æ›¿ã®RSS URLã‚’æ¢ã—ã¦ã„ã¾ã™...
                        </p>
                        <div id="alternativeResults" style="text-align: center; padding: 20px;">
                            <div class="searching-animation">
                                <div class="search-icon-animated">ğŸ”</div>
                                <div class="spinner"></div>
                                <div class="dots-container">
                                    <div class="pulse-dot"></div>
                                    <div class="pulse-dot"></div>
                                    <div class="pulse-dot"></div>
                                </div>
                            </div>
                            <div class="search-status">
                                <div id="searchStatusText">ä»£æ›¿RSSã‚’æ¢ç´¢ä¸­...</div>
                                <div class="search-progress">
                                    <div class="search-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // é…å»¶å®Ÿè¡Œã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«æ¢ç´¢é–‹å§‹
            setTimeout(() => searchAlternativeFeeds(feedId, feedName), 100);
        }
        
        // ä»£æ›¿RSSã®æ¢ç´¢å®Ÿè¡Œ
        async function searchAlternativeFeeds(feedId, feedName) {
            const resultsDiv = document.getElementById('alternativeResults');
            const statusText = document.getElementById('searchStatusText');
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
            const updateStatus = (message) => {
                if (statusText) {
                    statusText.textContent = message;
                }
            };
            
            // ç¾åœ¨ã®ãƒ•ã‚£ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—
            const feeds = await getAllFeeds();
            const currentFeed = feeds.find(f => f.id === feedId);
            const currentUrl = currentFeed ? currentFeed.url : '';
            
            // URLã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠ½å‡º
            let domain = '';
            try {
                const urlObj = new URL(currentUrl);
                domain = urlObj.hostname;
            } catch (e) {
                // URLãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ•ã‚£ãƒ¼ãƒ‰åã‹ã‚‰æ¨æ¸¬
            }
            
            // ã‚µã‚¤ãƒˆåã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            const keywords = feedName.toLowerCase()
                .replace(/æ—¥æœ¬ç‰ˆ|æ—¥æœ¬|japan|jp/gi, '')
                .replace(/rss|feed|news|ãƒ‹ãƒ¥ãƒ¼ã‚¹/gi, '')
                .trim();
            
            // ä»£æ›¿å€™è£œã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            const alternativePatterns = {
                // ã‚µã‚¤ãƒˆåã‹ã‚‰ä¸€èˆ¬çš„ãªRSS URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
                'techcrunch': [
                    'https://jp.techcrunch.com/feed/',
                    'https://techcrunch.com/feed/',
                    'https://jp.techcrunch.com/rss',
                    'https://techcrunch.com/category/artificial-intelligence/feed/'
                ],
                'gigazine': [
                    'https://gigazine.net/news/rss_2.0/',
                    'https://gigazine.net/news/rss_1.0/',
                    'https://gigazine.net/feed/'
                ],
                'itmedia': [
                    'https://rss.itmedia.co.jp/rss/2.0/aiplus.xml',
                    'https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml',
                    'https://rss.itmedia.co.jp/rss/2.0/it.xml',
                    'https://www.itmedia.co.jp/rss/index.html'
                ],
                'zdnet': [
                    'https://japan.zdnet.com/rss/index.rdf',
                    'https://japan.zdnet.com/rss/news/index.rdf',
                    'https://feeds.japan.zdnet.com/rss/zdnet/all.rdf'
                ],
                'cnet': [
                    'https://japan.cnet.com/rss/index.rdf',
                    'https://feeds.japan.cnet.com/rss/cnet/all.rdf',
                    'https://japan.cnet.com/rss/'
                ],
                'wired': [
                    'https://wired.jp/rssfeeder/',
                    'https://wired.jp/feed/',
                    'https://www.wired.jp/rss/index.xml'
                ],
                'engadget': [
                    'https://japanese.engadget.com/rss.xml',
                    'https://www.engadget.com/rss.xml',
                    'https://japanese.engadget.com/feed/'
                ],
                'note': [
                    'https://note.com/api/v2/rss',
                    'https://note.mu/rss'
                ],
                'qiita': [
                    'https://qiita.com/popular-items/feed',
                    'https://qiita.com/tags/ai/feed',
                    'https://qiita.com/tags/machinelearning/feed'
                ],
                'zenn': [
                    'https://zenn.dev/feed',
                    'https://zenn.dev/topics/ai/feed',
                    'https://zenn.dev/topics/machinelearning/feed'
                ]
            };
            
            // ãƒãƒƒãƒã™ã‚‹ä»£æ›¿å€™è£œã‚’æ¢ã™
            let alternatives = [];
            let matched = false;
            
            for (const [key, urls] of Object.entries(alternativePatterns)) {
                if (keywords.includes(key) || feedName.toLowerCase().includes(key)) {
                    matched = true;
                    // å„URLã‚’ãƒ†ã‚¹ãƒˆ
                    for (const url of urls) {
                        alternatives.push({
                            url: url,
                            name: `${feedName} (ä»£æ›¿${alternatives.length + 1})`,
                            status: 'testing'
                        });
                    }
                    break;
                }
            }
            
            // ãƒãƒƒãƒã—ãªã„å ´åˆã¯ä¸€èˆ¬çš„ãªURLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
            if (!matched) {
                // ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                if (domain) {
                    // ã‚ˆãä½¿ã‚ã‚Œã‚‹RSSãƒ‘ã‚¹
                    const commonPaths = [
                        '/feed/', '/feeds/', '/rss/', '/rss',
                        '/rss.xml', '/feed.xml', '/atom.xml', '/index.xml',
                        '/index.rdf', '/rss2.xml', '/rss1.xml',
                        '/blog/feed/', '/news/feed/', '/articles/feed/',
                        '/posts/feed/', '/feed/rss/', '/feed/atom/',
                        '/?feed=rss2', '/?feed=rss', '/?feed=atom',
                        '/api/rss', '/api/feed', '/api/v1/rss',
                        '/en/feed/', '/ja/feed/', '/jp/feed/',
                        '/feeds/all.atom.xml', '/feeds/news.xml'
                    ];
                    
                    for (const path of commonPaths) {
                        alternatives.push({
                            url: `https://${domain}${path}`,
                            name: `${domain}${path}`,
                            priority: path.includes('feed') || path.includes('rss') ? 1 : 2
                        });
                    }
                    
                    // ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚‚è©¦ã™
                    if (!domain.startsWith('www.')) {
                        alternatives.push(
                            { url: `https://www.${domain}/feed/`, name: `www.${domain}/feed/`, priority: 2 },
                            { url: `https://www.${domain}/rss/`, name: `www.${domain}/rss/`, priority: 2 }
                        );
                    }
                    
                    // è¨€èªåˆ¥ãƒ‘ã‚¹ã‚‚è©¦ã™ï¼ˆENISAãªã©å›½éš›æ©Ÿé–¢å‘ã‘ï¼‰
                    if (domain.includes('.eu') || domain.includes('.europa')) {
                        alternatives.push(
                            { url: `https://${domain}/rss-feeds`, name: `${domain}/rss-feeds`, priority: 1 },
                            { url: `https://${domain}/news/rss`, name: `${domain}/news/rss`, priority: 1 },
                            { url: `https://${domain}/media/news-items/RSS`, name: `${domain}/media/news-items/RSS`, priority: 2 }
                        );
                    }
                } else {
                    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒãªã„å ´åˆã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ¨æ¸¬
                    const possibleDomains = [
                        keywords.replace(/\s+/g, '') + '.com',
                        keywords.replace(/\s+/g, '') + '.jp',
                        keywords.replace(/\s+/g, '') + '.net',
                        keywords.replace(/\s+/g, '') + '.org',
                        keywords.replace(/\s+/g, '') + '.io'
                    ];
                    
                    for (const d of possibleDomains.slice(0, 2)) { // æœ€åˆã®2ã¤ã ã‘è©¦ã™
                        alternatives.push(
                            { url: `https://${d}/feed/`, name: `${d}/feed/`, priority: 3 },
                            { url: `https://${d}/rss/`, name: `${d}/rss/`, priority: 3 }
                        );
                    }
                }
                
                // å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆ
                alternatives.sort((a, b) => (a.priority || 999) - (b.priority || 999));
            }
            
            // çµæœè¡¨ç¤º
            if (alternatives.length > 0) {
                let html = `
                    <h3 style="margin-bottom: 15px;">ğŸ¯ ä»£æ›¿å€™è£œï¼ˆ${alternatives.length}ä»¶ï¼‰</h3>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                `;
                
                // å„URLã‚’ãƒ†ã‚¹ãƒˆ
                const totalTests = Math.min(alternatives.length, 10);
                let testedCount = 0;
                
                for (const alt of alternatives.slice(0, totalTests)) {
                    testedCount++;
                    updateStatus(`ãƒ†ã‚¹ãƒˆä¸­ (${testedCount}/${totalTests}): ${alt.name || alt.url}`);
                    
                    const testResult = await testFeedQuick(alt.url);
                    
                    if (testResult.success) {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #e8f5e9;">
                                <div>
                                    <div style="color: #2e7d32; font-weight: bold;">âœ… ${alt.name || alt.url}</div>
                                    <div style="color: #666; font-size: 0.85em; margin-top: 5px;">${alt.url}</div>
                                    <div style="color: #4caf50; font-size: 0.85em;">${testResult.message}</div>
                                </div>
                                <button class="btn btn-small btn-primary" onclick="replaceRSSUrl(${feedId}, '${alt.url}')"
                                        title="ã“ã®URLã«ç½®ãæ›ãˆ">
                                    ç½®ãæ›ãˆ
                                </button>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; opacity: 0.5;">
                                <div style="color: #999;">âŒ ${alt.name || alt.url}</div>
                                <div style="color: #999; font-size: 0.85em;">${testResult.message}</div>
                            </div>
                        `;
                    }
                }
                
                html += `
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong>
                        <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: #666;">
                            <li>ç·‘è‰²ã®å€™è£œã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹RSSãƒ•ã‚£ãƒ¼ãƒ‰ã§ã™</li>
                            <li>ã€Œç½®ãæ›ãˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ç¾åœ¨ã®URLã‚’æ–°ã—ã„URLã«æ›´æ–°ã—ã¾ã™</li>
                            <li>è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€æ‰‹å‹•ã§æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
            } else {
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¦çµæœè¡¨ç¤º
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px; animation: pulse 2s ease-in-out;">ğŸ˜”</div>
                        <div>ä»£æ›¿RSSãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            ã‚µã‚¤ãƒˆã®å…¬å¼ãƒšãƒ¼ã‚¸ã‹ã‚‰RSSãƒªãƒ³ã‚¯ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„
                        </div>
                    </div>
                `;
            }
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯RSSãƒ†ã‚¹ãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
        async function testFeedQuick(url) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                const workerUrl = 'https://polished-snow-477a.yutapii.workers.dev';
                const testUrl = `${workerUrl}?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(testUrl, {
                    mode: 'cors',
                    credentials: 'omit',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('<rss') || text.includes('<feed') || text.includes('<item>') || text.includes('<entry>')) {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(text, 'text/xml');
                        const items = xml.querySelectorAll('item, entry');
                        return {
                            success: true,
                            message: `${items.length}ä»¶ã®è¨˜äº‹ã‚’æ¤œå‡º`
                        };
                    }
                }
                
                return {
                    success: false,
                    message: `HTTP ${response.status}`
                };
            } catch (error) {
                return {
                    success: false,
                    message: error.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' : 'ã‚¨ãƒ©ãƒ¼'
                };
            }
        }
        
        // RSS URLã®ç½®ãæ›ãˆ
        async function replaceRSSUrl(feedId, newUrl) {
            if (!confirm(`RSS URLã‚’\n${newUrl}\nã«ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const feeds = await getAllFeeds();
                const feed = feeds.find(f => f.id === feedId);
                
                if (feed) {
                    feed.url = newUrl;
                    feed.fetchError = false;
                    feed.lastError = null;
                    feed.lastErrorCode = null;
                    feed.lastUpdate = new Date().toISOString();
                    
                    await updateFeed(feed);
                    
                    showToast('RSS URLã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ä¸€è¦§ã‚’æ›´æ–°
                    document.querySelector('.modal.active')?.remove();
                    await displayFeeds();
                }
            } catch (error) {
                showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }
        
        // AIææ¡ˆãƒ•ã‚£ãƒ¼ãƒ‰ã®è¿½åŠ 
        async function addAISuggestedFeed(name, url, category) {
            // æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã¨é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const existingFeeds = await getAllFeeds();
            if (existingFeeds.some(f => f.url === url)) {
                showToast('ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'warning');
                return;
            }
            
            const feed = {
                name: name,
                url: url,
                category: category
            };
            
            try {
                await addFeed(feed);
                showToast('ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ä¸€è¦§ã‚’æ›´æ–°
                document.querySelector('.modal.active')?.remove();
                await displayFeeds();
            } catch (error) {
                showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }
        
        // è‡ªå‹•ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        function showAutoTestModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        <h2>ğŸ”„ è‡ªå‹•ãƒ†ã‚¹ãƒˆè¨­å®š</h2>
                    </div>
                    <div style="margin: 20px 0;">
                        <h3 style="margin-bottom: 15px;">ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’é¸æŠï¼š</h3>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="all" checked>
                                <strong>å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰</strong> - ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ
                            </label>
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="active">
                                <strong>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿</strong> - æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ã®ã¿
                            </label>
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="error">
                                <strong>ã‚¨ãƒ©ãƒ¼ã®ã¿</strong> - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ã®ã¿
                            </label>
                            <label style="display: block; margin: 10px 0; cursor: pointer;">
                                <input type="radio" name="testTarget" value="category">
                                <strong>ã‚«ãƒ†ã‚´ãƒªåˆ¥</strong> - ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªã®ã¿
                                <select id="testCategory" style="margin-left: 10px; padding: 5px;">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼">ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼</option>
                                    <option value="ãƒ“ã‚¸ãƒã‚¹">ãƒ“ã‚¸ãƒã‚¹</option>
                                    <option value="AIãƒ»æ©Ÿæ¢°å­¦ç¿’">AIãƒ»æ©Ÿæ¢°å­¦ç¿’</option>
                                    <option value="ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—">ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—</option>
                                    <option value="å®˜å…¬åº">å®˜å…¬åº</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </label>
                        </div>
                        
                        <h3 style="margin: 20px 0 15px 0;">ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼š</h3>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="autoFix" checked>
                            <strong>ã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•ä¿®æ­£</strong> - ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ä»£æ›¿RSSã‚’è‡ªå‹•æ¢ç´¢
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="stopOnError">
                            <strong>ã‚¨ãƒ©ãƒ¼ã§åœæ­¢</strong> - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰ãƒ†ã‚¹ãƒˆã‚’ä¸­æ–­
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="detailedLog" checked>
                            <strong>è©³ç´°ãƒ­ã‚°è¡¨ç¤º</strong> - ãƒ†ã‚¹ãƒˆçµæœã‚’è©³ç´°ã«è¡¨ç¤º
                        </label>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong>
                            <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: #666;">
                                <li>ãƒ†ã‚¹ãƒˆã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™</li>
                                <li>ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®æ­£ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ä»£æ›¿RSSãŒè¦‹ã¤ã‹ã£ãŸå ´åˆè‡ªå‹•çš„ã«URLã‚’æ›´æ–°ã—ã¾ã™</li>
                                <li>ãƒ†ã‚¹ãƒˆä¸­ã§ã‚‚ä»–ã®æ“ä½œã¯å¯èƒ½ã§ã™</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="autoTestProgress" style="display: none; margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <h3 style="margin-bottom: 10px;">ğŸ¯ ãƒ†ã‚¹ãƒˆé€²è¡Œä¸­...</h3>
                        <div class="search-progress">
                            <div id="testProgressBar" class="search-progress-bar" style="width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div id="testStatusText" style="margin-top: 10px; font-size: 0.9em;"></div>
                        <div id="testResults" style="margin-top: 15px; max-height: 200px; overflow-y: auto; font-size: 0.85em;"></div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">é–‰ã˜ã‚‹</button>
                        <button id="startTestBtn" class="btn btn-success" onclick="startAutoTest()" style="margin-left: 10px;">
                            ğŸš€ ãƒ†ã‚¹ãƒˆé–‹å§‹
                        </button>
                        <button id="stopTestBtn" class="btn btn-danger" onclick="stopAutoTest()" style="margin-left: 10px; display: none;">
                            â¹ï¸ ä¸­æ­¢
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        let autoTestRunning = false;
        let autoTestAborted = false;
        
        // è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹
        async function startAutoTest() {
            if (autoTestRunning) return;
            
            autoTestRunning = true;
            autoTestAborted = false;
            
            // UIæ›´æ–°
            document.getElementById('startTestBtn').style.display = 'none';
            document.getElementById('stopTestBtn').style.display = 'inline-block';
            document.getElementById('autoTestProgress').style.display = 'block';
            
            // è¨­å®šå–å¾—
            const testTarget = document.querySelector('input[name="testTarget"]:checked').value;
            const autoFix = document.getElementById('autoFix').checked;
            const stopOnError = document.getElementById('stopOnError').checked;
            const detailedLog = document.getElementById('detailedLog').checked;
            const testCategory = document.getElementById('testCategory').value;
            
            // ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å–å¾—
            let feeds = await getAllFeeds();
            let testFeeds = [];
            
            switch(testTarget) {
                case 'all':
                    testFeeds = feeds;
                    break;
                case 'active':
                    testFeeds = feeds.filter(f => f.active);
                    break;
                case 'error':
                    testFeeds = feeds.filter(f => f.fetchError);
                    break;
                case 'category':
                    if (testCategory) {
                        testFeeds = feeds.filter(f => f.category === testCategory);
                    }
                    break;
            }
            
            if (testFeeds.length === 0) {
                showToast('ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                autoTestRunning = false;
                document.getElementById('startTestBtn').style.display = 'inline-block';
                document.getElementById('stopTestBtn').style.display = 'none';
                return;
            }
            
            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            const progressBar = document.getElementById('testProgressBar');
            const statusText = document.getElementById('testStatusText');
            const resultsDiv = document.getElementById('testResults');
            
            let successCount = 0;
            let errorCount = 0;
            let fixedCount = 0;
            let results = [];
            
            statusText.textContent = `ãƒ†ã‚¹ãƒˆä¸­... (0/${testFeeds.length})`;
            resultsDiv.innerHTML = '';
            
            for (let i = 0; i < testFeeds.length; i++) {
                if (autoTestAborted) {
                    statusText.textContent = 'ãƒ†ã‚¹ãƒˆãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ';
                    break;
                }
                
                const feed = testFeeds[i];
                const progress = ((i + 1) / testFeeds.length) * 100;
                progressBar.style.width = progress + '%';
                statusText.textContent = `ãƒ†ã‚¹ãƒˆä¸­... (${i + 1}/${testFeeds.length}) - ${feed.name}`;
                
                // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                const result = await testFeed(feed.url, feed.id);
                
                if (result.success) {
                    successCount++;
                    if (detailedLog) {
                        resultsDiv.innerHTML += `<div style="color: green;">âœ… ${feed.name}: ${result.message}</div>`;
                    }
                } else {
                    errorCount++;
                    if (detailedLog) {
                        resultsDiv.innerHTML += `<div style="color: red;">âŒ ${feed.name}: ${result.message}</div>`;
                    }
                    
                    // è‡ªå‹•ä¿®æ­£
                    if (autoFix && (result.errorCode === 'HTML_CONTENT' || result.errorCode === 'INVALID_FEED')) {
                        statusText.textContent = `${feed.name} ã®ä»£æ›¿RSSã‚’æ¢ç´¢ä¸­...`;
                        
                        // ä»£æ›¿RSSã‚’æ¢ã™
                        const alternatives = await searchAlternativesQuietly(feed);
                        if (alternatives.length > 0) {
                            // æœ€åˆã®æœ‰åŠ¹ãªä»£æ›¿ã‚’ä½¿ç”¨
                            const newUrl = alternatives[0].url;
                            feed.url = newUrl;
                            feed.fetchError = false;
                            feed.lastError = null;
                            await updateFeed(feed);
                            fixedCount++;
                            
                            if (detailedLog) {
                                resultsDiv.innerHTML += `<div style="color: blue;">ğŸ”§ ${feed.name}: URLã‚’è‡ªå‹•ä¿®æ­£ã—ã¾ã—ãŸ</div>`;
                            }
                        }
                    }
                    
                    // ã‚¨ãƒ©ãƒ¼ã§åœæ­¢
                    if (stopOnError) {
                        statusText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ãƒ†ã‚¹ãƒˆã‚’åœæ­¢ã—ã¾ã—ãŸ';
                        break;
                    }
                }
                
                // å°‘ã—å¾…æ©Ÿï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ï¼‰
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // å®Œäº†
            progressBar.style.width = '100%';
            statusText.innerHTML = `
                <strong>ãƒ†ã‚¹ãƒˆå®Œäº†ï¼</strong><br>
                âœ… æˆåŠŸ: ${successCount} | âŒ ã‚¨ãƒ©ãƒ¼: ${errorCount} | ğŸ”§ è‡ªå‹•ä¿®æ­£: ${fixedCount}
            `;
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ä¸€è¦§ã‚’æ›´æ–°
            await displayFeeds();
            
            // UIãƒªã‚»ãƒƒãƒˆ
            autoTestRunning = false;
            document.getElementById('startTestBtn').style.display = 'inline-block';
            document.getElementById('stopTestBtn').style.display = 'none';
        }
        
        // è‡ªå‹•ãƒ†ã‚¹ãƒˆä¸­æ­¢
        function stopAutoTest() {
            autoTestAborted = true;
            autoTestRunning = false;
            document.getElementById('startTestBtn').style.display = 'inline-block';
            document.getElementById('stopTestBtn').style.display = 'none';
        }
        
        // é™ã‹ã«ä»£æ›¿RSSã‚’æ¢ã™ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ãªã„ï¼‰
        async function searchAlternativesQuietly(feed) {
            const currentUrl = feed.url;
            let domain = '';
            try {
                const urlObj = new URL(currentUrl);
                domain = urlObj.hostname;
            } catch (e) {
                return [];
            }
            
            if (!domain) return [];
            
            // ä¸€èˆ¬çš„ãªRSSãƒ‘ã‚¹ã‚’è©¦ã™
            const commonPaths = [
                '/feed/', '/rss/', '/rss.xml', '/feed.xml', 
                '/atom.xml', '/index.xml', '/index.rdf'
            ];
            
            const alternatives = [];
            for (const path of commonPaths) {
                const testUrl = `https://${domain}${path}`;
                const result = await testFeedQuick(testUrl);
                if (result.success) {
                    alternatives.push({ url: testUrl, success: true });
                }
            }
            
            return alternatives;
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded: åˆæœŸåŒ–é–‹å§‹');
            
            try {
                await initDB();
                console.log('åˆæœŸDBåˆæœŸåŒ–å®Œäº†');
            } catch (e) {
                console.error('åˆæœŸDBåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            await displayFeeds();
            
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›ã®ã¿ï¼‰
            const feeds = await getAllFeeds();
            if (feeds.length === 0) {
                const samples = [
                    { name: 'TechCrunch Japan', url: 'https://jp.techcrunch.com/feed/', category: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼' },
                    { name: 'GIGAZINE', url: 'https://gigazine.net/news/rss_2.0/', category: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼' },
                    { name: 'ITmedia AI+', url: 'https://rss.itmedia.co.jp/rss/2.0/aiplus.xml', category: 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’' }
                ];
                
                for (const sample of samples) {
                    await addFeed(sample);
                }
                displayFeeds();
            }
            
            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const importBtn = document.getElementById('importBtn');
            if (importBtn) {
                importBtn.addEventListener('click', async function() {
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    await performImport();
                });
            } else {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ‰ã®å½¢å¼ã‚’éåŒæœŸã§æ›´æ–°
            setTimeout(async () => {
                const feeds = await getAllFeeds();
                let updatedCount = 0;
                
                for (const feed of feeds) {
                    if (!feed.feedFormat && !feed.fetchError) {
                        try {
                            const response = await fetch(`https://polished-snow-477a.yutapii.workers.dev?url=${encodeURIComponent(feed.url)}`);
                            if (response.ok) {
                                const text = await response.text();
                                const feedFormat = detectFeedFormat(text);
                                
                                if (feedFormat !== 'Unknown') {
                                    // DBã‚’æ›´æ–°
                                    if (db) {
                                        const transaction = db.transaction(['feeds'], 'readwrite');
                                        const store = transaction.objectStore('feeds');
                                        feed.feedFormat = feedFormat;
                                        store.put(feed);
                                        updatedCount++;
                                    }
                                }
                            }
                        } catch (error) {
                            console.log(`ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼ã®æ¤œå‡ºã‚¨ãƒ©ãƒ¼ (${feed.name}):`, error);
                        }
                    }
                }
                
                if (updatedCount > 0) {
                    console.log(`${updatedCount}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ‰å½¢å¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
                    displayFeeds();
                }
            }, 2000);
        });
    </script>
</body>
</html>