<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #0f0;
        }
        pre {
            background: #000;
            padding: 10px;
            border: 1px solid #0f0;
            overflow: auto;
            max-height: 500px;
        }
        button {
            background: #0f0;
            color: #000;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .error {
            color: #f00;
        }
        .info {
            color: #ff0;
        }
    </style>
</head>
<body>
    <h1>IndexedDB ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ« - SCF V5</h1>
    <div>
        <button onclick="checkDB()">DBã‚’ãƒã‚§ãƒƒã‚¯</button>
        <button onclick="countArticles()">è¨˜äº‹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ</button>
        <button onclick="showArticles()">è¨˜äº‹ã‚’è¡¨ç¤ºï¼ˆæœ€åˆã®10ä»¶ï¼‰</button>
        <button onclick="showFeeds()">ãƒ•ã‚£ãƒ¼ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º</button>
        <button onclick="clearConsole()">ã‚¯ãƒªã‚¢</button>
    </div>
    <pre id="output"></pre>

    <script>
        const output = document.getElementById('output');
        
        function log(message, type = '') {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const className = type ? ` class="${type}"` : '';
            output.innerHTML += `<span${className}>[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearConsole() {
            output.innerHTML = '';
        }
        
        async function checkDB() {
            log('=== IndexedDB ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===', 'info');
            
            try {
                // DBã‚’é–‹ã
                const request = indexedDB.open('SCF_V5_DB', 1);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log(`âœ… DBæ¥ç¶šæˆåŠŸ: ${db.name} (Version: ${db.version})`);
                    
                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ä¸€è¦§
                    const storeNames = Array.from(db.objectStoreNames);
                    log(`ğŸ“¦ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢: ${storeNames.join(', ')}`);
                    
                    // å„ã‚¹ãƒˆã‚¢ã®è©³ç´°ã‚’ãƒã‚§ãƒƒã‚¯
                    storeNames.forEach(storeName => {
                        const transaction = db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        
                        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§
                        const indexes = Array.from(store.indexNames);
                        log(`  â””â”€ ${storeName}: indexes=[${indexes.join(', ')}]`);
                    });
                    
                    db.close();
                };
                
                request.onerror = () => {
                    log(`âŒ DBæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${request.error}`, 'error');
                };
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function countArticles() {
            log('=== è¨˜äº‹æ•°ã‚«ã‚¦ãƒ³ãƒˆ ===', 'info');
            
            const request = indexedDB.open('SCF_V5_DB', 1);
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('articles')) {
                    log('âŒ articlesãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    db.close();
                    return;
                }
                
                const transaction = db.transaction(['articles'], 'readonly');
                const store = transaction.objectStore('articles');
                const countRequest = store.count();
                
                countRequest.onsuccess = () => {
                    log(`ğŸ“Š è¨˜äº‹ç·æ•°: ${countRequest.result}ä»¶`);
                    
                    // feedIdåˆ¥ã«ã‚«ã‚¦ãƒ³ãƒˆ
                    const index = store.index('feedId');
                    const feedCounts = {};
                    
                    index.openCursor().onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            const feedId = cursor.value.feedId;
                            feedCounts[feedId] = (feedCounts[feedId] || 0) + 1;
                            cursor.continue();
                        } else {
                            // ã‚«ã‚¦ãƒ³ãƒˆçµæœã‚’è¡¨ç¤º
                            Object.entries(feedCounts).forEach(([feedId, count]) => {
                                log(`  Feed ID ${feedId}: ${count}ä»¶`);
                            });
                            db.close();
                        }
                    };
                };
            };
        }
        
        async function showArticles() {
            log('=== è¨˜äº‹è¡¨ç¤ºï¼ˆæœ€åˆã®10ä»¶ï¼‰ ===', 'info');
            
            const request = indexedDB.open('SCF_V5_DB', 1);
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('articles')) {
                    log('âŒ articlesãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    db.close();
                    return;
                }
                
                const transaction = db.transaction(['articles'], 'readonly');
                const store = transaction.objectStore('articles');
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = () => {
                    const articles = getAllRequest.result;
                    log(`å–å¾—ã—ãŸè¨˜äº‹æ•°: ${articles.length}ä»¶`);
                    
                    // æœ€åˆã®10ä»¶ã‚’è¡¨ç¤º
                    articles.slice(0, 10).forEach((article, index) => {
                        log(`\n--- è¨˜äº‹ ${index + 1} ---`);
                        log(`ID: ${article.id}`);
                        log(`ã‚¿ã‚¤ãƒˆãƒ«: ${article.title || 'ãªã—'}`);
                        log(`Feed ID: ${article.feedId}`);
                        log(`æ—¥ä»˜: ${article.pubDate || 'ãªã—'}`);
                        log(`URL: ${article.link || 'ãªã—'}`);
                        if (article.description) {
                            log(`èª¬æ˜: ${article.description.substring(0, 100)}...`);
                        }
                    });
                    
                    db.close();
                };
            };
        }
        
        async function showFeeds() {
            log('=== ãƒ•ã‚£ãƒ¼ãƒ‰ä¸€è¦§ ===', 'info');
            
            const request = indexedDB.open('SCF_V5_DB', 1);
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('feeds')) {
                    log('âŒ feedsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    db.close();
                    return;
                }
                
                const transaction = db.transaction(['feeds'], 'readonly');
                const store = transaction.objectStore('feeds');
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = () => {
                    const feeds = getAllRequest.result;
                    log(`ãƒ•ã‚£ãƒ¼ãƒ‰ç·æ•°: ${feeds.length}ä»¶`);
                    
                    feeds.forEach((feed, index) => {
                        log(`\n--- ãƒ•ã‚£ãƒ¼ãƒ‰ ${index + 1} ---`);
                        log(`ID: ${feed.id}`);
                        log(`åå‰: ${feed.name}`);
                        log(`URL: ${feed.url}`);
                        log(`ã‚«ãƒ†ã‚´ãƒª: ${feed.category || 'ãªã—'}`);
                        log(`ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${feed.active ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
                        log(`è¨˜äº‹æ•°: ${feed.lastArticleCount || 0}`);
                    });
                    
                    db.close();
                };
            };
        }
        
        // åˆæœŸãƒã‚§ãƒƒã‚¯
        window.onload = () => {
            log('IndexedDB ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«èµ·å‹•', 'info');
            checkDB();
        };
    </script>
</body>
</html>